{% extends "admin/base_site.html" %}
{% load static i18n %}

{% block title %}Sélectionner la date - Inventaire{% endblock %}

{% block extra_css %}
<style>
    .calendar-day {
        min-height: 80px;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 8px;
        margin: 2px;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .calendar-day.available {
        background: #d4edda;
    }
    
    .calendar-day.available:hover {
        background: #28a745;
        color: white;
        transform: scale(1.05);
    }
    
    .calendar-day.has-inventory {
        background: #d1ecf1;
    }
    
    .calendar-day.disabled {
        background: #f8f9fa;
        cursor: not-allowed;
        opacity: 0.5;
    }
    
    .calendar-day.future {
        background: #f8d7da;
        cursor: not-allowed;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h3><i class="fas fa-calendar"></i> Sélectionner une date pour l'inventaire</h3>
            <p class="mb-0">Poste: {{ poste.nom }}</p>
        </div>
        <div class="card-body">
            <!-- Sélecteur de mois -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <label>Mois à afficher:</label>
                    <input type="month" id="monthSelector" class="form-control" 
                           value="{{ current_month }}" max="{{ current_month }}">
                </div>
            </div>
            
            <!-- Calendrier -->
            <div id="calendarContainer"></div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const monthSelector = document.getElementById('monthSelector');
    const container = document.getElementById('calendarContainer');
    const posteId = {{ poste_id }};
    
    function loadMonth() {
        const [year, month] = monthSelector.value.split('-');
        
        // Charger les données du mois
        fetch(`/inventaire/api/month-data/?year=${year}&month=${month}&poste_id=${posteId}`)
            .then(response => response.json())
            .then(data => renderCalendar(year, month, data));
    }
    
    function renderCalendar(year, month, data) {
        const firstDay = new Date(year, month-1, 1);
        const lastDay = new Date(year, month, 0);
        const today = new Date();
        
        let html = '<div class="row">';
        
        // En-têtes des jours
        const days = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];
        days.forEach(day => {
            html += `<div class="col text-center font-weight-bold">${day}</div>`;
        });
        html += '</div><div class="row mt-2">';
        
        // Jours vides au début
        const startDay = firstDay.getDay() || 7;
        for (let i = 1; i < startDay; i++) {
            html += '<div class="col"></div>';
        }
        
        // Jours du mois
        for (let day = 1; day <= lastDay.getDate(); day++) {
            const date = new Date(year, month-1, day);
            const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const dayData = data[dateStr] || {};
            
            let className = 'calendar-day';
            let onclick = '';
            let content = `<div class="font-weight-bold">${day}</div>`;
            
            if (date > today) {
                className += ' future';
                content += '<small class="text-danger">Future</small>';
            } else if (dayData.has_inventory) {
                className += ' has-inventory';
                content += '<small class="text-info">Déjà saisi</small>';
                onclick = `window.location.href='/inventaire/${dayData.inventory_id}/'`;
            } else if (dayData.is_programmable) {
                className += ' available';
                content += '<small class="text-success">Disponible</small>';
                onclick = `selectDate('${dateStr}')`;
            } else {
                className += ' disabled';
                content += '<small class="text-muted">Non programmé</small>';
            }
            
            html += `<div class="col">
                        <div class="${className}" ${onclick ? `onclick="${onclick}"` : ''}>
                            ${content}
                        </div>
                     </div>`;
            
            // Nouvelle ligne après dimanche
            if (date.getDay() === 0) {
                html += '</div><div class="row mt-2">';
            }
        }
        
        html += '</div>';
        container.innerHTML = html;
    }
    
    window.selectDate = function(dateStr) {
        if (confirm(`Voulez-vous saisir l'inventaire du ${dateStr} ?`)) {
            window.location.href = `/inventaire/saisie/${posteId}/${dateStr}/`;
        }
    }
    
    monthSelector.addEventListener('change', loadMonth);
    loadMonth();
});
</script>
{% endblock %}