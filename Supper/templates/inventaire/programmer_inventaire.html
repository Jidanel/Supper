{% extends "admin/base_site.html" %}
{% load static i18n %}
{% load inventaire_extras %}

{% block title %}{% trans "Programmer Inventaire" %} - SUPPER{% endblock %}

{% block extra_css %}
<style>
    /* ============================================
       RÉINITIALISATION COMPLÈTE POUR MOBILE
       ============================================ */
    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    /* ============================================
       VARIABLES CSS
       ============================================ */
    :root {
        --primary-color: #6B46C1;
        --primary-dark: #553C9A;
        --danger-color: #dc2626;
        --warning-color: #d97706;
        --info-color: #2563eb;
        --success-color: #059669;
        --gris-moyen: #64748B;
        --gris-clair: #F8FAFC;
    }

    /* ============================================
       CONTENEUR PRINCIPAL - ANTI-DÉBORDEMENT
       ============================================ */
    .container-fluid {
        width: 100%;
        max-width: 100%;
        padding-left: 15px;
        padding-right: 15px;
        margin-left: auto;
        margin-right: auto;
        overflow-x: hidden;
    }

    .py-4 {
        padding-top: 1.5rem !important;
        padding-bottom: 1.5rem !important;
    }

    /* ============================================
       EN-TÊTE PAGE - RESPONSIVE
       ============================================ */
    h2 {
        font-size: 1.75rem;
        margin-bottom: 1rem;
        word-wrap: break-word;
        overflow-wrap: break-word;
        line-height: 1.3;
        color: #1e293b;
    }

    h2 i {
        margin-right: 0.5rem;
    }

    /* ============================================
       GRID BOOTSTRAP - RESPONSIVE
       ============================================ */
    .row {
        display: flex;
        flex-wrap: wrap;
        margin-left: -10px;
        margin-right: -10px;
        width: calc(100% + 20px);
    }

    .col-12, .col-md-3, .col-md-6 {
        padding-left: 10px;
        padding-right: 10px;
        width: 100%;
        max-width: 100%;
    }

    /* ============================================
       CARDS - RESPONSIVE
       ============================================ */
    .card {
        background: white;
        border-radius: 12px;
        border: none;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        margin-bottom: 1.5rem;
        width: 100%;
        overflow: hidden;
    }

    .card-header {
        padding: 1rem 1.25rem;
        border-bottom: none;
    }

    .card-header h5 {
        margin: 0;
        font-size: 1.1rem;
        font-weight: 600;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }

    .card-body {
        padding: 1.5rem;
        width: 100%;
    }

    /* ============================================
       MOTIF CARDS - RESPONSIVE GRID
       ============================================ */
    .motif-card {
        border: 2px solid #dee2e6;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        transition: all 0.3s ease;
        background: white;
        width: 100%;
        text-align: center;
    }

    .motif-card:hover {
        border-color: var(--primary-color);
        box-shadow: 0 4px 12px rgba(107, 70, 193, 0.15);
        transform: translateY(-2px);
    }

    .motif-card i.fa-3x {
        font-size: 2.5rem;
        margin-bottom: 1rem;
    }

    .motif-card h5 {
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }

    .motif-card p {
        font-size: 0.85rem;
        color: var(--gris-moyen);
        margin-bottom: 1rem;
    }

    /* ============================================
       POSTE ITEMS - RESPONSIVE
       ============================================ */
    .poste-item {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 0.75rem;
        width: 100%;
        transition: all 0.3s ease;
    }

    .poste-item:hover {
        border-color: var(--primary-color);
        box-shadow: 0 2px 8px rgba(107, 70, 193, 0.1);
    }

    .poste-item.disabled {
        opacity: 0.6;
        background: #f3f4f6;
    }

    .poste-item .form-check {
        display: flex;
        align-items: flex-start;
        gap: 0.75rem;
    }

    .poste-item .form-check-input {
        margin-top: 0.25rem;
        flex-shrink: 0;
        width: 1.25rem;
        height: 1.25rem;
    }

    .poste-item .form-check-label {
        flex: 1;
        min-width: 0;
        cursor: pointer;
    }

    .poste-item strong {
        word-wrap: break-word;
        overflow-wrap: break-word;
    }

    .poste-item small {
        font-size: 0.8rem;
        color: var(--gris-moyen);
        word-wrap: break-word;
        overflow-wrap: break-word;
        display: block;
        margin-top: 0.25rem;
    }

    /* ============================================
       FLEX LAYOUT POUR POSTE LABELS
       ============================================ */
    .d-flex {
        display: flex !important;
    }

    .justify-content-between {
        justify-content: space-between !important;
    }

    .flex-wrap {
        flex-wrap: wrap !important;
    }

    .align-items-start {
        align-items: flex-start !important;
    }

    /* ============================================
       INDICATOR BADGES - RESPONSIVE
       ============================================ */
    .indicator-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        white-space: nowrap;
        margin-bottom: 0.25rem;
    }

    .indicator-danger {
        background: #fee2e2;
        color: #dc2626;
    }

    .indicator-warning {
        background: #fef3c7;
        color: #d97706;
    }

    .indicator-success {
        background: #d1fae5;
        color: #065f46;
    }

    .indicator-info {
        background: #dbeafe;
        color: #2563eb;
    }

    /* ============================================
       BADGES GÉNÉRAUX
       ============================================ */
    .badge {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
        font-weight: 600;
        border-radius: 6px;
        white-space: nowrap;
    }

    .bg-info {
        background-color: var(--info-color) !important;
        color: white;
    }

    .bg-secondary {
        background-color: #6b7280 !important;
        color: white;
    }

    /* ============================================
       ALERTES - RESPONSIVE
       ============================================ */
    .alert {
        padding: 1rem 1.25rem;
        border-radius: 10px;
        margin-bottom: 1rem;
        width: 100%;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }

    .alert-success {
        background-color: #d1fae5;
        border: 1px solid #a7f3d0;
        color: #065f46;
    }

    .alert-warning {
        background-color: #fef3c7;
        border: 1px solid #fde68a;
        color: #92400e;
    }

    .alert-info {
        background-color: #dbeafe;
        border: 1px solid #bfdbfe;
        color: #1e40af;
    }

    .alert i {
        margin-right: 0.5rem;
    }

    .alert small {
        display: block;
        margin-top: 0.25rem;
        font-size: 0.85rem;
    }

    /* ============================================
       FORMULAIRES - RESPONSIVE
       ============================================ */
    .form-select {
        width: 100%;
        padding: 0.75rem 2.25rem 0.75rem 1rem;
        font-size: 1rem;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        background-color: #fff;
        transition: all 0.3s ease;
    }

    .form-select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(107, 70, 193, 0.15);
    }

    .form-select-lg {
        padding: 1rem 2.25rem 1rem 1rem;
        font-size: 1.1rem;
    }

    /* ============================================
       BOUTONS - RESPONSIVE
       ============================================ */
    .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        padding: 0.625rem 1.25rem;
        font-size: 0.9rem;
        font-weight: 500;
        border-radius: 8px;
        text-decoration: none;
        cursor: pointer;
        transition: all 0.3s ease;
        border: none;
        min-height: 44px;
        white-space: nowrap;
    }

    .btn-primary {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-dark) 100%);
        color: white;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(107, 70, 193, 0.4);
    }

    .btn-danger {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
    }

    .btn-warning {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: white;
    }

    .btn-info {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white;
    }

    .btn-success {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
    }

    .btn-secondary {
        background: #6b7280;
        color: white;
    }

    .btn-sm {
        padding: 0.375rem 0.75rem;
        font-size: 0.8rem;
        min-height: 36px;
    }

    .btn-lg {
        padding: 0.875rem 1.75rem;
        font-size: 1rem;
    }

    /* ============================================
       UTILITAIRES
       ============================================ */
    .mb-0 { margin-bottom: 0 !important; }
    .mb-2 { margin-bottom: 0.5rem !important; }
    .mb-3 { margin-bottom: 1rem !important; }
    .mb-4 { margin-bottom: 1.5rem !important; }
    .mt-1 { margin-top: 0.25rem !important; }
    .mt-2 { margin-top: 0.5rem !important; }
    .mt-3 { margin-top: 1rem !important; }
    .mt-4 { margin-top: 1.5rem !important; }
    .me-1 { margin-right: 0.25rem !important; }
    .me-2 { margin-right: 0.5rem !important; }
    .ms-2 { margin-left: 0.5rem !important; }
    .ms-4 { margin-left: 1.5rem !important; }
    .text-center { text-align: center !important; }
    .text-muted { color: var(--gris-moyen) !important; }
    .d-block { display: block !important; }

    hr {
        border: none;
        border-top: 1px solid #e5e7eb;
        margin: 1.5rem 0;
    }

    /* ============================================
       MEDIA QUERIES - VERSION PC (≥ 768px)
       ============================================ */
    @media (min-width: 768px) {
        .col-md-3 {
            flex: 0 0 25%;
            max-width: 25%;
        }

        .col-md-6 {
            flex: 0 0 50%;
            max-width: 50%;
        }

        .poste-item .form-check-label.d-flex {
            flex-wrap: nowrap;
            align-items: center;
        }
    }

    /* ============================================
       MEDIA QUERIES - MOBILE (≤ 767px)
       ============================================ */
    @media (max-width: 767px) {
        /* Correction du débordement horizontal */
        html, body {
            overflow-x: hidden !important;
            width: 100% !important;
            max-width: 100vw !important;
            position: relative !important;
        }

        .main-content {
            overflow-x: hidden !important;
            width: 100% !important;
            max-width: 100vw !important;
        }

        .content-wrapper {
            min-width: 100% !important;
            width: 100% !important;
            max-width: 100vw !important;
            padding: 1rem !important;
            overflow-x: hidden !important;
        }

        .container-fluid {
            padding-left: 12px !important;
            padding-right: 12px !important;
        }

        .py-4 {
            padding-top: 1rem !important;
            padding-bottom: 1rem !important;
        }

        /* En-tête */
        h2 {
            font-size: 1.35rem;
            margin-bottom: 1rem;
        }

        /* Row */
        .row {
            margin-left: -6px;
            margin-right: -6px;
            width: calc(100% + 12px);
        }

        .col-12, .col-md-3, .col-md-6 {
            padding-left: 6px;
            padding-right: 6px;
        }

        /* Cards */
        .card {
            margin-bottom: 1rem;
        }

        .card-header {
            padding: 0.875rem 1rem;
        }

        .card-header h5 {
            font-size: 1rem;
        }

        .card-body {
            padding: 1rem;
        }

        /* Motif cards - 2 colonnes sur mobile */
        .card-body > .row > .col-md-3 {
            flex: 0 0 50%;
            max-width: 50%;
            margin-bottom: 0.75rem;
        }

        .motif-card {
            padding: 1rem;
            margin-bottom: 0;
        }

        .motif-card i.fa-3x {
            font-size: 2rem;
            margin-bottom: 0.75rem;
        }

        .motif-card h5 {
            font-size: 0.9rem;
        }

        .motif-card p {
            font-size: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .motif-card .btn {
            width: 100%;
            font-size: 0.8rem;
            padding: 0.5rem 0.75rem;
        }

        /* Poste items */
        .poste-item {
            padding: 0.875rem;
            margin-bottom: 0.5rem;
        }

        .poste-item .form-check {
            flex-direction: column;
            align-items: flex-start;
        }

        .poste-item .form-check-label {
            width: 100%;
        }

        .poste-item .form-check-label.d-flex {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.5rem;
        }

        .poste-item strong {
            font-size: 0.9rem;
        }

        .poste-item small {
            font-size: 0.75rem;
        }

        /* Indicator badges */
        .indicator-badge {
            padding: 0.2rem 0.5rem;
            font-size: 0.7rem;
            margin-right: 0.25rem;
            margin-bottom: 0.25rem;
        }

        /* Alertes */
        .alert {
            padding: 0.875rem 1rem;
            font-size: 0.9rem;
        }

        .alert small {
            font-size: 0.8rem;
        }

        /* Formulaires */
        .form-select {
            font-size: 16px; /* Empêche zoom iOS */
            padding: 0.625rem 0.875rem;
        }

        .form-select-lg {
            padding: 0.75rem 1rem;
            font-size: 16px;
        }

        /* Boutons */
        .btn {
            font-size: 0.85rem;
            padding: 0.5rem 1rem;
        }

        .btn-sm {
            padding: 0.35rem 0.65rem;
            font-size: 0.75rem;
            min-height: 32px;
        }

        .btn-lg {
            padding: 0.75rem 1.5rem;
            font-size: 0.95rem;
            width: 100%;
        }

        /* Boutons select all/deselect */
        .mb-3 > .btn-sm {
            margin-bottom: 0.25rem;
        }

        /* Badges */
        .badge {
            font-size: 0.65rem;
            padding: 0.2rem 0.4rem;
        }

        /* Text center avec bouton */
        .text-center .btn-lg {
            max-width: 300px;
            margin: 0 auto;
        }
    }

    /* ============================================
       PETITS MOBILES (≤ 576px)
       ============================================ */
    @media (max-width: 576px) {
        .container-fluid {
            padding-left: 10px !important;
            padding-right: 10px !important;
        }

        h2 {
            font-size: 1.2rem;
        }

        /* Motif cards - 1 colonne sur très petit */
        .card-body > .row > .col-md-3 {
            flex: 0 0 100%;
            max-width: 100%;
        }

        .motif-card {
            padding: 1rem;
            margin-bottom: 0.75rem;
        }

        .card-header {
            padding: 0.75rem;
        }

        .card-header h5 {
            font-size: 0.95rem;
        }

        .card-body {
            padding: 0.875rem;
        }

        .poste-item {
            padding: 0.75rem;
        }

        .indicator-badge {
            font-size: 0.65rem;
            padding: 0.15rem 0.4rem;
        }
    }

    /* ============================================
       TRÈS PETITS ÉCRANS (< 375px)
       ============================================ */
    @media (max-width: 375px) {
        h2 {
            font-size: 1.1rem;
        }

        .motif-card h5 {
            font-size: 0.85rem;
        }

        .motif-card p {
            font-size: 0.7rem;
        }

        .motif-card i.fa-3x {
            font-size: 1.75rem;
        }

        .poste-item strong {
            font-size: 0.85rem;
        }

        .indicator-badge {
            font-size: 0.6rem;
        }

        .alert {
            font-size: 0.85rem;
        }
    }

    /* ============================================
       ORIENTATION PAYSAGE MOBILE
       ============================================ */
    @media (max-width: 896px) and (orientation: landscape) {
        /* Motif cards en ligne */
        .card-body > .row > .col-md-3 {
            flex: 0 0 25%;
            max-width: 25%;
        }

        .motif-card {
            padding: 0.875rem;
        }

        .motif-card i.fa-3x {
            font-size: 1.75rem;
            margin-bottom: 0.5rem;
        }

        .motif-card h5 {
            font-size: 0.85rem;
        }

        .motif-card p {
            font-size: 0.7rem;
            margin-bottom: 0.5rem;
        }

        .poste-item .form-check-label.d-flex {
            flex-direction: row;
            flex-wrap: wrap;
        }

        .text-center .btn-lg {
            width: auto;
            max-width: none;
        }
    }

    /* ============================================
       CORRECTION ZOOM iOS
       ============================================ */
    @media (max-width: 768px) {
        input, button, select, textarea {
            font-size: 16px !important;
        }
    }

    /* ============================================
       ACCESSIBILITÉ
       ============================================ */
    .form-select:focus,
    .form-check-input:focus,
    .btn:focus {
        outline: 2px solid var(--primary-color);
        outline-offset: 2px;
    }

    /* ============================================
       IMPRESSION
       ============================================ */
    @media print {
        .card {
            box-shadow: none !important;
            border: 1px solid #ddd !important;
        }

        .btn {
            display: none !important;
        }

        .poste-item {
            page-break-inside: avoid;
        }

        @page {
            margin: 1cm;
            size: A4;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- En-tête -->
    <div class="row mb-4">
        <div class="col-12">
            <h2 class="mb-3">
                <i class="fas fa-calendar-check me-2" style="color: #6B46C1;"></i>
                {% trans "Programmer des Inventaires Mensuels" %}
            </h2>
        </div>
    </div>

    <!-- Étape 1: Sélection du mois -->
    <div class="card mb-4">
        <div class="card-header" style="background: linear-gradient(135deg, #6B46C1 0%, #553C9A 100%); color: white;">
            <h5 class="mb-0">{% trans "Étape 1: Sélection du mois" %}</h5>
        </div>
        <div class="card-body">
            <form method="get">
                <div class="row">
                    <div class="col-md-6">
                        <select name="mois" class="form-select form-select-lg" onchange="this.form.submit()" required>
                            <option value="">-- {% trans "Sélectionner un mois" %} --</option>
                            {% for mois in mois_disponibles %}
                            <option value="{{ mois }}" {% if mois == mois_selectionne %}selected{% endif %}>
                                {{ mois }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </form>
        </div>
    </div>

    {% if mois_selectionne %}
    <!-- Étape 2: Sélection du motif -->
    <div class="card mb-4">
        <div class="card-header" style="background: linear-gradient(135deg, #6B46C1 0%, #553C9A 100%); color: white;">
            <h5 class="mb-0">{% trans "Étape 2: Sélection du motif" %}</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <!-- Taux de déperdition AUTOMATIQUE -->
                <div class="col-md-3">
                    <div class="motif-card">
                        <div class="text-center">
                            <i class="fas fa-chart-line fa-3x mb-3" style="color: #dc2626;"></i>
                            <h5>{% trans "Taux de Déperdition" %}</h5>
                            <p class="text-muted mb-2">{% trans "Sélection automatique" %}</p>
                            <form method="post">
                                {% csrf_token %}
                                <input type="hidden" name="mois" value="{{ mois_selectionne }}">
                                <input type="hidden" name="motif" value="taux_deperdition">
                                <button type="submit" name="generer" class="btn btn-danger">
                                    <i class="fas fa-magic me-1"></i>{% trans "Générer" %}
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Risque de baisse -->
                <div class="col-md-3">
                    <div class="motif-card">
                        <div class="text-center">
                            <i class="fas fa-arrow-down fa-3x mb-3" style="color: #d97706;"></i>
                            <h5>{% trans "Risque de Baisse" %}</h5>
                            <p class="text-muted mb-2">{% trans "Baisse annuelle" %}</p>
                            <form method="post">
                                {% csrf_token %}
                                <input type="hidden" name="mois" value="{{ mois_selectionne }}">
                                <input type="hidden" name="motif" value="risque_baisse">
                                <button type="submit" name="generer" class="btn btn-warning">
                                    <i class="fas fa-cogs me-1"></i>{% trans "Générer" %}
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Grand stock -->
                <div class="col-md-3">
                    <div class="motif-card">
                        <div class="text-center">
                            <i class="fas fa-boxes fa-3x mb-3" style="color: #2563eb;"></i>
                            <h5>{% trans "Grand Stock" %}</h5>
                            <p class="text-muted mb-2">{% trans "Stock excédentaire" %}</p>
                            <form method="post">
                                {% csrf_token %}
                                <input type="hidden" name="mois" value="{{ mois_selectionne }}">
                                <input type="hidden" name="motif" value="grand_stock">
                                <button type="submit" name="generer" class="btn btn-info">
                                    <i class="fas fa-cogs me-1"></i>{% trans "Générer" %}
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Présence Administrative -->
                <div class="col-md-3">
                    <div class="motif-card">
                        <div class="text-center">
                            <i class="fas fa-building fa-3x mb-3" style="color: #059669;"></i>
                            <h5>{% trans "Présence Admin" %}</h5>
                            <p class="text-muted mb-2">{% trans "Sélection manuelle" %}</p>
                            <form method="post">
                                {% csrf_token %}
                                <input type="hidden" name="mois" value="{{ mois_selectionne }}">
                                <input type="hidden" name="motif" value="presence_admin">
                                <button type="submit" name="generer" class="btn btn-success">
                                    <i class="fas fa-hand-pointer me-1"></i>{% trans "Générer" %}
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Étape 3: Sélection des postes -->
    {% if motif_selectionne %}

    <div class="card mb-4">
        <div class="card-header" style="background: linear-gradient(135deg, #6B46C1 0%, #553C9A 100%); color: white;">
            <h5 class="mb-0">{% trans "Étape 3: Sélection des postes" %}</h5>
        </div>
        <div class="card-body">
            <form method="post">
                {% csrf_token %}
                <input type="hidden" name="mois" value="{{ mois_selectionne }}">
                <input type="hidden" name="motif" value="{{ motif_selectionne }}">

                {% if motif_selectionne == 'taux_deperdition' %}
                    {% if postes_taux_auto %}
                        <div class="alert alert-success mb-3">
                            <i class="fas fa-magic me-2"></i>
                            <strong>{{ postes_taux_auto|length }}</strong> poste(s) auto-sélectionné(s) (taux < -10%)
                            <small>Vous pouvez décocher si nécessaire</small>
                        </div>
                        <h6>Postes auto-sélectionnés :</h6>
                        {% for item in postes_taux_auto %}
                        <div class="poste-item">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="postes" value="{{ item.poste.id }}" id="poste_auto_{{ item.poste.id }}" checked>
                                <input type="hidden" name="taux_{{ item.poste.id }}" value="{{ item.taux_deperdition|default:'0' }}">
                                <label class="form-check-label d-flex justify-content-between flex-wrap" for="poste_auto_{{ item.poste.id }}">
                                    <div>
                                        <strong>{{ item.poste.nom }}</strong> ({{ item.poste.code }})
                                    </div>
                                    <div>
                                        <span class="indicator-badge indicator-danger">
                                            {{ item.taux_deperdition|floatformat:2 }}%
                                        </span>
                                    </div>
                                </label>
                            </div>
                        </div>
                        {% endfor %}
                    {% endif %}

                    {% if postes_taux_manuel %}
                        <hr>
                        <h6>Autres postes :</h6>
                        {% for item in postes_taux_manuel %}
                        <div class="poste-item">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="postes" value="{{ item.poste.id }}" id="poste_man_{{ item.poste.id }}">
                                {% if item.taux_deperdition %}
                                <input type="hidden" name="taux_{{ item.poste.id }}" value="{{ item.taux_deperdition|default:'0' }}">
                                {% endif %}
                                <label class="form-check-label" for="poste_man_{{ item.poste.id }}">
                                    <strong>{{ item.poste.nom }}</strong>
                                    {% if item.taux_deperdition %}
                                    <span class="badge bg-info">{{ item.taux_deperdition|floatformat:2 }}%</span>
                                    {% endif %}
                                </label>
                            </div>
                        </div>
                        {% endfor %}
                    {% endif %}

                {% elif motif_selectionne == 'presence_admin' %}
                    <div class="mb-3">
                        <button type="button" class="btn btn-sm btn-primary" onclick="selectAll()">Tout cocher</button>
                        <button type="button" class="btn btn-sm btn-secondary ms-2" onclick="deselectAll()">Tout décocher</button>
                    </div>
                    {% for poste in postes_presence_admin %}
                    <div class="poste-item">
                        <div class="form-check">
                            <input class="form-check-input poste-checkbox" type="checkbox" name="postes" value="{{ poste.id }}" id="admin_{{ poste.id }}">
                            <label class="form-check-label" for="admin_{{ poste.id }}">
                                <strong>{{ poste.nom }}</strong> ({{ poste.code }}) - {{ poste.get_region_display }}
                            </label>
                        </div>
                    </div>
                    {% endfor %}

                {% elif motif_selectionne == 'risque_baisse' %}
                    {% if postes_risque_baisse %}
                        <div class="alert alert-warning mb-3">
                            <i class="fas fa-arrow-down me-2"></i>
                            <strong>{{ postes_risque_baisse|length }}</strong> poste(s) avec risque de baisse annuelle détecté
                            <small>Comparaison avec la même période de l'année N-1</small>
                        </div>
                        {% for item in postes_risque_baisse %}
                        <div class="poste-item {% if item.deja_programme %}disabled{% endif %}">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="postes" value="{{ item.poste.id }}" id="baisse_{{ item.poste.id }}"
                                {% if not item.deja_programme %}checked{% endif %}
                                {% if item.deja_programme %}disabled{% endif %}>
                                <label class="form-check-label d-flex justify-content-between flex-wrap" for="baisse_{{ item.poste.id }}">
                                    <div>
                                        <strong>{{ item.poste.nom }}</strong> ({{ item.poste.code }})
                                        {% if item.deja_programme %}
                                        <span class="badge bg-secondary ms-2">Déjà programmé</span>
                                        {% endif %}
                                    </div>
                                    <div>
                                        <span class="indicator-badge indicator-danger">
                                            <i class="fas fa-arrow-down"></i> {{ item.pourcentage_baisse|floatformat:1 }}%
                                        </span>
                                        <small class="text-muted ms-2 d-block mt-1">
                                            N: {{ item.recettes_estimees|floatformat:0|format_milliers }} FCFA |
                                            N-1: {{ item.recettes_n1|floatformat:0|format_milliers }} FCFA
                                        </small>
                                    </div>
                                </label>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-2"></i>
                            Aucun poste en baisse annuelle détecté. Tous les postes sont stables ou en hausse.
                        </div>
                    {% endif %}

                {% elif motif_selectionne == 'grand_stock' %}
                    {% if postes_grand_stock %}
                        <div class="alert alert-info mb-3">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>{{ postes_grand_stock|length }}</strong> poste(s) avec stock excédentaire
                            <small>Date d'épuisement prévue après le 31 décembre {{ mois.year }}</small>
                        </div>
                        {% for item in postes_grand_stock %}
                        <div class="poste-item {% if item.deja_programme %}disabled{% endif %}">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="postes" value="{{ item.poste.id }}" id="stock_{{ item.poste.id }}"
                                {% if not item.deja_programme %}checked{% endif %}
                                {% if item.deja_programme %}disabled{% endif %}>
                                <input type="hidden" name="stock_{{ item.poste.id }}" value="{{ item.stock_restant }}">
                                <label class="form-check-label d-flex justify-content-between flex-wrap" for="stock_{{ item.poste.id }}">
                                    <div>
                                        <strong>{{ item.poste.nom }}</strong> ({{ item.poste.code }})
                                        {% if item.deja_programme %}
                                        <span class="badge bg-secondary ms-2">Déjà programmé</span>
                                        {% endif %}
                                    </div>
                                    <div>
                                        <span class="indicator-badge indicator-info me-2">
                                            Stock: {{ item.stock_restant|floatformat:0|format_milliers }} FCFA
                                        </span>
                                        <span class="indicator-badge indicator-warning">
                                            Épuisement: {{ item.date_epuisement_formatee }}
                                        </span>
                                        <small class="text-muted ms-2 d-block mt-1">
                                            ({{ item.jours_restants }} jours)
                                        </small>
                                    </div>
                                </label>
                                <small class="text-muted d-block mt-1 ms-4">
                                    Vente moyenne: {{ item.vente_moyenne|floatformat:0|format_milliers }} FCFA/jour
                                </small>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Aucun poste n'a de stock avec une date d'épuisement après le 31 décembre.
                        </div>
                    {% endif %}

                {% endif %}

                <div class="text-center mt-4">
                    <button type="submit" name="programmer" class="btn btn-primary btn-lg">
                        <i class="fas fa-save me-2"></i>Programmer
                    </button>
                </div>
            </form>
        </div>
    </div>

    {% endif %}

</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Correction pour éviter le zoom automatique sur iOS
    document.addEventListener('touchstart', function() {}, {passive: true});

    // Ajustement dynamique pour les petits écrans
    function adjustForSmallScreen() {
        if (window.innerWidth < 768) {
            document.body.style.minWidth = '100%';
            document.body.style.maxWidth = '100vw';
            document.body.style.overflowX = 'hidden';
        } else {
            document.body.style.minWidth = '';
            document.body.style.maxWidth = '';
            document.body.style.overflowX = '';
        }
    }

    window.addEventListener('load', adjustForSmallScreen);
    window.addEventListener('resize', adjustForSmallScreen);
});

function selectAll() {
    document.querySelectorAll('.poste-checkbox').forEach(cb => cb.checked = true);
}

function deselectAll() {
    document.querySelectorAll('.poste-checkbox').forEach(cb => cb.checked = false);
}
</script>
{% endblock %}