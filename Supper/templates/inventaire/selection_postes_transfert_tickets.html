{% extends "admin/base_site.html" %}
{% load static i18n inventaire_extras %}

{% block title %}Transférer des Tickets - Sélection des Postes{% endblock %}

{% block extra_css %}
<style>
    .poste-card {
        border: 2px solid #dee2e6;
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1rem;
        transition: all 0.3s;
        background: white;
    }
    
    .poste-card:hover {
        border-color: #667eea;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
    }
    
    .poste-selected {
        border-color: #667eea;
        background: linear-gradient(to right, #f8f9ff, white);
    }
    
    .stock-info {
        background: #f8f9fa;
        border-left: 3px solid #28a745;
        padding: 0.5rem 1rem;
        margin-top: 0.5rem;
    }
    
    .serie-badge {
        display: inline-block;
        padding: 0.3rem 0.8rem;
        background: #667eea;
        color: white;
        border-radius: 15px;
        font-size: 0.85rem;
        margin: 0.2rem;
    }
    
    .couleur-section {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    
    .couleur-header {
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 0.5rem;
        padding: 0.5rem;
        background: #f3f4f6;
        border-radius: 5px;
    }
    
    .loading-spinner {
        display: none;
        text-align: center;
        padding: 2rem;
    }
    
    .loading-spinner.active {
        display: block;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <h2 class="mb-4">
        <i class="fas fa-exchange-alt me-2"></i>
        Transférer des Tickets Entre Postes
    </h2>
    
    <div class="alert alert-info">
        <i class="fas fa-info-circle me-2"></i>
        <strong>Instructions :</strong> 
        Sélectionnez d'abord le poste émetteur pour voir son stock disponible, 
        puis sélectionnez le poste destinataire.
    </div>
    
    <!-- Formulaire de sélection -->
    <form method="post" id="formSelection" action="">
        {% csrf_token %}
        
        <div class="row">
            <!-- Poste Émetteur -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-arrow-circle-left me-2"></i>
                            Poste Émetteur (qui cède les tickets)
                        </h5>
                    </div>
                    <div class="card-body">
                        <select name="poste_origine" id="id_poste_origine" 
                                class="form-select form-select-lg" 
                                onchange="chargerStockOrigine(this.value)">
                            <option value="">-- Sélectionner le poste émetteur --</option>
                            {% for item in postes %}
                            <option value="{{ item.poste.id }}" 
                                    {% if poste_origine and poste_origine.id == item.poste.id %}selected{% endif %}>
                                {{ item.poste.nom }} ({{ item.poste.code }}) - {{ item.tickets_actuels }} tickets
                            </option>
                            {% endfor %}
                        </select>
                        
                        <!-- Spinner de chargement -->
                        <div id="loadingSpinner" class="loading-spinner">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Chargement...</span>
                            </div>
                            <p class="mt-2 text-muted">Chargement du stock...</p>
                        </div>
                        
                        <!-- Stock du poste émetteur -->
                        <div id="stockOrigineContainer">
                            {% if poste_origine and stock_origine_data %}
                            <div class="stock-info mt-3">
                                <h6><i class="fas fa-boxes me-2"></i>Stock disponible au {{ poste_origine.nom }} :</h6>
                                
                                {% for couleur_nom, groupe in stock_origine_data.items %}
                                <div class="couleur-section">
                                    <div class="couleur-header">
                                        <i class="fas fa-ticket-alt me-2"></i>
                                        {{ couleur_nom }}
                                        <span class="float-end">
                                            Total: {{ groupe.total_tickets }} tickets 
                                            ({{ groupe.valeur_totale|floatformat:0|format_milliers }} FCFA)
                                        </span>
                                    </div>
                                    
                                    <div class="series-list">
                                        {% for serie in groupe.series %}
                                        <div class="d-flex justify-content-between align-items-center py-1 border-bottom">
                                            <span>
                                                <i class="fas fa-hashtag text-muted"></i>
                                                <strong>{{ serie.numero_premier|format_milliers }}</strong> 
                                                → 
                                                <strong>{{ serie.numero_dernier|format_milliers }}</strong>
                                            </span>
                                            <span>
                                                <span class="badge bg-primary">
                                                    {{ serie.nombre_tickets|format_milliers }} tickets
                                                </span>
                                                <span class="badge bg-success">
                                                    {{ serie.valeur_monetaire|floatformat:0|format_milliers }} FCFA
                                                </span>
                                            </span>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% empty %}
                                <div class="alert alert-warning mt-2">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    Aucun stock disponible dans ce poste
                                </div>
                                {% endfor %}
                            </div>
                            {% elif poste_origine %}
                            <div class="alert alert-warning mt-3">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <strong>Attention :</strong> Aucun stock de tickets disponible dans ce poste.
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Poste Destinataire -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-arrow-circle-right me-2"></i>
                            Poste Destinataire (qui reçoit les tickets)
                        </h5>
                    </div>
                    <div class="card-body">
                        <select name="poste_destination" id="id_poste_destination" 
                                class="form-select form-select-lg"
                                {% if not poste_origine %}disabled{% endif %}>
                            <option value="">-- Sélectionner le poste destinataire --</option>
                            {% for item in postes %}
                            <option value="{{ item.poste.id }}"
                                    {% if poste_origine and poste_origine.id == item.poste.id %}disabled{% endif %}>
                                {{ item.poste.nom }} ({{ item.poste.code }})
                            </option>
                            {% endfor %}
                        </select>
                        
                        {% if not poste_origine %}
                        <div class="alert alert-secondary mt-3">
                            <i class="fas fa-hand-point-left me-2"></i>
                            Veuillez d'abord sélectionner le poste émetteur
                        </div>
                        {% else %}
                        <div class="alert alert-info mt-3">
                            <i class="fas fa-hand-point-up me-2"></i>
                            Sélectionnez maintenant le poste qui recevra les tickets
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <div class="text-center mt-4">
            <a href="javascript:history.back()" class="btn btn-secondary btn-lg me-3">
                <i class="fas fa-arrow-left me-2"></i>
                Retour à la liste
            </a>
            <button type="submit" id="btnContinuer" class="btn btn-primary btn-lg" 
                    {% if not poste_origine or not stock_origine_data %}disabled{% endif %}>
                <i class="fas fa-arrow-right me-2"></i>
                Continuer vers la saisie des tickets
            </button>
        </div>
    </form>
    
    <!-- Liste de tous les postes pour référence -->
    <div class="mt-5">
        <h4 class="mb-3">
            <i class="fas fa-list me-2"></i>
            Vue d'ensemble des stocks
        </h4>
        <div class="row">
            {% for item in postes %}
            <div class="col-md-4 mb-3">
                <div class="poste-card {% if poste_origine and poste_origine.id == item.poste.id %}poste-selected{% endif %}"
                     onclick="selectPosteOrigine('{{ item.poste.id }}')" 
                     style="cursor: pointer;">
                    <h6>
                        <i class="fas fa-building me-2"></i>
                        {{ item.poste.nom }}
                    </h6>
                    <p class="text-muted mb-2">Code: {{ item.poste.code }}</p>
                    <div class="d-flex justify-content-between">
                        <span>Stock:</span>
                        <strong class="{% if item.stock_actuel > 0 %}text-success{% else %}text-danger{% endif %}">
                            {{ item.stock_actuel|floatformat:0|format_milliers }} FCFA
                        </strong>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Tickets:</span>
                        <strong>{{ item.tickets_actuels|format_milliers }} tickets</strong>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// ===================================================================
// JAVASCRIPT POUR LA SÉLECTION DES POSTES
// ===================================================================

/**
 * Charge le stock du poste origine sélectionné
 * Soumet le formulaire en POST pour recharger la page avec les données du stock
 */
function chargerStockOrigine(posteId) {
    if (!posteId) {
        // Pas de poste sélectionné, réinitialiser
        document.getElementById('stockOrigineContainer').innerHTML = '';
        document.getElementById('id_poste_destination').disabled = true;
        document.getElementById('btnContinuer').disabled = true;
        return;
    }
    
    // Afficher le spinner de chargement
    document.getElementById('loadingSpinner').classList.add('active');
    document.getElementById('stockOrigineContainer').innerHTML = '';
    
    // Réinitialiser le poste destination
    document.getElementById('id_poste_destination').value = '';
    
    // Soumettre le formulaire pour recharger avec le stock
    // On ajoute un champ caché pour indiquer que c'est juste un rechargement
    const form = document.getElementById('formSelection');
    
    // Créer le formulaire de rechargement
    const reloadForm = document.createElement('form');
    reloadForm.method = 'POST';
    reloadForm.action = window.location.pathname;
    
    // Ajouter le CSRF token
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrfmiddlewaretoken';
    csrfInput.value = document.querySelector('[name=csrfmiddlewaretoken]').value;
    reloadForm.appendChild(csrfInput);
    
    // Ajouter le poste origine
    const posteInput = document.createElement('input');
    posteInput.type = 'hidden';
    posteInput.name = 'poste_origine';
    posteInput.value = posteId;
    reloadForm.appendChild(posteInput);
    
    // Soumettre
    document.body.appendChild(reloadForm);
    reloadForm.submit();
}

/**
 * Sélectionne un poste origine depuis la vue d'ensemble
 */
function selectPosteOrigine(posteId) {
    document.getElementById('id_poste_origine').value = posteId;
    chargerStockOrigine(posteId);
}

/**
 * Active/désactive le bouton de soumission selon les sélections
 */
function updateBtnContinuer() {
    const posteOrigine = document.getElementById('id_poste_origine').value;
    const posteDestination = document.getElementById('id_poste_destination').value;
    const btnContinuer = document.getElementById('btnContinuer');
    
    // Le bouton est actif seulement si les deux postes sont sélectionnés
    // et qu'il y a du stock (vérifié côté serveur)
    if (posteOrigine && posteDestination && posteOrigine !== posteDestination) {
        btnContinuer.disabled = false;
    } else {
        btnContinuer.disabled = true;
    }
}

/**
 * Met à jour les options du poste destination
 * Désactive le poste origine pour éviter de transférer vers soi-même
 */
function updatePosteDestinationOptions() {
    const posteOrigineId = document.getElementById('id_poste_origine').value;
    const selectDestination = document.getElementById('id_poste_destination');
    
    // Réactiver toutes les options d'abord
    Array.from(selectDestination.options).forEach(option => {
        option.disabled = false;
    });
    
    // Désactiver le poste origine dans la liste destination
    if (posteOrigineId) {
        const optionToDisable = selectDestination.querySelector(`option[value="${posteOrigineId}"]`);
        if (optionToDisable) {
            optionToDisable.disabled = true;
        }
        selectDestination.disabled = false;
    } else {
        selectDestination.disabled = true;
    }
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    const selectDestination = document.getElementById('id_poste_destination');
    
    // Mettre à jour le bouton quand le poste destination change
    selectDestination.addEventListener('change', function() {
        updateBtnContinuer();
    });
    
    // Vérifier l'état initial
    updatePosteDestinationOptions();
    updateBtnContinuer();
});

// Validation avant soumission
document.getElementById('formSelection').addEventListener('submit', function(e) {
    const posteOrigine = document.getElementById('id_poste_origine').value;
    const posteDestination = document.getElementById('id_poste_destination').value;
    
    // Si pas de destination, c'est juste un rechargement du stock
    if (!posteDestination) {
        // Laisser passer pour recharger le stock
        return true;
    }
    
    // Sinon, valider que les deux postes sont différents
    if (posteOrigine === posteDestination) {
        e.preventDefault();
        alert('Les postes émetteur et destinataire doivent être différents.');
        return false;
    }
    
    return true;
});
</script>
{% endblock %}