{% extends "admin/base_site.html" %}
{% load static i18n inventaire_extras %}

{% block title %}Transférer des Tickets - Sélection des Postes{% endblock %}

{% block extra_css %}
<style>
    /* ============================================
       RÉINITIALISATION POUR MOBILE
       ============================================ */
    * {
        box-sizing: border-box;
    }
    
    .container-fluid {
        width: 100%;
        max-width: 100%;
        padding-left: 15px;
        padding-right: 15px;
        margin-left: auto;
        margin-right: auto;
        overflow-x: hidden;
    }
    
    .py-4 {
        padding-top: 1.5rem !important;
        padding-bottom: 1.5rem !important;
    }
    
    .row {
        display: flex;
        flex-wrap: wrap;
        margin-left: -10px;
        margin-right: -10px;
        width: calc(100% + 20px);
    }
    
    .col-md-6, .col-md-4 {
        padding-left: 10px;
        padding-right: 10px;
        width: 100%;
        max-width: 100%;
        margin-bottom: 1rem;
    }
    
    /* ============================================
       TYPOGRAPHIE RESPONSIVE
       ============================================ */
    h2 {
        font-size: 1.75rem;
        margin-bottom: 1.5rem;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }
    
    h4 {
        font-size: 1.5rem;
        margin-bottom: 1rem;
    }
    
    h5 {
        font-size: 1.25rem;
        margin-bottom: 0.75rem;
    }
    
    h6 {
        font-size: 1rem;
        margin-bottom: 0.5rem;
    }
    
    /* ============================================
       ALERTES RESPONSIVES
       ============================================ */
    .alert {
        width: 100%;
        word-wrap: break-word;
        overflow-wrap: break-word;
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
    }
    
    .alert-info {
        background-color: #e7f5ff;
        border-color: #d0ebff;
        color: #055160;
    }
    
    .alert-warning {
        background-color: #fff3cd;
        border-color: #ffecb5;
        color: #664d03;
    }
    
    .alert-secondary {
        background-color: #e9ecef;
        border-color: #dee2e6;
        color: #495057;
    }
    
    .alert i {
        margin-right: 0.5rem;
    }
    
    /* ============================================
       CARTES RESPONSIVES
       ============================================ */
    .card {
        width: 100%;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        margin-bottom: 1.5rem;
        overflow: hidden;
        background: #fff;
    }
    
    .card-header {
        padding: 1rem;
        border-bottom: 1px solid #dee2e6;
    }
    
    .card-header.bg-danger {
        background: linear-gradient(135deg, #dc3545 0%, #c82333 100%) !important;
    }
    
    .card-header.bg-success {
        background: linear-gradient(135deg, #28a745 0%, #218838 100%) !important;
    }
    
    .card-header.text-white {
        color: white !important;
    }
    
    .card-body {
        padding: 1rem;
        width: 100%;
    }
    
    /* ============================================
       FORMULAIRES RESPONSIVES
       ============================================ */
    .form-select-lg {
        width: 100%;
        padding: 0.75rem 2.25rem 0.75rem 1rem;
        font-size: 1rem;
        border: 1px solid #ced4da;
        border-radius: 8px;
        background-color: #fff;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right 0.75rem center;
        background-size: 16px 12px;
        appearance: none;
        margin-bottom: 1rem;
    }
    
    .form-select-lg:focus {
        border-color: #80bdff;
        outline: 0;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }
    
    .form-select-lg:disabled {
        background-color: #e9ecef;
        opacity: 0.6;
    }
    
    /* ============================================
       CARTES DE POSTES RESPONSIVES
       ============================================ */
    .poste-card {
        border: 2px solid #dee2e6;
        border-radius: 10px;
        padding: 1rem;
        margin-bottom: 1rem;
        transition: all 0.3s;
        background: white;
        width: 100%;
        cursor: pointer;
    }
    
    .poste-card:hover {
        border-color: #667eea;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
    }
    
    .poste-selected {
        border-color: #667eea;
        background: linear-gradient(to right, #f8f9ff, white);
    }
    
    /* ============================================
       SECTIONS DE STOCK RESPONSIVES
       ============================================ */
    .stock-info {
        background: #f8f9fa;
        border-left: 3px solid #28a745;
        padding: 1rem;
        margin-top: 1rem;
        border-radius: 0 8px 8px 0;
        width: 100%;
        overflow: hidden;
    }
    
    .couleur-section {
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        width: 100%;
    }
    
    .couleur-header {
        font-weight: 600;
        color: #1f2937;
        margin-bottom: 0.75rem;
        padding: 0.75rem;
        background: #f3f4f6;
        border-radius: 6px;
        font-size: 0.95rem;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }
    
    .couleur-header .float-end {
        float: none;
        display: block;
        margin-top: 0.5rem;
        font-size: 0.85rem;
        color: #6b7280;
    }
    
    .series-list {
        width: 100%;
    }
    
    .series-list .d-flex {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem 0;
        border-bottom: 1px solid #f1f1f1;
        width: 100%;
    }
    
    .series-list span {
        word-break: break-word;
        overflow-wrap: break-word;
        margin-bottom: 0.25rem;
    }
    
    .series-list .badge {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
        font-weight: 600;
        line-height: 1;
        text-align: center;
        white-space: nowrap;
        vertical-align: baseline;
        border-radius: 0.375rem;
        margin-left: 0.25rem;
        margin-bottom: 0.25rem;
    }
    
    .badge.bg-primary {
        background-color: #007bff !important;
    }
    
    .badge.bg-success {
        background-color: #28a745 !important;
    }
    
    /* ============================================
       BOUTONS RESPONSIVES
       ============================================ */
    .btn {
        display: inline-block;
        font-weight: 400;
        text-align: center;
        white-space: nowrap;
        vertical-align: middle;
        user-select: none;
        border: 1px solid transparent;
        padding: 0.75rem 1.5rem;
        font-size: 1rem;
        line-height: 1.5;
        border-radius: 8px;
        transition: all 0.3s;
        text-decoration: none;
        cursor: pointer;
    }
    
    .btn-lg {
        padding: 1rem 2rem;
        font-size: 1.125rem;
        border-radius: 10px;
    }
    
    .btn-secondary {
        color: #fff;
        background-color: #6c757d;
        border-color: #6c757d;
    }
    
    .btn-secondary:hover {
        background-color: #5a6268;
        border-color: #545b62;
    }
    
    .btn-primary {
        color: #fff;
        background-color: #007bff;
        border-color: #007bff;
    }
    
    .btn-primary:hover {
        background-color: #0069d9;
        border-color: #0062cc;
    }
    
    .btn-primary:disabled {
        background-color: #6c757d;
        border-color: #6c757d;
        opacity: 0.65;
        cursor: not-allowed;
    }
    
    .text-center {
        text-align: center !important;
        width: 100%;
    }
    
    .text-center .btn {
        margin-bottom: 0.5rem;
        width: 100%;
        max-width: 300px;
    }
    
    /* ============================================
       LOADING SPINNER
       ============================================ */
    .loading-spinner {
        display: none;
        text-align: center;
        padding: 2rem;
        width: 100%;
    }
    
    .loading-spinner.active {
        display: block;
    }
    
    .spinner-border {
        display: inline-block;
        width: 2rem;
        height: 2rem;
        vertical-align: text-bottom;
        border: 0.25em solid currentColor;
        border-right-color: transparent;
        border-radius: 50%;
        animation: spinner-border .75s linear infinite;
    }
    
    @keyframes spinner-border {
        to { transform: rotate(360deg); }
    }
    
    .visually-hidden {
        position: absolute !important;
        width: 1px !important;
        height: 1px !important;
        padding: 0 !important;
        margin: -1px !important;
        overflow: hidden !important;
        clip: rect(0,0,0,0) !important;
        white-space: nowrap !important;
        border: 0 !important;
    }
    
    /* ============================================
       MARGES ET ESPACEMENTS RESPONSIVES
       ============================================ */
    .mb-3 {
        margin-bottom: 1rem !important;
    }
    
    .mb-4 {
        margin-bottom: 1.5rem !important;
    }
    
    .mt-2 {
        margin-top: 0.5rem !important;
    }
    
    .mt-3 {
        margin-top: 1rem !important;
    }
    
    .mt-4 {
        margin-top: 1.5rem !important;
    }
    
    .mt-5 {
        margin-top: 2rem !important;
    }
    
    .me-2 {
        margin-right: 0.5rem !important;
    }
    
    .me-3 {
        margin-right: 1rem !important;
    }
    
    .py-1 {
        padding-top: 0.25rem !important;
        padding-bottom: 0.25rem !important;
    }
    
    /* ============================================
       MEDIA QUERIES - MOBILE (≤ 768px)
       ============================================ */
    @media (max-width: 768px) {
        .container-fluid {
            padding-left: 12px;
            padding-right: 12px;
        }
        
        .py-4 {
            padding-top: 1rem !important;
            padding-bottom: 1rem !important;
        }
        
        h2 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }
        
        h4 {
            font-size: 1.25rem;
        }
        
        h5 {
            font-size: 1.125rem;
        }
        
        .row {
            margin-left: -8px;
            margin-right: -8px;
            width: calc(100% + 16px);
        }
        
        .col-md-6, .col-md-4 {
            padding-left: 8px;
            padding-right: 8px;
            margin-bottom: 0.75rem;
        }
        
        .card-header {
            padding: 0.875rem;
        }
        
        .card-body {
            padding: 0.875rem;
        }
        
        .form-select-lg {
            padding: 0.625rem 1.75rem 0.625rem 0.875rem;
            font-size: 0.95rem;
        }
        
        .poste-card {
            padding: 0.875rem;
            margin-bottom: 0.75rem;
        }
        
        .stock-info {
            padding: 0.875rem;
            margin-top: 0.75rem;
        }
        
        .couleur-section {
            padding: 0.875rem;
            margin-bottom: 0.75rem;
        }
        
        .couleur-header {
            padding: 0.625rem;
            font-size: 0.9rem;
        }
        
        .series-list .d-flex {
            padding: 0.375rem 0;
        }
        
        .series-list .badge {
            padding: 0.2rem 0.4rem;
            font-size: 0.7rem;
        }
        
        .btn {
            padding: 0.625rem 1.25rem;
            font-size: 0.95rem;
        }
        
        .btn-lg {
            padding: 0.75rem 1.5rem;
            font-size: 1rem;
        }
        
        .text-center .btn {
            max-width: 100%;
        }
        
        .loading-spinner {
            padding: 1.5rem;
        }
    }
    
    /* ============================================
       PETITS MOBILES (≤ 576px)
       ============================================ */
    @media (max-width: 576px) {
        .container-fluid {
            padding-left: 10px;
            padding-right: 10px;
        }
        
        h2 {
            font-size: 1.375rem;
        }
        
        h4 {
            font-size: 1.125rem;
        }
        
        .row {
            margin-left: -6px;
            margin-right: -6px;
            width: calc(100% + 12px);
        }
        
        .col-md-6, .col-md-4 {
            padding-left: 6px;
            padding-right: 6px;
            margin-bottom: 0.5rem;
        }
        
        .card-header {
            padding: 0.75rem;
        }
        
        .card-body {
            padding: 0.75rem;
        }
        
        .form-select-lg {
            padding: 0.5rem 1.5rem 0.5rem 0.75rem;
            font-size: 0.9rem;
        }
        
        .alert {
            padding: 0.875rem;
            font-size: 0.9rem;
        }
        
        .poste-card {
            padding: 0.75rem;
            margin-bottom: 0.625rem;
        }
        
        .stock-info {
            padding: 0.75rem;
        }
        
        .couleur-section {
            padding: 0.75rem;
        }
        
        .couleur-header {
            padding: 0.5rem;
            font-size: 0.85rem;
        }
        
        .couleur-header .float-end {
            font-size: 0.8rem;
            margin-top: 0.375rem;
        }
        
        .series-list .d-flex {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .series-list span:last-child {
            margin-top: 0.25rem;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            font-size: 0.9rem;
        }
        
        .btn-lg {
            padding: 0.625rem 1.25rem;
            font-size: 0.95rem;
        }
        
        .text-center .btn {
            display: block;
            margin-left: auto;
            margin-right: auto;
        }
    }
    
    /* ============================================
       TRÈS PETITS ÉCRANS (< 375px)
       ============================================ */
    @media (max-width: 375px) {
        h2 {
            font-size: 1.25rem;
        }
        
        .form-select-lg {
            font-size: 0.85rem;
        }
        
        .alert {
            font-size: 0.85rem;
        }
        
        .couleur-header {
            font-size: 0.8rem;
        }
        
        .btn {
            font-size: 0.85rem;
            padding: 0.5rem 0.875rem;
        }
    }
    
    /* ============================================
       ORIENTATION PAYSAGE SUR MOBILE
       ============================================ */
    @media (max-width: 896px) and (orientation: landscape) {
        .col-md-6 {
            flex: 0 0 100%;
            max-width: 100%;
        }
        
        .col-md-4 {
            flex: 0 0 50%;
            max-width: 50%;
        }
        
        .text-center .btn {
            display: inline-block;
            width: auto;
            max-width: 45%;
        }
    }
    
    /* ============================================
       TABLETTE (769px à 1024px)
       ============================================ */
    @media (min-width: 769px) {
        .col-md-6 {
            flex: 0 0 50%;
            max-width: 50%;
        }
        
        .col-md-4 {
            flex: 0 0 33.333333%;
            max-width: 33.333333%;
        }
        
        .text-center .btn {
            width: auto;
            display: inline-block;
        }
    }
    
    /* ============================================
       CORRECTION DU DÉFILEMENT HORIZONTAL
       ============================================ */
    body, html {
        overflow-x: hidden !important;
        max-width: 100vw !important;
        width: 100% !important;
        position: relative !important;
    }
    
    .main-content {
        overflow-x: hidden !important;
        width: 100% !important;
        max-width: 100vw !important;
    }
    
    .content-wrapper {
        min-width: 100% !important;
        width: 100% !important;
        max-width: 100vw !important;
        padding: 1rem !important;
    }
    
    /* ============================================
       GESTION DU TEXTE TRÈS LONG
       ============================================ */
    .couleur-header,
    .series-list span,
    .poste-card h6,
    .alert {
        word-wrap: break-word;
        overflow-wrap: break-word;
        hyphens: auto;
    }
    
    /* ============================================
       ACCESSIBILITÉ
       ============================================ */
    .form-select-lg:focus,
    .btn:focus,
    .poste-card:focus {
        outline: 2px solid #007bff;
        outline-offset: 2px;
    }
    
    /* ============================================
       ÉLÉMENTS FLEXIBLES POUR LES BADGES
       ============================================ */
    .series-list .d-flex span:last-child {
        display: flex;
        flex-wrap: wrap;
        justify-content: flex-start;
    }
    
    /* ============================================
       CORRECTION POUR LES OPTIONS LONGUES
       ============================================ */
    option {
        white-space: normal;
        min-height: 1.5em;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <h2 class="mb-4">
        <i class="fas fa-exchange-alt me-2"></i>
        Transférer des Tickets Entre Postes
    </h2>
    
    <div class="alert alert-info">
        <i class="fas fa-info-circle me-2"></i>
        <strong>Instructions :</strong> 
        Sélectionnez d'abord le poste émetteur pour voir son stock disponible, 
        puis sélectionnez le poste destinataire.
    </div>
    
    <!-- Formulaire de sélection -->
    <form method="post" id="formSelection" action="">
        {% csrf_token %}
        
        <div class="row">
            <!-- Poste Émetteur -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-arrow-circle-left me-2"></i>
                            Poste Émetteur (qui cède les tickets)
                        </h5>
                    </div>
                    <div class="card-body">
                        <select name="poste_origine" id="id_poste_origine" 
                                class="form-select form-select-lg" 
                                onchange="chargerStockOrigine(this.value)">
                            <option value="">-- Sélectionner le poste émetteur --</option>
                            {% for item in postes %}
                            <option value="{{ item.poste.id }}" 
                                    {% if poste_origine and poste_origine.id == item.poste.id %}selected{% endif %}>
                                {{ item.poste.nom }} ({{ item.poste.code }}) - {{ item.tickets_actuels }} tickets
                            </option>
                            {% endfor %}
                        </select>
                        
                        <!-- Spinner de chargement -->
                        <div id="loadingSpinner" class="loading-spinner">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Chargement...</span>
                            </div>
                            <p class="mt-2 text-muted">Chargement du stock...</p>
                        </div>
                        
                        <!-- Stock du poste émetteur -->
                        <div id="stockOrigineContainer">
                            {% if poste_origine and stock_origine_data %}
                            <div class="stock-info mt-3">
                                <h6><i class="fas fa-boxes me-2"></i>Stock disponible au {{ poste_origine.nom }} :</h6>
                                
                                {% for couleur_nom, groupe in stock_origine_data.items %}
                                <div class="couleur-section">
                                    <div class="couleur-header">
                                        <i class="fas fa-ticket-alt me-2"></i>
                                        {{ couleur_nom }}
                                        <span class="float-end">
                                            Total: {{ groupe.total_tickets }} tickets 
                                            ({{ groupe.valeur_totale|floatformat:0|format_milliers }} FCFA)
                                        </span>
                                    </div>
                                    
                                    <div class="series-list">
                                        {% for serie in groupe.series %}
                                        <div class="d-flex justify-content-between align-items-center py-1 border-bottom">
                                            <span>
                                                <i class="fas fa-hashtag text-muted"></i>
                                                <strong>{{ serie.numero_premier|format_milliers }}</strong> 
                                                → 
                                                <strong>{{ serie.numero_dernier|format_milliers }}</strong>
                                            </span>
                                            <span>
                                                <span class="badge bg-primary">
                                                    {{ serie.nombre_tickets|format_milliers }} tickets
                                                </span>
                                                <span class="badge bg-success">
                                                    {{ serie.valeur_monetaire|floatformat:0|format_milliers }} FCFA
                                                </span>
                                            </span>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                {% empty %}
                                <div class="alert alert-warning mt-2">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    Aucun stock disponible dans ce poste
                                </div>
                                {% endfor %}
                            </div>
                            {% elif poste_origine %}
                            <div class="alert alert-warning mt-3">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <strong>Attention :</strong> Aucun stock de tickets disponible dans ce poste.
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Poste Destinataire -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="fas fa-arrow-circle-right me-2"></i>
                            Poste Destinataire (qui reçoit les tickets)
                        </h5>
                    </div>
                    <div class="card-body">
                        <select name="poste_destination" id="id_poste_destination" 
                                class="form-select form-select-lg"
                                {% if not poste_origine %}disabled{% endif %}>
                            <option value="">-- Sélectionner le poste destinataire --</option>
                            {% for item in postes %}
                            <option value="{{ item.poste.id }}"
                                    {% if poste_origine and poste_origine.id == item.poste.id %}disabled{% endif %}>
                                {{ item.poste.nom }} ({{ item.poste.code }})
                            </option>
                            {% endfor %}
                        </select>
                        
                        {% if not poste_origine %}
                        <div class="alert alert-secondary mt-3">
                            <i class="fas fa-hand-point-left me-2"></i>
                            Veuillez d'abord sélectionner le poste émetteur
                        </div>
                        {% else %}
                        <div class="alert alert-info mt-3">
                            <i class="fas fa-hand-point-up me-2"></i>
                            Sélectionnez maintenant le poste qui recevra les tickets
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <div class="text-center mt-4">
            <a href="javascript:history.back()" class="btn btn-secondary btn-lg me-3">
                <i class="fas fa-arrow-left me-2"></i>
                Retour à la liste
            </a>
            <button type="submit" id="btnContinuer" class="btn btn-primary btn-lg" 
                    {% if not poste_origine or not stock_origine_data %}disabled{% endif %}>
                <i class="fas fa-arrow-right me-2"></i>
                Continuer vers la saisie des tickets
            </button>
        </div>
    </form>
    
    <!-- Liste de tous les postes pour référence -->
    <div class="mt-5">
        <h4 class="mb-3">
            <i class="fas fa-list me-2"></i>
            Vue d'ensemble des stocks
        </h4>
        <div class="row">
            {% for item in postes %}
            <div class="col-md-4 mb-3">
                <div class="poste-card {% if poste_origine and poste_origine.id == item.poste.id %}poste-selected{% endif %}"
                     onclick="selectPosteOrigine('{{ item.poste.id }}')" 
                     style="cursor: pointer;"
                     tabindex="0"
                     role="button"
                     aria-label="Sélectionner {{ item.poste.nom }} comme poste émetteur"
                     onkeypress="if(event.key === 'Enter' || event.key === ' ') selectPosteOrigine('{{ item.poste.id }}')">
                    <h6>
                        <i class="fas fa-building me-2"></i>
                        {{ item.poste.nom }}
                    </h6>
                    <p class="text-muted mb-2">Code: {{ item.poste.code }}</p>
                    <div class="d-flex justify-content-between">
                        <span>Stock:</span>
                        <strong class="{% if item.stock_actuel > 0 %}text-success{% else %}text-danger{% endif %}">
                            {{ item.stock_actuel|floatformat:0|format_milliers }} FCFA
                        </strong>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Tickets:</span>
                        <strong>{{ item.tickets_actuels|format_milliers }} tickets</strong>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// ===================================================================
// JAVASCRIPT POUR LA SÉLECTION DES POSTES
// ===================================================================

/**
 * Charge le stock du poste origine sélectionné
 * Soumet le formulaire en POST pour recharger la page avec les données du stock
 */
function chargerStockOrigine(posteId) {
    if (!posteId) {
        // Pas de poste sélectionné, réinitialiser
        document.getElementById('stockOrigineContainer').innerHTML = '';
        document.getElementById('id_poste_destination').disabled = true;
        document.getElementById('btnContinuer').disabled = true;
        return;
    }
    
    // Afficher le spinner de chargement
    document.getElementById('loadingSpinner').classList.add('active');
    document.getElementById('stockOrigineContainer').innerHTML = '';
    
    // Réinitialiser le poste destination
    document.getElementById('id_poste_destination').value = '';
    
    // Soumettre le formulaire pour recharger avec le stock
    // On ajoute un champ caché pour indiquer que c'est juste un rechargement
    const form = document.getElementById('formSelection');
    
    // Créer le formulaire de rechargement
    const reloadForm = document.createElement('form');
    reloadForm.method = 'POST';
    reloadForm.action = window.location.pathname;
    
    // Ajouter le CSRF token
    const csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = 'csrfmiddlewaretoken';
    csrfInput.value = document.querySelector('[name=csrfmiddlewaretoken]').value;
    reloadForm.appendChild(csrfInput);
    
    // Ajouter le poste origine
    const posteInput = document.createElement('input');
    posteInput.type = 'hidden';
    posteInput.name = 'poste_origine';
    posteInput.value = posteId;
    reloadForm.appendChild(posteInput);
    
    // Soumettre
    document.body.appendChild(reloadForm);
    reloadForm.submit();
}

/**
 * Sélectionne un poste origine depuis la vue d'ensemble
 */
function selectPosteOrigine(posteId) {
    document.getElementById('id_poste_origine').value = posteId;
    chargerStockOrigine(posteId);
}

/**
 * Active/désactive le bouton de soumission selon les sélections
 */
function updateBtnContinuer() {
    const posteOrigine = document.getElementById('id_poste_origine').value;
    const posteDestination = document.getElementById('id_poste_destination').value;
    const btnContinuer = document.getElementById('btnContinuer');
    
    // Le bouton est actif seulement si les deux postes sont sélectionnés
    // et qu'il y a du stock (vérifié côté serveur)
    if (posteOrigine && posteDestination && posteOrigine !== posteDestination) {
        btnContinuer.disabled = false;
    } else {
        btnContinuer.disabled = true;
    }
}

/**
 * Met à jour les options du poste destination
 * Désactive le poste origine pour éviter de transférer vers soi-même
 */
function updatePosteDestinationOptions() {
    const posteOrigineId = document.getElementById('id_poste_origine').value;
    const selectDestination = document.getElementById('id_poste_destination');
    
    // Réactiver toutes les options d'abord
    Array.from(selectDestination.options).forEach(option => {
        option.disabled = false;
    });
    
    // Désactiver le poste origine dans la liste destination
    if (posteOrigineId) {
        const optionToDisable = selectDestination.querySelector(`option[value="${posteOrigineId}"]`);
        if (optionToDisable) {
            optionToDisable.disabled = true;
        }
        selectDestination.disabled = false;
    } else {
        selectDestination.disabled = true;
    }
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    const selectDestination = document.getElementById('id_poste_destination');
    
    // Mettre à jour le bouton quand le poste destination change
    selectDestination.addEventListener('change', function() {
        updateBtnContinuer();
    });
    
    // Vérifier l'état initial
    updatePosteDestinationOptions();
    updateBtnContinuer();
    
    // Gestion responsive des boutons
    function adjustButtonsForScreen() {
        const screenWidth = window.innerWidth;
        const buttonsContainer = document.querySelector('.text-center');
        
        if (screenWidth < 768) {
            // Sur mobile, les boutons sont empilés
            buttonsContainer.classList.add('d-flex', 'flex-column', 'align-items-center');
            buttonsContainer.querySelectorAll('.btn').forEach(btn => {
                btn.classList.add('mb-2');
                btn.classList.remove('me-3');
            });
        } else {
            // Sur desktop, les boutons sont côte à côte
            buttonsContainer.classList.remove('d-flex', 'flex-column', 'align-items-center');
            buttonsContainer.querySelectorAll('.btn').forEach((btn, index) => {
                btn.classList.remove('mb-2');
                if (index > 0) {
                    btn.classList.add('me-3');
                }
            });
        }
    }
    
    // Ajuster au chargement et au redimensionnement
    adjustButtonsForScreen();
    window.addEventListener('resize', adjustButtonsForScreen);
});

// Validation avant soumission
document.getElementById('formSelection').addEventListener('submit', function(e) {
    const posteOrigine = document.getElementById('id_poste_origine').value;
    const posteDestination = document.getElementById('id_poste_destination').value;
    
    // Si pas de destination, c'est juste un rechargement du stock
    if (!posteDestination) {
        // Laisser passer pour recharger le stock
        return true;
    }
    
    // Sinon, valider que les deux postes sont différents
    if (posteOrigine === posteDestination) {
        e.preventDefault();
        alert('Les postes émetteur et destinataire doivent être différents.');
        return false;
    }
    
    return true;
});

// Amélioration pour le tactile sur mobile
document.querySelectorAll('.poste-card').forEach(card => {
    card.addEventListener('touchstart', function() {
        this.style.transform = 'scale(0.98)';
    });
    
    card.addEventListener('touchend', function() {
        this.style.transform = '';
    });
});

// Correction pour éviter le zoom automatique sur iOS
document.addEventListener('touchstart', function() {}, {passive: true});
</script>
{% endblock %}