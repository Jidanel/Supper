<!-- templates/inventaire/compte_emploi_v2.html - VERSION AVEC DATES DE VENTES -->
{% extends "admin/base_site.html" %}
{% load static i18n inventaire_extras %}

{% block title %}Compte d'emploi - {{ poste.nom }}{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary-color: #0EA5E9;
        --secondary-color: #38BDF8;
        --primary-dark: #0284C7;
        --primary-light: #E0F2FE;
        --success-color: #22C55E;
        --success-light: #DCFCE7;
        --warning-color: #F97316;
        --warning-light: #FED7AA;
        --danger-color: #EF4444;
        --danger-light: #FEE2E2;
    }

    .compte-emploi-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
    }

    /* En-t√™te */
    .header-section {
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        color: white;
        padding: 25px;
        border-radius: 15px;
        margin-bottom: 25px;
        box-shadow: 0 4px 15px rgba(14, 165, 233, 0.3);
    }

    .header-section h1 {
        margin: 0 0 10px 0;
        font-size: 1.8rem;
    }

    .header-section .subtitle {
        opacity: 0.9;
        font-size: 1.1rem;
    }

    .header-section .periode {
        background: rgba(255, 255, 255, 0.2);
        padding: 8px 15px;
        border-radius: 8px;
        display: inline-block;
        margin-top: 10px;
    }

    /* Carte principale */
    .main-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        margin-bottom: 25px;
        overflow: hidden;
    }

    .card-header-custom {
        padding: 15px 20px;
        font-weight: 600;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .card-header-custom.bg-primary {
        background: var(--primary-color);
        color: white;
    }

    .card-header-custom.bg-success {
        background: var(--success-color);
        color: white;
    }

    .card-header-custom.bg-warning {
        background: var(--warning-color);
        color: white;
    }

    .card-header-custom.bg-danger {
        background: var(--danger-color);
        color: white;
    }

    .card-header-custom.bg-info {
        background: #06B6D4;
        color: white;
    }

    /* Tableau principal - NOUVEAU FORMAT */
    .table-compte-emploi {
        width: 100%;
        border-collapse: collapse;
    }

    .table-compte-emploi th {
        background: var(--primary-color);
        color: white;
        padding: 12px 15px;
        text-align: left;
        font-weight: 600;
    }

    .table-compte-emploi th:not(:first-child) {
        text-align: right;
    }

    .table-compte-emploi td {
        padding: 12px 15px;
        border-bottom: 1px solid #E5E7EB;
    }

    .table-compte-emploi td:not(:first-child) {
        text-align: right;
        font-family: 'Courier New', monospace;
    }

    .table-compte-emploi tr.row-entree {
        background: var(--success-light);
    }

    .table-compte-emploi tr.row-sortie {
        background: #FEF2F2;
    }

    .table-compte-emploi tr.row-total {
        background: var(--primary-light);
        font-weight: bold;
        font-size: 1.05rem;
    }

    .table-compte-emploi tr.row-total td {
        border-top: 2px solid var(--primary-color);
    }

    /* Tableaux de d√©tails */
    .table-details {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
    }

    .table-details th {
        padding: 10px 12px;
        font-weight: 600;
        border-bottom: 2px solid currentColor;
    }

    .table-details td {
        padding: 10px 12px;
        border-bottom: 1px solid #E5E7EB;
    }

    .table-details .num-serie {
        font-family: 'Courier New', monospace;
        background: #F3F4F6;
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 0.85rem;
    }

    .table-details tr.row-total {
        background: #F9FAFB;
        font-weight: 600;
    }

    /* Badge couleur */
    .badge-couleur {
        display: inline-block;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 500;
        background: #6B7280;
        color: white;
    }

    /* Badge date */
    .badge-date {
        display: inline-block;
        background: #FEF3C7;
        color: #92400E;
        padding: 3px 8px;
        border-radius: 4px;
        font-size: 0.8rem;
        font-weight: 500;
    }

    /* Section accord√©on */
    .accordion-section {
        border: 1px solid #E5E7EB;
        border-radius: 8px;
        margin-bottom: 15px;
        overflow: hidden;
    }

    .accordion-header {
        background: #F9FAFB;
        padding: 12px 20px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background 0.2s;
    }

    .accordion-header:hover {
        background: #F3F4F6;
    }

    .accordion-header h5 {
        margin: 0;
        font-size: 1rem;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .accordion-header .badge-count {
        background: var(--primary-color);
        color: white;
        padding: 2px 10px;
        border-radius: 20px;
        font-size: 0.8rem;
    }

    .accordion-icon {
        transition: transform 0.3s;
    }

    .accordion-header.collapsed .accordion-icon {
        transform: rotate(-90deg);
    }

    .accordion-content {
        padding: 0;
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease-out;
    }

    .accordion-content.show {
        max-height: 2000px;
        padding: 15px;
    }

    /* Observations */
    .observation-cell {
        max-width: 300px;
        font-size: 0.85rem;
        color: #6B7280;
    }

    /* Poste destination */
    .poste-badge {
        display: inline-block;
        background: #DBEAFE;
        color: #1E40AF;
        padding: 4px 10px;
        border-radius: 6px;
        font-size: 0.85rem;
        font-weight: 500;
    }

    /* Signature */
    .signature-section {
        margin-top: 40px;
        padding: 20px;
        text-align: right;
    }

    .signature-box {
        display: inline-block;
        text-align: center;
        min-width: 250px;
    }

    .signature-box .title {
        font-weight: 600;
        margin-bottom: 60px;
    }

    .signature-box .name {
        border-top: 1px solid #333;
        padding-top: 8px;
    }

    /* Actions */
    .actions-bar {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
        flex-wrap: wrap;
    }

    .btn-action {
        padding: 10px 20px;
        border-radius: 8px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 8px;
        text-decoration: none;
        transition: all 0.2s;
    }

    .btn-primary-custom {
        background: var(--primary-color);
        color: white;
        border: none;
    }

    .btn-primary-custom:hover {
        background: var(--primary-dark);
        color: white;
    }

    .btn-secondary-custom {
        background: #F3F4F6;
        color: #374151;
        border: 1px solid #D1D5DB;
    }

    .btn-secondary-custom:hover {
        background: #E5E7EB;
    }

    /* R√©sum√© rapide */
    .summary-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 25px;
    }

    .summary-card {
        background: white;
        border-radius: 10px;
        padding: 15px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
    }

    .summary-card .label {
        font-size: 0.85rem;
        color: #6B7280;
        margin-bottom: 5px;
    }

    .summary-card .value {
        font-size: 1.4rem;
        font-weight: 700;
        font-family: 'Courier New', monospace;
    }

    .summary-card.card-success {
        border-left: 4px solid var(--success-color);
    }

    .summary-card.card-warning {
        border-left: 4px solid var(--warning-color);
    }

    .summary-card.card-danger {
        border-left: 4px solid var(--danger-color);
    }

    .summary-card.card-primary {
        border-left: 4px solid var(--primary-color);
    }

    /* Ventes par semaine */
    .semaine-header {
        background: var(--danger-color);
        color: white;
        padding: 10px 15px;
        border-radius: 6px;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .semaine-detail {
        margin-left: 20px;
        margin-bottom: 15px;
    }

    /* Note Event Sourcing */
    .note-es {
        background: #F0FDF4;
        border: 1px solid #BBF7D0;
        border-radius: 8px;
        padding: 12px 15px;
        font-size: 0.85rem;
        color: #166534;
        margin-bottom: 20px;
    }

    .note-es.warning {
        background: #FEF3C7;
        border-color: #FCD34D;
        color: #92400E;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .summary-cards {
            grid-template-columns: 1fr 1fr;
        }
        
        .table-details {
            font-size: 0.8rem;
        }
        
        .table-details th,
        .table-details td {
            padding: 8px;
        }
    }

    @media print {
        .actions-bar {
            display: none;
        }
        
        .accordion-content {
            max-height: none !important;
            padding: 15px !important;
        }
        
        .header-section {
            background: #333 !important;
            -webkit-print-color-adjust: exact;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="compte-emploi-container">
    
    <!-- Actions -->
    <div class="actions-bar">
        <a href="{% url 'inventaire:selection_compte_emploi' %}" class="btn-action btn-secondary-custom">
            <i class="fas fa-arrow-left"></i> Retour
        </a>
        <button onclick="window.print()" class="btn-action btn-secondary-custom">
            <i class="fas fa-print"></i> Imprimer
        </button>
    </div>

    <!-- En-t√™te -->
    <div class="header-section">
        <div class="text-center">
            <h1>üìã COMPTE D'EMPLOI DES TICKETS DE P√âAGE</h1>
            <div class="subtitle"><strong>{{ poste.nom }}</strong> ({{ poste.code }})</div>
            <div class="periode">
                <i class="fas fa-calendar-alt"></i>
                P√©riode du {{ date_debut_obj|date:"d/m/Y" }} au {{ date_fin_obj|date:"d/m/Y" }}
                ({{ nombre_jours }} jour{{ nombre_jours|pluralize }})
            </div>
        </div>
    </div>

    <!-- Note Event Sourcing -->
    <div class="note-es {% if not coherence_ok %}warning{% endif %}">
        <i class="fas fa-{% if coherence_ok %}check-circle{% else %}exclamation-triangle{% endif %}"></i>
        <strong>Donn√©es calcul√©es via Event Sourcing</strong> | 
        Stock d√©but: {{ donnees.stock_debut.stocks|floatformat:0|intcomma }} FCFA | 
        Stock fin calcul√©: {{ donnees.stock_final_calcule|floatformat:0|intcomma }} FCFA
        {% if not coherence_ok %}
        <br><span style="color: #B45309;">‚ö†Ô∏è √âcart d√©tect√© avec le stock final du tableau</span>
        {% endif %}
    </div>

    <!-- R√©sum√© rapide -->
    <div class="summary-cards">
        <div class="summary-card card-primary">
            <div class="label">Stock de d√©but</div>
            <div class="value">{{ donnees.stock_debut.stocks|floatformat:0|intcomma }} FCFA</div>
            <small class="text-muted">{{ donnees.stock_debut.stocks_qte|intcomma }} tickets</small>
        </div>
        <div class="summary-card card-success">
            <div class="label">Approvisionnements</div>
            <div class="value">{{ donnees.approv_imprimerie.stocks|floatformat:0|intcomma }} FCFA</div>
            <small class="text-muted">{{ donnees.approv_imprimerie.stocks_qte|intcomma }} tickets</small>
        </div>
        <div class="summary-card card-warning">
            <div class="label">Transferts c√©d√©s</div>
            <div class="value">{{ donnees.reapprov_cede.stocks|floatformat:0|intcomma }} FCFA</div>
            <small class="text-muted">{{ donnees.reapprov_cede.stocks_qte|intcomma }} tickets</small>
        </div>
        <div class="summary-card card-danger">
            <div class="label">Ventes</div>
            <div class="value">{{ donnees.total.ventes|floatformat:0|intcomma }} FCFA</div>
        </div>
    </div>

    <!-- ================================================================ -->
    <!-- TABLEAU PRINCIPAL R√âCAPITULATIF - NOUVEAU FORMAT -->
    <!-- ================================================================ -->
    <div class="main-card">
        <div class="card-header-custom bg-primary">
            <i class="fas fa-table"></i>
            R√âCAPITULATIF DU COMPTE D'EMPLOI
        </div>
        <div class="card-body p-0">
            <table class="table-compte-emploi">
                <thead>
                    <tr>
                        <th style="width: 40%;">P√©riode: {{ date_debut_obj|date:"d/m/Y" }} - {{ date_fin_obj|date:"d/m/Y" }}</th>
                        <th style="width: 20%;">Stocks</th>
                        <th style="width: 20%;">Ventes</th>
                        <th style="width: 20%;">Stock Final</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Stock de d√©but -->
                    <tr class="row-entree">
                        <td>Stock de d√©but</td>
                        <td>{{ donnees.stock_debut.stocks|floatformat:0|intcomma }} FCFA</td>
                        <td>{{ donnees.stock_debut.ventes|floatformat:0|intcomma }} FCFA</td>
                        <td>{{ donnees.stock_debut.stock_final|floatformat:0|intcomma }} FCFA</td>
                    </tr>
                    
                    <!-- Approvisionnements Imprimerie -->
                    <tr class="row-entree">
                        <td>Approv. (Imprimerie Nationale)</td>
                        <td>{{ donnees.approv_imprimerie.stocks|floatformat:0|intcomma }} FCFA</td>
                        <td>{{ donnees.approv_imprimerie.ventes|floatformat:0|intcomma }} FCFA</td>
                        <td>{{ donnees.approv_imprimerie.stock_final|floatformat:0|intcomma }} FCFA</td>
                    </tr>
                    
                    <!-- Transferts re√ßus -->
                    <tr class="row-entree">
                        <td>(+) R√©approv. re√ßu (Transferts)</td>
                        <td>{{ donnees.reapprov_recu.stocks|floatformat:0|intcomma }} FCFA</td>
                        <td>{{ donnees.reapprov_recu.ventes|floatformat:0|intcomma }} FCFA</td>
                        <td>{{ donnees.reapprov_recu.stock_final|floatformat:0|intcomma }} FCFA</td>
                    </tr>
                    
                    <!-- Transferts c√©d√©s -->
                    <tr class="row-sortie">
                        <td>(-) R√©approv. c√©d√© (Transferts)</td>
                        <td>{{ donnees.reapprov_cede.stocks|floatformat:0|intcomma }} FCFA</td>
                        <td>/</td>
                        <td>{{ donnees.reapprov_cede.stock_final|floatformat:0|intcomma }} FCFA</td>
                    </tr>
                    
                    <!-- Total -->
                    <tr class="row-total">
                        <td><strong>TOTAL</strong></td>
                        <td><strong>{{ donnees.total.stocks|floatformat:0|intcomma }} FCFA</strong></td>
                        <td><strong>{{ donnees.total.ventes|floatformat:0|intcomma }} FCFA</strong></td>
                        <td><strong>{{ donnees.total.stock_final|floatformat:0|intcomma }} FCFA</strong></td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- ================================================================ -->
    <!-- D√âTAIL DES APPROVISIONNEMENTS - IMPRIMERIE NATIONALE -->
    <!-- ================================================================ -->
    {% if donnees.approv_imprimerie.details %}
    <div class="main-card">
        <div class="card-header-custom bg-success" onclick="toggleAccordion(this)" style="cursor: pointer;">
            <span>
                <i class="fas fa-boxes"></i>
                APPROVISIONNEMENTS - IMPRIMERIE NATIONALE
                <span class="badge-count">--{{ donnees.approv_imprimerie.details|length }} op√©ration(s)</span>
            </span>
            <i class="fas fa-chevron-down accordion-icon"></i>
        </div>
        <div class="accordion-content show">
            <table class="table-details">
                <thead style="color: #166534;">
                    <tr>
                        <th>Date</th>
                        <th>Couleur</th>
                        <th>N¬∞ S√©rie</th>
                        <th style="text-align: right;">Tickets</th>
                        <th style="text-align: right;">Montant</th>
                    </tr>
                </thead>
                <tbody>
                    {% for detail in donnees.approv_imprimerie.details %}
                        {% if detail.series %}
                            {% for serie in detail.series %}
                            <tr>
                                {% if forloop.first %}
                                <td rowspan="{{ detail.series|length }}">{{ detail.date|date:"d/m/Y H:i" }}</td>
                                {% endif %}
                                <td>
                                    <span class="badge-couleur">{{ serie.couleur_nom|default:"-" }}</span>
                                </td>
                                <td>
                                    <span class="num-serie">#{{ serie.numero_premier|default:"-" }} - #{{ serie.numero_dernier|default:"-" }}</span>
                                </td>
                                <td style="text-align: right;">{{ serie.nombre_tickets|intcomma }}</td>
                                <td style="text-align: right;">{{ serie.valeur|floatformat:0|intcomma }} FCFA</td>
                            </tr>
                            {% endfor %}
                        {% else %}
                        <tr>
                            <td>{{ detail.date|date:"d/m/Y H:i" }}</td>
                            <td>-</td>
                            <td>-</td>
                            <td style="text-align: right;">{{ detail.nombre_tickets|intcomma }}</td>
                            <td style="text-align: right;">{{ detail.montant|floatformat:0|intcomma }} FCFA</td>
                            <td class="observation-cell">{{ detail.observation|default:"-"|truncatechars:80 }}</td>
                        </tr>
                        {% endif %}
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr class="row-total" style="background: #DCFCE7;">
                        <td colspan="3"><strong>TOTAL APPROVISIONNEMENTS</strong></td>
                        <td style="text-align: right;"><strong>{{ donnees.approv_imprimerie.stocks_qte|intcomma }} tickets</strong></td>
                        <td style="text-align: right;"><strong>{{ donnees.approv_imprimerie.stocks|floatformat:0|intcomma }} FCFA</strong></td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- ================================================================ -->
    <!-- D√âTAIL DES TRANSFERTS RE√áUS -->
    <!-- ================================================================ -->
    {% if donnees.reapprov_recu.details %}
    <div class="main-card">
        <div class="card-header-custom bg-info" onclick="toggleAccordion(this)" style="cursor: pointer;">
            <span>
                <i class="fas fa-arrow-down"></i>
                TRANSFERTS RE√áUS
                <span class="badge-count">--{{ donnees.reapprov_recu.details|length }} op√©ration(s)</span>
            </span>
            <i class="fas fa-chevron-down accordion-icon"></i>
        </div>
        <div class="accordion-content show">
            <table class="table-details">
                <thead style="color: #0E7490;">
                    <tr>
                        <th>Date</th>
                        <th>Poste Origine</th>
                        <th>Couleur</th>
                        <th>N¬∞ S√©rie</th>
                        <th style="text-align: right;">Tickets</th>
                        <th style="text-align: right;">Montant</th>
                    </tr>
                </thead>
                <tbody>
                    {% for detail in donnees.reapprov_recu.details %}
                        {% if detail.series %}
                            {% for serie in detail.series %}
                            <tr>
                                {% if forloop.first %}
                                <td rowspan="{{ detail.series|length }}">{{ detail.date|date:"d/m/Y" }}</td>
                                <td rowspan="{{ detail.series|length }}">
                                    {% if detail.poste_origine %}
                                    <span class="poste-badge">{{ detail.poste_origine.nom }}</span>
                                    {% else %}
                                    -
                                    {% endif %}
                                </td>
                                {% endif %}
                                <td><span class="badge-couleur">{{ serie.couleur_nom|default:"-" }}</span></td>
                                <td><span class="num-serie">#{{ serie.numero_premier|default:"-" }} - #{{ serie.numero_dernier|default:"-" }}</span></td>
                                <td style="text-align: right;">{{ serie.nombre_tickets|intcomma }}</td>
                                <td style="text-align: right;">{{ serie.valeur|floatformat:0|intcomma }} FCFA</td>
                            </tr>
                            {% endfor %}
                        {% else %}
                        <tr>
                            <td>{{ detail.date|date:"d/m/Y" }}</td>
                            <td>
                                {% if detail.poste_origine %}
                                <span class="poste-badge">{{ detail.poste_origine.nom }}</span>
                                {% else %}
                                -
                                {% endif %}
                            </td>
                            <td>-</td>
                            <td>-</td>
                            <td style="text-align: right;">{{ detail.nombre_tickets|intcomma }}</td>
                            <td style="text-align: right;">{{ detail.montant|floatformat:0|intcomma }} FCFA</td>
                        </tr>
                        {% endif %}
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr class="row-total" style="background: #CFFAFE;">
                        <td colspan="4"><strong>TOTAL RE√áU</strong></td>
                        <td style="text-align: right;"><strong>{{ donnees.reapprov_recu.stocks_qte|intcomma }} tickets</strong></td>
                        <td style="text-align: right;"><strong>{{ donnees.reapprov_recu.stocks|floatformat:0|intcomma }} FCFA</strong></td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- ================================================================ -->
    <!-- D√âTAIL DES TRANSFERTS C√âD√âS -->
    <!-- ================================================================ -->
    {% if donnees.reapprov_cede.details %}
    <div class="main-card">
        <div class="card-header-custom bg-warning" onclick="toggleAccordion(this)" style="cursor: pointer;">
            <span>
                <i class="fas fa-arrow-up"></i>
                TRANSFERTS C√âD√âS
                <span class="badge-count">--{{ donnees.reapprov_cede.details|length }} op√©ration(s)</span>
            </span>
            <i class="fas fa-chevron-down accordion-icon"></i>
        </div>
        <div class="accordion-content show">
            <table class="table-details">
                <thead style="color: #9A3412;">
                    <tr>
                        <th>Date</th>
                        <th>Poste Destination</th>
                        <th>Couleur</th>
                        <th>N¬∞ S√©rie</th>
                        <th style="text-align: right;">Tickets</th>
                        <th style="text-align: right;">Montant</th>
                    </tr>
                </thead>
                <tbody>
                    {% for detail in donnees.reapprov_cede.details %}
                        {% if detail.series %}
                            {% for serie in detail.series %}
                            <tr>
                                {% if forloop.first %}
                                <td rowspan="{{ detail.series|length }}">{{ detail.date|date:"d/m/Y" }}</td>
                                <td rowspan="{{ detail.series|length }}">
                                    {% if detail.poste_destination %}
                                    <span class="poste-badge">{{ detail.poste_destination.nom }}</span>
                                    {% else %}
                                    -
                                    {% endif %}
                                </td>
                                {% endif %}
                                <td><span class="badge-couleur">{{ serie.couleur_nom|default:"-" }}</span></td>
                                <td><span class="num-serie">#{{ serie.numero_premier|default:"-" }} - #{{ serie.numero_dernier|default:"-" }}</span></td>
                                <td style="text-align: right;">{{ serie.nombre_tickets|intcomma }}</td>
                                <td style="text-align: right;">{{ serie.valeur|floatformat:0|intcomma }} FCFA</td>
                            </tr>
                            {% endfor %}
                        {% else %}
                        <tr>
                            <td>{{ detail.date|date:"d/m/Y" }}</td>
                            <td>
                                {% if detail.poste_destination %}
                                <span class="poste-badge">{{ detail.poste_destination.nom }}</span>
                                {% else %}
                                -
                                {% endif %}
                            </td>
                            <td>-</td>
                            <td>-</td>
                            <td style="text-align: right;">{{ detail.nombre_tickets|intcomma }}</td>
                            <td style="text-align: right;">{{ detail.montant|floatformat:0|intcomma }} FCFA</td>
                        </tr>
                        {% endif %}
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr class="row-total" style="background: #FED7AA;">
                        <td colspan="4"><strong>TOTAL C√âD√â</strong></td>
                        <td style="text-align: right;"><strong>{{ donnees.reapprov_cede.stocks_qte|intcomma }} tickets</strong></td>
                        <td style="text-align: right;"><strong>{{ donnees.reapprov_cede.stocks|floatformat:0|intcomma }} FCFA</strong></td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- ================================================================ -->
    <!-- D√âTAIL DES VENTES PAR SEMAINE - AVEC DATES INDIVIDUELLES -->
    <!-- ================================================================ -->
    {% if donnees.ventes_par_semaine %}
    <div class="main-card">
        <div class="card-header-custom bg-danger" onclick="toggleAccordion(this)" style="cursor: pointer;">
            <span>
                <i class="fas fa-shopping-cart"></i>
                VENTES PAR SEMAINE
                <span class="badge-count">--{{ donnees.ventes_par_semaine|length }} semaine(s)</span>
            </span>
            <i class="fas fa-chevron-down accordion-icon"></i>
        </div>
        <div class="accordion-content show">
            {% for semaine_key, semaine_data in donnees.ventes_par_semaine.items %}
            <div class="mb-4">
                <div class="semaine-header">
                    <span>
                        <i class="fas fa-calendar-week"></i>
                        SEMAINE DU {{ semaine_key }}
                    </span>
                    <span>
                        {{ semaine_data.total_tickets|intcomma }} tickets | 
                        {{ semaine_data.total_valeur|floatformat:0|intcomma }} FCFA
                    </span>
                </div>
                
                {% if semaine_data.series_vendues %}
                <div class="semaine-detail">
                    <table class="table-details">
                        <thead style="color: #991B1B;">
                            <tr>
                                <th style="width: 100px;">Date</th>
                                <th>Couleur</th>
                                <th>N¬∞ S√©rie</th>
                                <th style="text-align: right;">Tickets</th>
                                <th style="text-align: right;">Montant</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for serie in semaine_data.series_vendues %}
                            <tr>
                                <td>
                                    {% if serie.date_vente %}
                                    <span class="badge-date">{{ serie.date_vente|date:"d/m/Y" }}</span>
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td><span class="badge-couleur">{{ serie.couleur_nom|default:"Inconnu" }}</span></td>
                                <td>
                                    <span class="num-serie">
                                        #{{ serie.numero_premier|default:"-" }} ‚Üí #{{ serie.numero_dernier|default:"-" }}
                                    </span>
                                </td>
                                <td style="text-align: right;">{{ serie.nombre_tickets|intcomma }}</td>
                                <td style="text-align: right;">{{ serie.valeur|floatformat:0|intcomma }} FCFA</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr class="row-total" style="background: #FEE2E2;">
                                <td colspan="3"><strong>Total semaine</strong></td>
                                <td style="text-align: right;"><strong>{{ semaine_data.total_tickets|intcomma }}</strong></td>
                                <td style="text-align: right;"><strong>{{ semaine_data.total_valeur|floatformat:0|intcomma }} FCFA</strong></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                {% else %}
                <div class="semaine-detail">
                    <p class="text-muted"><em>D√©tails des s√©ries non disponibles</em></p>
                </div>
                {% endif %}
            </div>
            {% endfor %}
            
            <!-- Total g√©n√©ral des ventes -->
            <div class="row-total" style="background: #FEE2E2; padding: 12px 15px; border-radius: 6px;">
                <strong>TOTAL G√âN√âRAL DES VENTES :</strong>
                <span style="float: right;">
                    <strong>{{ donnees.total.ventes|floatformat:0|intcomma }} FCFA</strong>
                </span>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- ================================================================ -->
    <!-- V√âRIFICATION DE COH√âRENCE -->
    <!-- ================================================================ -->
    <div class="main-card">
        <div class="card-header-custom" style="background: {% if coherence_ok %}#10B981{% else %}#EF4444{% endif %}; color: white;">
            <i class="fas fa-{% if coherence_ok %}check-circle{% else %}exclamation-triangle{% endif %}"></i>
            V√âRIFICATION DE COH√âRENCE
        </div>
        <div class="card-body" style="padding: 20px;">
            <table class="table-details" style="max-width: 600px;">
                <tr>
                    <td><strong>Stock final (tableau)</strong></td>
                    <td style="text-align: right;">{{ donnees.total.stock_final|floatformat:0|intcomma }} FCFA</td>
                </tr>
                <tr>
                    <td><strong>Stock final (Event Sourcing)</strong></td>
                    <td style="text-align: right;">{{ donnees.stock_final_calcule|floatformat:0|intcomma }} FCFA</td>
                </tr>
                <tr>
                    <td><strong>Nombre de tickets en stock</strong></td>
                    <td style="text-align: right;">{{ donnees.stock_final_qte|intcomma }} tickets</td>
                </tr>
                <tr class="{% if coherence_ok %}row-total{% endif %}" style="{% if not coherence_ok %}background: #FEE2E2;{% endif %}">
                    <td><strong>Statut</strong></td>
                    <td style="text-align: right;">
                        {% if coherence_ok %}
                        <span style="color: #10B981;"><i class="fas fa-check"></i> Coh√©rent</span>
                        {% else %}
                        <span style="color: #EF4444;"><i class="fas fa-times"></i> √âcart d√©tect√©</span>
                        {% endif %}
                    </td>
                </tr>
            </table>
        </div>
    </div>

    <!-- ================================================================ -->
    <!-- SIGNATURE DU CHEF DE POSTE -->
    <!-- ================================================================ -->
    <div class="signature-section">
        
        <div>Date __________________</div>
        <br><br>
        
        <div class="signature-box">
            <div class="title">Le Chef de Poste</div>
            <div class="name">
                ________________________
            </div>
        </div>
    </div>

    <!-- Pied de page -->
    <div class="text-center text-muted mt-4" style="font-size: 0.85rem;">
        <p>
           <strong> Document g√©n√©r√© le {% now "d/m/Y √† H:i" %} | </strong>
            SUPPER - Suivi des P√©ages et Pesages Routiers
        </p>
    </div>

</div>

<script>
function toggleAccordion(header) {
    const content = header.nextElementSibling;
    const icon = header.querySelector('.accordion-icon');
    
    if (content.classList.contains('show')) {
        content.classList.remove('show');
        header.classList.add('collapsed');
    } else {
        content.classList.add('show');
        header.classList.remove('collapsed');
    }
}

// Au chargement, s'assurer que les accord√©ons sont ouverts par d√©faut
document.addEventListener('DOMContentLoaded', function() {
    const accordions = document.querySelectorAll('.accordion-content.show');
    accordions.forEach(function(accordion) {
        accordion.style.maxHeight = accordion.scrollHeight + "px";
    });
});
</script>
{% endblock %}