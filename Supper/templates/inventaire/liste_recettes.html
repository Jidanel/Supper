{% extends "admin/base_site.html" %}
{% load static i18n %}

{% block title %}{% trans "Liste des Recettes" %} - SUPPER{% endblock %}

{% block extra_css %}
<style>
    .filter-section {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }
    
    .stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 12px;
        text-align: center;
    }
    
    .stat-value {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }
    
    .stat-label {
        font-size: 0.9rem;
        opacity: 0.9;
    }
    
    .recette-table {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    
    .recette-table thead {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    
    .recette-table th {
        padding: 1rem;
        font-weight: 600;
        border: none;
    }
    
    .recette-table td {
        padding: 1rem;
        vertical-align: middle;
        border-bottom: 1px solid #f3f4f6;
    }
    
    .recette-table tbody tr:hover {
        background: #f9fafb;
    }
    
    .badge-taux {
        padding: 0.4rem 0.8rem;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.85rem;
    }
    
    .badge-bon {
        background: #d4edda;
        color: #155724;
    }
   
    
    .badge-moyen {
        background: #fff3cd;
        color: #856404;
    }
    
    .badge-mauvais {
        background: #f8d7da;
        color: #721c24;
    }
    
    .action-buttons {
        display: flex;
        gap: 0.5rem;
    }
    
    .btn-action {
        padding: 0.4rem 0.8rem;
        border-radius: 6px;
        font-size: 0.85rem;
        border: none;
        transition: all 0.2s;
    }
    
    .btn-view {
        background: #e0e7ff;
        color: #3730a3;
    }
    
    .btn-edit {
        background: #fef3c7;
        color: #92400e;
    }
    
    .btn-delete {
        background: #fee2e2;
        color: #991b1b;
    }
    
    .btn-action:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .filter-row {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        align-items: end;
    }
    
    .filter-group {
        flex: 1;
        min-width: 200px;
    }
    
    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        color: #6b7280;
    }
    
    .empty-state-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
        color: #9ca3af;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- En-tête -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-0">
                <i class="fas fa-coins me-2" style="color: #764ba2;"></i>
                {% trans "Liste des Recettes" %}
            </h2>
            <p class="text-muted mt-2">
                {% trans "Gestion et suivi des recettes journalières avec taux de déperdition" %}
            </p>
        </div>
        <div>
            {% if user.is_chef_poste or user.is_admin %}
            <a href="{% url 'inventaire:saisie_recette' %}" class="btn btn-primary">
                <i class="fas fa-plus me-2"></i>
                {% trans "Nouvelle Recette" %}
            </a>
            {% endif %}
        </div>
    </div>

    <!-- Statistiques -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value">{{ stats.total_recettes|default:0 }}</div>
            <div class="stat-label">{% trans "Total Recettes" %}</div>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
            <div class="stat-value">{{ stats.total_montant|floatformat:0|default:"0" }} FCFA</div>
            <div class="stat-label">{% trans "Montant Total (FCFA)" %}</div>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
            <div class="stat-value">
                {% if stats.moyenne_taux != None %}
                                            {{ stats.moyenne_taux|floatformat:2 }}%
                                        {% else %}
                                            N/A
                                        {% endif %}
                </div>
            <div class="stat-label">{% trans "Taux Moyen" %}</div>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
            <div class="stat-value">{{ stats.recettes_jour|default:0 }}</div>
            <div class="stat-label">{% trans "Aujourd'hui" %}</div>
        </div>
    </div>

    <!-- Section Filtres -->
    <div class="filter-section">
        <h5 class="mb-3">
            <i class="fas fa-filter me-2"></i>
            {% trans "Filtres" %}
        </h5>
        
        <form method="get" id="filterForm">
            <div class="filter-row">
                <!-- Filtre Poste -->
                <div class="filter-group">
                    <label class="form-label">{% trans "Poste" %}</label>
                    <select name="poste" class="form-select">
                        <option value="">{% trans "Tous les postes" %}</option>
                        {% for poste in postes %}
                        <option value="{{ poste.id }}" {% if current_filters.poste == poste.id|stringformat:"s" %}selected{% endif %}>
                            {{ poste.nom }} ({{ poste.code }})
                        </option>
                        {% endfor %}
                    </select>
                </div>

                <!-- Filtre Période -->
                <div class="filter-group">
                    <label class="form-label">{% trans "Période" %}</label>
                    <select name="periode" class="form-select" id="periodeSelect">
                        <option value="all" {% if current_filters.periode == 'all' or not current_filters.periode %}selected{% endif %}>
                            {% trans "Toutes les périodes" %}
                        </option>
                        <option value="jour" {% if current_filters.periode == 'jour' %}selected{% endif %}>
                            {% trans "Par jour" %}
                        </option>
                        <option value="semaine" {% if current_filters.periode == 'semaine' %}selected{% endif %}>
                            {% trans "Cette semaine" %}
                        </option>
                        <option value="mois" {% if current_filters.periode == 'mois' %}selected{% endif %}>
                            {% trans "Par mois" %}
                        </option>
                    </select>
                </div>

                <!-- Sélection Date (pour jour) -->
                <div class="filter-group" id="dateGroup" style="display: none;">
                    <label class="form-label">{% trans "Date" %}</label>
                    <input type="date" name="date" class="form-control" value="{{ current_filters.date }}">
                </div>

                <!-- Sélection Mois -->
                <div class="filter-group" id="moisGroup" style="display: none;">
                    <label class="form-label">{% trans "Mois" %}</label>
                    <select name="mois" class="form-select">
                        {% for mois in mois_disponibles %}
                        <option value="{{ mois.mois }}" data-annee="{{ mois.annee }}"
                                {% if current_filters.mois == mois.mois|stringformat:"s" and current_filters.annee == mois.annee|stringformat:"s" %}selected{% endif %}>
                            {{ mois.label }}
                        </option>
                        {% endfor %}
                    </select>
                    <input type="hidden" name="annee" id="anneeInput" value="{{ current_filters.annee }}">
                </div>

                <!-- Filtre Taux -->
                <div class="filter-group">
                    <label class="form-label">{% trans "Taux déperdition" %}</label>
                    <select name="taux_filtre" class="form-select">
                        <option value="">{% trans "Tous" %}</option>
                        <option value="bon" {% if current_filters.taux_filtre == 'bon' %}selected{% endif %}>
                            {% trans "Bon (> -10%)" %}
                        </option>
                        <option value="moyen" {% if current_filters.taux_filtre == 'moyen' %}selected{% endif %}>
                            {% trans "Moyen (-10% à -30%)" %}
                        </option>
                        <option value="mauvais" {% if current_filters.taux_filtre == 'mauvais' %}selected{% endif %}>
                            {% trans "Mauvais (< -30%)" %}
                        </option>
                    </select>
                </div>

                <!-- Recherche -->
                <div class="filter-group">
                    <label class="form-label">{% trans "Rechercher" %}</label>
                    <input type="text" name="search" class="form-control" 
                           placeholder="{% trans 'Poste, code...' %}" 
                           value="{{ current_filters.search }}">
                </div>

                <!-- Boutons -->
                <div class="filter-group">
                    <label class="form-label">&nbsp;</label>
                    <div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-search me-1"></i>
                            {% trans "Filtrer" %}
                        </button>
                        <a href="{% url 'inventaire:liste_recettes' %}" class="btn btn-secondary">
                            <i class="fas fa-redo me-1"></i>
                            {% trans "Réinitialiser" %}
                        </a>
                    </div>
                </div>
            </div>
        </form>
    </div>

    <!-- Tableau des recettes -->
    {% if recettes %}
    <div class="recette-table">
        <table class="table mb-0">
            <thead>
                <tr>
                    <th>{% trans "Date" %}</th>
                    <th>{% trans "Poste" %}</th>
                    <th>{% trans "Montant Déclaré" %}</th>
                    {% if user.voir_recettes_potentielles %}
                    <th>{% trans "Recette Potentielle" %}</th>
                    {% endif %}
                    {% if user.voir_taux_deperdition %}
                    <th>{% trans "Taux Déperdition" %}</th>
                    {% endif %}
                    <th>{% trans "Chef de Poste" %}</th>
                    <th>{% trans "Actions" %}</th>
                </tr>
            </thead>
            <tbody>
                {% for recette in recettes %}
                <tr>
                    <td>
                        <strong>{{ recette.date|date:"d/m/Y" }}</strong>
                        <br>
                        <small class="text-muted">{{ recette.date|date:"l" }}</small>
                    </td>
                    <td>
                        <strong>{{ recette.poste.nom }}</strong>
                        <br>
                        <small class="text-muted">{{ recette.poste.code }}</small>
                    </td>
                    <td>
                        <strong class="text-success">{% if recette.montant_declare != None %}
                                            {{ recette.montant_declare|floatformat:0 }} FCFA
                                        {% else %}
                                            -
                                        {% endif %}</strong>
                    </td>
                    {% if user.voir_recettes_potentielles %}
                    <td>
                        {% if recette.recette_potentielle %}
                        {{ recette.recette_potentielle|floatformat:0 }} FCFA
                        {% else %}
                        <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    {% endif %}
                    {% if user.voir_taux_deperdition %}
                    <td>
                        {% if recette.taux_deperdition != None %}
                            <span class="badge bg-{{ recette.get_couleur_alerte }}">
                                                {{ recette.taux_deperdition|floatformat:2 }}% - Statut : {{recette.get_statut_deperdition }}
                                        </span>
                                        {% else %}
                                            <span class="badge bg-secondary">N/A</span>
                                        {% endif %}
                    </td>
                    
                    {% endif %}
                    <td>
                        {{ recette.chef_poste.nom_complet }}
                    </td>
                    <td>
                        <div class="action-buttons">
                            <a href="{% url 'inventaire:recette_detail' recette.pk %}" 
                               class="btn-action btn-view" title="{% trans 'Voir' %}">
                                <i class="fas fa-eye"></i>
                            </a>
                            {% if user.is_admin %}
                            <a href="{% url 'inventaire:modifier_recette' recette.pk %}" 
                               class="btn-action btn-edit" title="{% trans 'Modifier' %}">
                                <i class="fas fa-edit"></i>
                            </a>
                            <button onclick="supprimerRecette({{ recette.pk }})" 
                                    class="btn-action btn-delete" title="{% trans 'Supprimer' %}">
                                <i class="fas fa-trash"></i>
                            </button>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    {% if is_paginated %}
    <nav class="mt-4">
        <ul class="pagination justify-content-center">
            {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page=1{% for key, value in current_filters.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                    {% trans "Début" %}
                </a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% for key, value in current_filters.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                    {% trans "Précédent" %}
                </a>
            </li>
            {% endif %}
            
            <li class="page-item active">
                <span class="page-link">
                    Page {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}
                </span>
            </li>
            
            {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}{% for key, value in current_filters.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                    {% trans "Suivant" %}
                </a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}{% for key, value in current_filters.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                    {% trans "Fin" %}
                </a>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}

    {% else %}
    <!-- État vide -->
    <div class="empty-state">
        <i class="fas fa-inbox empty-state-icon"></i>
        <h4>{% trans "Aucune recette trouvée" %}</h4>
        <p>{% trans "Aucune recette ne correspond aux filtres sélectionnés" %}</p>
        {% if user.is_chef_poste or user.is_admin %}
        <a href="{% url 'inventaire:saisie_recette' %}" class="btn btn-primary mt-3">
            <i class="fas fa-plus me-2"></i>
            {% trans "Saisir une recette" %}
        </a>
        {% endif %}
    </div>
    {% endif %}
</div>

<script>
// Gestion des filtres dynamiques
document.addEventListener('DOMContentLoaded', function() {
    const periodeSelect = document.getElementById('periodeSelect');
    const dateGroup = document.getElementById('dateGroup');
    const moisGroup = document.getElementById('moisGroup');
    
    function togglePeriodeFields() {
        const value = periodeSelect.value;
        dateGroup.style.display = value === 'jour' ? 'block' : 'none';
        moisGroup.style.display = value === 'mois' ? 'block' : 'none';
    }
    
    periodeSelect.addEventListener('change', togglePeriodeFields);
    togglePeriodeFields();
    
    // Gestion sélection mois/année
    const moisSelect = document.querySelector('select[name="mois"]');
    if (moisSelect) {
        moisSelect.addEventListener('change', function() {
            const selected = this.options[this.selectedIndex];
            document.getElementById('anneeInput').value = selected.dataset.annee;
        });
    }
});

// Fonction suppression
function supprimerRecette(id) {
    if (confirm("{% trans 'Êtes-vous sûr de vouloir supprimer cette recette ?' %}")) {
        // Créer un formulaire POST pour la suppression
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/inventaire/recettes/${id}/supprimer/`;
        
        const csrfToken = document.createElement('input');
        csrfToken.type = 'hidden';
        csrfToken.name = 'csrfmiddlewaretoken';
        csrfToken.value = '{{ csrf_token }}';
        
        form.appendChild(csrfToken);
        document.body.appendChild(form);
        form.submit();
    }
}
</script>
{% endblock %}