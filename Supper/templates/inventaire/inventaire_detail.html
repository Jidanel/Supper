{% extends "admin/base_site.html" %}
{% load static %}
{% load i18n %}
{% load inventaire_extras %}

{% block title %}{% trans "Inventaire" %} {{ inventaire.poste.nom }} - {{ inventaire.date|date:"d/m/Y" }} - SUPPER{% endblock %}

{% block extra_css %}
<style>
:root {
    --violet-principal: #0000FF;
    --violet-fonce: #00008B;
    --gris-clair: #F8FAFC;
    --gris-moyen: #64748B;
    --gris-fonce: #334155;
    --accent-orange: #F59E0B;
}

.detail-header {
    background: linear-gradient(135deg, var(--violet-principal), var(--violet-fonce));
    color: white;
    padding: 2rem 0;
    margin-bottom: 2rem;
}

.info-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    padding: 1.5rem;
    margin-bottom: 1.5rem;
}

.metric-card {
    background: linear-gradient(135deg, #F8FAFC, #E2E8F0);
    border-radius: 12px;
    padding: 1.5rem;
    text-align: center;
    transition: all 0.3s ease;
    border-left: 4px solid var(--violet-principal);
}

.metric-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
}

.metric-value {
    font-size: 2rem;
    font-weight: bold;
    color: var(--violet-principal);
    margin-bottom: 0.5rem;
}

.metric-label {
    color: var(--gris-moyen);
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.periode-card {
    background: white;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 0.5rem;
    border-left: 4px solid #E5E7EB;
    transition: all 0.3s ease;
}

.periode-card:hover {
    border-left-color: var(--violet-principal);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.periode-header {
    font-weight: 600;
    color: var(--violet-principal);
    margin-bottom: 0.5rem;
}

.vehicule-count {
    font-size: 1.5rem;
    font-weight: bold;
    color: var(--gris-fonce);
}

.status-badge {
    border-radius: 20px;
    padding: 0.5rem 1rem;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
}

.status-en-cours {
    background: linear-gradient(45deg, #3B82F6, #2563EB);
    color: white;
}

.status-verrouille {
    background: linear-gradient(45deg, #F59E0B, #F97316);
    color: white;
}

.status-valide {
    background: linear-gradient(45deg, #10B981, #059669);
    color: white;
}

.chart-container {
    background: white;
    border-radius: 12px;
    padding: 2rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.btn-violet {
    background: linear-gradient(45deg, var(--violet-principal), var(--violet-fonce));
    border: none;
    color: white;
    border-radius: 8px;
    padding: 0.75rem 1.5rem;
    transition: all 0.3s ease;
}

.btn-violet:hover {
    background: linear-gradient(45deg, var(--violet-fonce), #4C1D95);
    color: white;
    transform: translateY(-1px);
}

.timeline-item {
    position: relative;
    padding-left: 2rem;
    padding-bottom: 1rem;
}

.timeline-item::before {
    content: '';
    position: absolute;
    left: 0.5rem;
    top: 0.5rem;
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: var(--violet-principal);
}

.timeline-item::after {
    content: '';
    position: absolute;
    left: 0.75rem;
    top: 1.5rem;
    width: 2px;
    height: calc(100% - 1rem);
    background: #E5E7EB;
}

.timeline-item:last-child::after {
    display: none;
}

.recette-card {
    background: linear-gradient(135deg, #FEF3C7, #FDE68A);
    border-radius: 12px;
    padding: 1.5rem;
    border-left: 4px solid var(--accent-orange);
}

.recette-value {
    font-size: 1.5rem;
    font-weight: bold;
    color: #92400E;
}
</style>
{% endblock %}

{% block content %}
<div class="detail-header">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-8">
                <nav aria-label="breadcrumb" class="mb-3">
                    <ol class="breadcrumb text-white-50">
                        <li class="breadcrumb-item">
                            <a href="{% url 'inventaire:inventaire_list' %}" class="text-white-50">
                                {% trans "Inventaires" %}
                            </a>
                        </li>
                        <li class="breadcrumb-item active text-white">
                            {{ inventaire.poste.nom }} - {{ inventaire.date|date:"d/m/Y" }}
                        </li>
                    </ol>
                </nav>
                <h1 class="mb-2">
                    <i class="fas fa-clipboard-list me-3"></i>
                    {% trans "Inventaire Journalier" %}
                </h1>
                <p class="mb-0 opacity-75">
                    {{ inventaire.poste.nom }} - {{ inventaire.date|date:"l d F Y" }}
                </p>
            </div>
            <div class="col-md-4 text-end">
                {% if can_edit %}
                <a href="{% url 'inventaire:saisie_inventaire' %}?poste={{ inventaire.poste.id }}&date={{ inventaire.date|date:'Y-m-d' }}" 
                   class="btn btn-light btn-lg me-2">
                    <i class="fas fa-edit me-2"></i>{% trans "Modifier" %}
                </a>
                {% endif %}
                {% comment %} {% if can_lock %}
                <button class="btn btn-warning btn-lg" onclick="verrouillerInventaire()">
                    <i class="fas fa-lock me-2"></i>{% trans "Verrouiller" %}
                </button>
                {% endif %}
                {% if can_validate %}
                <button class="btn btn-success btn-lg" onclick="validerInventaire()">
                    <i class="fas fa-check me-2"></i>{% trans "Valider" %}
                </button>
                {% endif %} {% endcomment %}
            </div>
        </div>
    </div>
</div>

<div class="container-fluid">
    <div class="row">
        <!-- Informations générales -->
        <div class="col-lg-4">
            <div class="info-card">
                <h5 class="card-title text-violet mb-3">
                    <i class="fas fa-info-circle me-2"></i>{% trans "Informations Générales" %}
                </h5>
                
                <div class="mb-3">
                    <strong>{% trans "Poste:" %}</strong>
                    <div>{{ inventaire.poste.nom }}</div>
                    <small class="text-muted">{{ inventaire.poste.code }} - {{ inventaire.poste.get_region_display }}</small>
                </div>

                <div class="mb-3">
                    <strong>{% trans "Date:" %}</strong>
                    <div>{{ inventaire.date|date:"l d F Y" }}</div>
                </div>

                <div class="mb-3">
                    <strong>{% trans "Agent de saisie:" %}</strong>
                    {% if inventaire.agent_saisie %}
                    <div>{{ inventaire.agent_saisie.nom_complet }}</div>
                    <small class="text-muted">{{ inventaire.agent_saisie.username }}</small>
                    {% else %}
                    <div class="text-muted">{% trans "Non défini" %}</div>
                    {% endif %}
                </div>

                <div class="mb-3">
                    <strong>{% trans "Statut:" %}</strong>
                    <div class="mt-2">
                        {% if inventaire.valide %}
                            <span class="status-badge status-valide">
                                <i class="fas fa-check-circle"></i>{% trans "Validé" %}
                            </span>
                        {% elif inventaire.verrouille %}
                            <span class="status-badge status-verrouille">
                                <i class="fas fa-lock"></i>{% trans "Verrouillé" %}
                            </span>
                        {% else %}
                            <span class="status-badge status-en-cours">
                                <i class="fas fa-edit"></i>{% trans "En cours" %}
                            </span>
                        {% endif %}
                    </div>
                </div>

                {% if inventaire.observations %}
                <div class="mb-3">
                    <strong>{% trans "Observations:" %}</strong>
                    <div class="mt-1">{{ inventaire.observations }}</div>
                </div>
                {% endif %}

                <hr>

                <!-- Timeline des actions -->
                <h6 class="text-violet mb-3">{% trans "Historique" %}</h6>
                <div class="timeline">
                    <div class="timeline-item">
                        <strong>{% trans "Création" %}</strong>
                        <div class="text-muted small">
                            {{ inventaire.date_creation|date:"d/m/Y H:i" }}
                            {% if inventaire.agent_saisie %}
                            <br>{% trans "par" %} {{ inventaire.agent_saisie.nom_complet }}
                            {% endif %}
                        </div>
                    </div>
                    {% if inventaire.verrouille %}
                    <div class="timeline-item">
                        <strong>{% trans "Verrouillage" %}</strong>
                        <div class="text-muted small">
                            {{ inventaire.date_modification|date:"d/m/Y H:i" }}
                        </div>
                    </div>
                    {% endif %}
                    {% if inventaire.valide %}
                    <div class="timeline-item">
                        <strong>{% trans "Validation" %}</strong>
                        <div class="text-muted small">
                            {{ inventaire.date_validation|date:"d/m/Y H:i" }}
                            {% if inventaire.valide_par %}
                            <br>{% trans "par" %} {{ inventaire.valide_par.nom_complet }}
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Recette associée -->
            {% if recette %}
            <div class="recette-card">
                <h6 class="mb-3">
                    <i class="fas fa-euro-sign me-2"></i>{% trans "Recette Associée" %}
                </h6>
                <div class="mb-2">
                    <strong>{% trans "Montant déclaré:" %}</strong>
                    <div class="recette-value">{{ recette.montant_declare|floatformat:0|format_milliers  }} FCFA</div>
                </div>
                {% if recette.recette_potentielle %}
                <div class="mb-2">
                    <strong>{% trans "Recette potentielle:" %}</strong>
                    <div>{{ recette.recette_potentielle|floatformat:0 }} FCFA</div>
                </div>
                <div class="mb-2">
                    <strong>{% trans "Taux de déperdition:" %}</strong>
                    <div>
                        <span class="badge bg-{{ recette.get_couleur_alerte }}">
                            {{ recette.taux_deperdition|floatformat:2 }}%
                        </span>
                    </div>
                </div>
                {% endif %}
                <a href="{% url 'inventaire:recette_detail' recette.pk %}" class="btn btn-sm btn-outline-warning">
                    {% trans "Voir recette" %}
                </a>
            </div>
            {% endif %}
        </div>

        <!-- Métriques et calculs -->
        <div class="col-lg-8">
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="metric-card">
                        <div class="metric-value">{{ total_vehicules }}</div>
                        <div class="metric-label">{% trans "Total Véhicules" %}</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="metric-card">
                        <div class="metric-value">{{ moyenne_horaire }}</div>
                        <div class="metric-label">{% trans "Moyenne/Heure" %}</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="metric-card">
                        <div class="metric-value">{{ estimation_24h|floatformat:0 }}</div>
                        <div class="metric-label">{% trans "Estimation 24h" %}</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="metric-card">
                        <div class="metric-value">{{ recette_potentielle|floatformat:0 }}</div>
                        <div class="metric-label">{% trans "Recette Pot. (FCFA)" %}</div>
                    </div>
                </div>
            </div>

            <!-- Graphique -->
            <div class="chart-container mb-4">
                <h5 class="mb-3">
                    <i class="fas fa-chart-bar me-2"></i>{% trans "Répartition par Période" %}
                </h5>
                <canvas id="inventaireChart" width="400" height="200"></canvas>
            </div>

            <!-- Détails par période -->
            <div class="info-card">
                <h5 class="card-title text-violet mb-3">
                    <i class="fas fa-clock me-2"></i>{% trans "Détails par Période" %}
                </h5>
                
                {% if details_periodes %}
                <div class="row">
                    {% for detail in details_periodes %}
                    <div class="col-md-6 mb-3">
                        <div class="periode-card">
                            <div class="periode-header">{{ detail.get_periode_display }}</div>
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="vehicule-count">{{ detail.nombre_vehicules }}</div>
                                <div class="text-muted small">
                                    {{ detail.heure_saisie|date:"H:i" }}
                                </div>
                            </div>
                            {% if detail.observations_periode %}
                            <div class="mt-2">
                                <small class="text-muted">
                                    <i class="fas fa-comment me-1"></i>
                                    {{ detail.observations_periode }}
                                </small>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-info-circle fa-3x text-muted mb-3"></i>
                    <p class="text-muted">{% trans "Aucun détail de période disponible." %}</p>
                    {% if can_edit %}
                    <a href="{% url 'inventaire:saisie_inventaire' %}?poste={{ inventaire.poste.id }}&date={{ inventaire.date|date:'Y-m-d' }}" 
                       class="btn btn-violet">
                        <i class="fas fa-plus me-2"></i>{% trans "Ajouter des données" %}
                    </a>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Actions rapides -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="info-card">
                <h6 class="mb-3">{% trans "Actions Rapides" %}</h6>
                <div class="btn-group" role="group">
                    <a href="{% url 'inventaire:inventaire_list' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>{% trans "Retour à la liste" %}
                    </a>
                    {% if can_edit %}
                    <a href="{% url 'inventaire:saisie_inventaire' %}?poste={{ inventaire.poste.id }}&date={{ inventaire.date|date:'Y-m-d' }}" 
                       class="btn btn-outline-primary">
                        <i class="fas fa-edit me-2"></i>{% trans "Modifier les données" %}
                    </a>
                    {% endif %}
                    <button class="btn btn-outline-info" onclick="imprimerInventaire()">
                        <i class="fas fa-print me-2"></i>{% trans "Imprimer" %}
                    </button>
                    <button class="btn btn-outline-success" onclick="exporterPDF()">
                        <i class="fas fa-file-pdf me-2"></i>{% trans "Export PDF" %}
                    </button>
                    {% if user.is_admin %}
                    <a href="/django-admin/inventaire/inventairejournalier/{{ inventaire.id }}/change/" 
                       class="btn btn-outline-warning">
                        <i class="fas fa-cogs me-2"></i>{% trans "Admin" %}
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirmation -->
<div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmModalTitle">{% trans "Confirmation" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="confirmModalBody">
                <!-- Contenu dynamique -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    {% trans "Annuler" %}
                </button>
                <button type="button" class="btn btn-primary" id="confirmModalAction">
                    {% trans "Confirmer" %}
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Données pour le graphique
const graphData = {{ graph_data|safe }};

// Configuration du graphique
const ctx = document.getElementById('inventaireChart').getContext('2d');
const inventaireChart = new Chart(ctx, {
    type: 'bar',
    data: {
        labels: graphData.periodes,
        datasets: [{
            label: '{% trans "Nombre de véhicules" %}',
            data: graphData.vehicules,
            backgroundColor: 'rgba(107, 70, 193, 0.7)',
            borderColor: 'rgba(107, 70, 193, 1)',
            borderWidth: 2,
            borderRadius: 8,
            borderSkipped: false,
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                titleColor: 'white',
                bodyColor: 'white',
                borderColor: 'rgba(107, 70, 193, 1)',
                borderWidth: 1,
                cornerRadius: 8,
                callbacks: {
                    label: function(context) {
                        return context.parsed.y + ' véhicules';
                    }
                }
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                grid: {
                    color: 'rgba(0, 0, 0, 0.1)'
                },
                ticks: {
                    color: '#64748B'
                }
            },
            x: {
                grid: {
                    display: false
                },
                ticks: {
                    color: '#64748B'
                }
            }
        }
    }
});



// Fonction d'impression
function imprimerInventaire() {
    window.print();
}

// Fonction d'export PDF
function exporterPDF() {
    // Créer un canvas temporaire avec les données du graphique
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = 800;
    canvas.height = 400;
    
    // Redessiner le graphique sur le canvas temporaire
    const tempChart = new Chart(ctx, inventaireChart.config);
    
    setTimeout(() => {
        // Ici, on pourrait intégrer une bibliothèque comme jsPDF
        alert('{% trans "Fonctionnalité d'export PDF en cours de développement" %}');
        tempChart.destroy();
    }, 1000);
}

// Auto-refresh des données toutes les 2 minutes si l'inventaire n'est pas verrouillé

setInterval(() => {
    fetch(window.location.href)
        .then(response => response.text())
        .then(html => {
            // Vérifier s'il y a des changements dans les métriques
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const newTotal = doc.querySelector('.metric-value').textContent;
            const currentTotal = document.querySelector('.metric-value').textContent;
            
            if (newTotal !== currentTotal) {
                // Afficher une notification de mise à jour
                const toast = document.createElement('div');
                toast.className = 'toast position-fixed top-0 end-0 m-3';
                toast.style.zIndex = '9999';
                toast.innerHTML = `
                    <div class="toast-header">
                        <strong class="me-auto">SUPPER</strong>
                        <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                    </div>
                    <div class="toast-body">
                        {% trans "L'inventaire a été mis à jour" %}
                    </div>
                `;
                document.body.appendChild(toast);
                new bootstrap.Toast(toast).show();
                
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 5000);
            }
        })
        .catch(error => console.error('Erreur refresh:', error));
}, 120000);


// Gestion du token CSRF
document.addEventListener('DOMContentLoaded', function() {
    // Ajouter le token CSRF s'il n'existe pas
    if (!document.querySelector('[name=csrfmiddlewaretoken]')) {
        const token = '{{ csrf_token }}';
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'csrfmiddlewaretoken';
        input.value = token;
        document.body.appendChild(input);
    }
});
</script>

<style media="print">
/* Styles pour l'impression */
.detail-header {
    background: #6B46C1 !important;
    -webkit-print-color-adjust: exact;
    color-adjust: exact;
}

.btn, .modal, .position-fixed {
    display: none !important;
}

.info-card, .metric-card, .chart-container {
    box-shadow: none !important;
    border: 1px solid #ddd !important;
}

.container-fluid {
    margin: 0 !important;
    padding: 0 !important;
}

@page {
    margin: 1cm;
    size: A4;
}
</style>
{% endblock %}