{% extends "admin/base_site.html" %}
{% load static i18n %}
{% load inventaire_extras %}

{% block title %}Simulateur de Commandes - SUPPER{% endblock %}

{% block extra_css %}
<style>
    .simulator-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        padding: 2rem;
    }
    .result-item {
        padding: 1rem;
        border-left: 4px solid #6B46C1;
        background: #f8f9fa;
        margin-bottom: 0.5rem;
    }
    .metric-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 10px;
        text-align: center;
    }
    .metric-value {
        font-size: 2rem;
        font-weight: bold;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <h2 class="mb-4">
        <i class="fas fa-calculator" style="color: #6B46C1;"></i>
        Simulateur de Commandes de Tickets
    </h2>
    
    <div class="row">
        <div class="col-md-4">
            <div class="simulator-card">
                <h5>Sélection du Poste</h5>
                <form method="post">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label">Choisir un poste :</label>
                        <select name="poste_id" class="form-select" required>
                            <option value="">-- Sélectionner --</option>
                            {% for poste in postes %}
                            <option value="{{ poste.id }}">
                                {{ poste.nom }} ({{ poste.code }})
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-chart-line me-2"></i>Calculer
                    </button>
                </form>
            </div>
        </div>
        
        {% if resultats %}
        <div class="col-md-8">
            <div class="simulator-card">
                <h5 class="mb-4">Résultats pour {{ resultats.poste.nom }}</h5>
                
                
        </div>
        {% endif %}

{% if erreur %}
<div class="col-md-12">
    <div class="alert alert-warning">
        <h5><i class="fas fa-exclamation-triangle me-2"></i>Calcul Impossible</h5>
        <p>{{ erreur }}</p>
        <p class="mb-0">
            <small>
                <strong>Raisons possibles :</strong>
                <ul>
                    <li>Pas assez de données historiques (minimum 90 jours requis)</li>
                    <li>Aucune recette déclarée pour ce poste récemment</li>
                    <li>Données incohérentes ou incomplètes</li>
                </ul>
            </small>
        </p>
    </div>
</div>
{% endif %}

<!-- Remplacer la section qualité prévision par : -->
{% if resultats and resultats.qualite_prevision %}
<div class="col-md-12 mt-4">
    <div class="simulator-card">
        <h5 class="mb-3">
            <i class="fas fa-chart-line me-2"></i>
            Qualité des Prévisions (Modèle Statistique Avancé)
        </h5>
        
        <div class="alert alert-info mb-3">
            <i class="fas fa-info-circle me-2"></i>
            Les prévisions utilisent un modèle Holt-Winters qui analyse les tendances et la saisonnalité 
            de vos données historiques sur les 365 derniers jours.
        </div>
        
        <div class="row">
            <div class="col-md-4">
                <div class="result-item">
                    <strong>Critère AIC :</strong>
                    <span class="float-end">{{ resultats.qualite_prevision.aic|floatformat:2 }}</span>
                    <small class="d-block text-muted">Plus bas = meilleur modèle</small>
                </div>
            </div>
            <div class="col-md-4">
                <div class="result-item">
                    <strong>Erreur Moyenne :</strong>
                    <span class="float-end">{{ resultats.qualite_prevision.mse|floatformat:0|format_milliers }} FCFA²</span>
                    <small class="d-block text-muted">Écart-type des prévisions</small>
                </div>
            </div>
            <div class="col-md-4">
                <div class="result-item">
                    <strong>Fiabilité :</strong>
                    <span class="float-end">
                        {% if resultats.qualite_prevision.mse < 1000000 %}
                            <span class="badge bg-success">Élevée ✓</span>
                        {% elif resultats.qualite_prevision.mse < 5000000 %}
                            <span class="badge bg-warning">Moyenne</span>
                        {% else %}
                            <span class="badge bg-danger">Faible ⚠</span>
                        {% endif %}
                    </span>
                    <small class="d-block text-muted">Basée sur l'historique</small>
                </div>
            </div>
        </div>
    </div>
    
            <!-- Scénarios de commande détaillés -->
            <div class="simulator-card mt-3">
                <h5 class="mb-3">
                    <i class="fas fa-layer-group me-2"></i>
                    Scénarios de Commande Recommandés
                </h5>
                
                <table class="table table-hover">
                    <thead style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                        <tr>
                            <th>Scénario</th>
                            <th>Montant à Commander</th>
                            <th>Nombre de Tickets</th>
                            <th>Description</th>
                            <th>Recommandation</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr class="table-success">
                            <td><strong>Optimiste</strong></td>
                            <td>{{ resultats.scenarios.optimiste.montant|floatformat:0|format_milliers }} FCFA</td>
                            <td>{{ resultats.scenarios.optimiste.tickets|format_milliers }} tickets</td>
                            <td>Borne inférieure (-5% des prévisions)</td>
                            <td><span class="badge bg-success">Risque faible</span></td>
                        </tr>
                        <tr class="table-info">
                            <td><strong>Moyen (Recommandé)</strong></td>
                            <td>{{ resultats.scenarios.moyen.montant|floatformat:0|format_milliers }} FCFA</td>
                            <td>{{ resultats.scenarios.moyen.tickets|format_milliers }} tickets</td>
                            <td>Prévision la plus probable</td>
                            <td><span class="badge bg-primary">⭐ Optimal</span></td>
                        </tr>
                        <tr class="table-warning">
                            <td><strong>Conservateur</strong></td>
                            <td>{{ resultats.scenarios.conservateur.montant|floatformat:0|format_milliers }} FCFA</td>
                            <td>{{ resultats.scenarios.conservateur.tickets|format_milliers }} tickets</td>
                            <td>Borne supérieure (+5% des prévisions)</td>
                            <td><span class="badge bg-warning">Sécurisé</span></td>
                        </tr>
                    </tbody>
                </table>
                
                <div class="alert alert-info mt-3">
                    <i class="fas fa-lightbulb me-2"></i>
                    <strong>Comment choisir ?</strong>
                    <ul class="mb-0">
                        <li><strong>Optimiste :</strong> Si vous avez une autre livraison prévue avant le 24/12</li>
                        <li><strong>Moyen (Recommandé) :</strong> Situation normale, prévisions statistiques fiables</li>
                        <li><strong>Conservateur :</strong> Si vous voulez une marge de sécurité maximale</li>
                    </ul>
                </div>
            </div>
        </div>
        {% endif %}
        
    </div>
</div>
{% endblock %}