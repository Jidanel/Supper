<!-- templates/inventaire/liste_stocks.html - VERSION RESPONSIVE MOBILE -->
{% extends "admin/base_site.html" %}
{% load static i18n %}
{% load inventaire_extras %}

{% block title %}Gestion des Stocks - Vue d'ensemble{% endblock %}

{% block extra_css %}
<style>
    /* ============================================
       RÉINITIALISATION COMPLÈTE POUR MOBILE
       ============================================ */
    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    /* ============================================
       CONTENEUR PRINCIPAL RESPONSIVE
       ============================================ */
    .container-fluid {
        width: 100%;
        max-width: 100%;
        padding-left: 15px;
        padding-right: 15px;
        margin-left: auto;
        margin-right: auto;
        overflow-x: hidden;
    }

    /* ============================================
       EN-TÊTE DE PAGE RESPONSIVE
       ============================================ */
    .page-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
        margin-bottom: 1.5rem;
        width: 100%;
    }

    .page-header h2 {
        font-size: 1.5rem;
        color: #1e293b;
        margin: 0;
        word-wrap: break-word;
        overflow-wrap: break-word;
        line-height: 1.4;
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 0.5rem;
    }

    .page-header h2 i {
        color: #667eea;
        flex-shrink: 0;
    }

    /* ============================================
       GRILLE DES STATISTIQUES RESPONSIVE
       ============================================ */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
        width: 100%;
    }

    .stat-box {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 12px;
        text-align: center;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        transition: transform 0.3s ease;
        width: 100%;
        overflow: hidden;
    }

    .stat-box:hover {
        transform: translateY(-3px);
    }

    .stat-box h4 {
        font-size: 1.5rem;
        font-weight: 700;
        margin: 0 0 0.5rem 0;
        word-break: break-word;
        overflow-wrap: break-word;
        line-height: 1.3;
    }

    .stat-box p {
        margin: 0;
        font-size: 0.9rem;
        opacity: 0.9;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }

    /* ============================================
       BARRE DE RECHERCHE RESPONSIVE
       ============================================ */
    .search-container {
        background: white;
        border-radius: 12px;
        padding: 1.25rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        width: 100%;
        border: 1px solid #e2e8f0;
    }

    .search-container label {
        display: block;
        font-weight: 600;
        color: #1e293b;
        margin-bottom: 0.75rem;
        font-size: 0.95rem;
    }

    .search-container label i {
        color: #667eea;
        margin-right: 0.5rem;
    }

    .search-form {
        width: 100%;
    }

    .search-input-wrapper {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        align-items: stretch;
        width: 100%;
    }

    .search-input-group {
        flex: 1;
        min-width: 0;
        position: relative;
    }

    .search-input-group input {
        width: 100%;
        padding: 0.875rem 2.5rem 0.875rem 2.75rem;
        border: 2px solid #e2e8f0;
        border-radius: 10px;
        font-size: 1rem;
        transition: all 0.3s ease;
        background-color: #f8fafc;
    }

    .search-input-group input:focus {
        outline: none;
        border-color: #667eea;
        background-color: #fff;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
    }

    .search-input-group input::placeholder {
        color: #94a3b8;
    }

    .search-input-group .search-icon {
        position: absolute;
        left: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: #94a3b8;
        font-size: 1rem;
        pointer-events: none;
        transition: color 0.3s ease;
    }

    .search-input-group input:focus ~ .search-icon,
    .search-input-group input:not(:placeholder-shown) ~ .search-icon {
        color: #667eea;
    }

    .search-input-group .clear-search {
        position: absolute;
        right: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        color: #94a3b8;
        font-size: 1rem;
        cursor: pointer;
        padding: 0.25rem;
        display: none;
        transition: color 0.2s ease;
    }

    .search-input-group .clear-search:hover {
        color: #ef4444;
    }

    .search-input-group .clear-search.visible {
        display: block;
    }

    .btn-search {
        padding: 0.875rem 1.5rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 10px;
        font-weight: 600;
        font-size: 0.95rem;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        transition: all 0.3s ease;
        white-space: nowrap;
        flex-shrink: 0;
    }

    .btn-search:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-search:active {
        transform: translateY(0);
    }

    .search-results-info {
        margin-top: 0.75rem;
        padding: 0.625rem 1rem;
        background: #f0f9ff;
        border-radius: 8px;
        font-size: 0.875rem;
        color: #0369a1;
        display: none;
        align-items: center;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .search-results-info.visible {
        display: flex;
    }

    .search-results-info i {
        flex-shrink: 0;
    }

    .search-results-info .results-count {
        font-weight: 600;
    }

    .search-results-info .search-term {
        font-weight: 600;
        color: #0c4a6e;
        background: #e0f2fe;
        padding: 0.125rem 0.5rem;
        border-radius: 4px;
    }

    .search-results-info .btn-reset {
        margin-left: auto;
        background: #0369a1;
        border: none;
        color: white;
        font-size: 0.85rem;
        cursor: pointer;
        padding: 0.375rem 0.75rem;
        border-radius: 6px;
        transition: background-color 0.2s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
        text-decoration: none;
    }

    .search-results-info .btn-reset:hover {
        background-color: #075985;
    }

    .no-results-message {
        background: #fef3c7;
        border: 1px solid #fcd34d;
        border-radius: 10px;
        padding: 1.5rem;
        text-align: center;
        margin-bottom: 1rem;
    }

    .no-results-message i {
        font-size: 2rem;
        color: #f59e0b;
        margin-bottom: 0.75rem;
        display: block;
    }

    .no-results-message p {
        margin: 0 0 1rem 0;
        color: #92400e;
        font-size: 0.95rem;
    }

    .no-results-message strong {
        color: #78350f;
    }

    .no-results-message .btn-reset-results {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.625rem 1.25rem;
        background: #f59e0b;
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.9rem;
        cursor: pointer;
        text-decoration: none;
        transition: background-color 0.2s ease;
    }

    .no-results-message .btn-reset-results:hover {
        background: #d97706;
    }

    /* Indicateur de chargement */
    .search-loading {
        display: none;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        padding: 1rem;
        color: #667eea;
        font-size: 0.9rem;
    }

    .search-loading.visible {
        display: flex;
    }

    .search-loading .spinner {
        width: 20px;
        height: 20px;
        border: 2px solid #e2e8f0;
        border-top-color: #667eea;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* ============================================
       CARTES DE STOCK RESPONSIVES
       ============================================ */
    .stocks-list {
        width: 100%;
    }

    .stock-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
        width: 100%;
        overflow: hidden;
    }

    .stock-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .stock-danger {
        border-left: 4px solid #dc3545;
    }

    .stock-warning {
        border-left: 4px solid #ffc107;
    }

    .stock-info {
        border-left: 4px solid #17a2b8;
    }

    .stock-success {
        border-left: 4px solid #28a745;
    }

    .stock-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1rem;
        flex-wrap: wrap;
        gap: 1rem;
        width: 100%;
    }

    .stock-header h5 {
        font-size: 1.1rem;
        font-weight: 600;
        color: #1e293b;
        margin: 0 0 0.25rem 0;
        word-wrap: break-word;
        overflow-wrap: break-word;
        line-height: 1.4;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .stock-header h5 i {
        color: #667eea;
        flex-shrink: 0;
    }

    .stock-header .text-muted {
        font-size: 0.85rem;
        color: #64748b;
        display: block;
    }

    .stock-value {
        font-size: 1.5rem;
        font-weight: bold;
        color: #1e40af;
        word-break: break-word;
        overflow-wrap: break-word;
        line-height: 1.3;
    }

    .stock-tickets {
        color: #6c757d;
        font-size: 0.9rem;
    }

    /* ============================================
       GRILLE INTERNE DES CARTES
       ============================================ */
    .stock-card .row {
        display: flex;
        flex-wrap: wrap;
        margin-left: -10px;
        margin-right: -10px;
        width: calc(100% + 20px);
    }

    .stock-card .col-md-4 {
        padding-left: 10px;
        padding-right: 10px;
        width: 100%;
        margin-bottom: 0.75rem;
    }

    /* ============================================
       ÉLÉMENTS INTERNES DES CARTES
       ============================================ */
    .vente-moyenne {
        font-size: 0.85rem;
        color: #6c757d;
    }

    .date-epuisement {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }

    .bg-danger {
        background-color: #dc3545 !important;
    }

    .bg-warning {
        background-color: #ffc107 !important;
        color: #212529 !important;
    }

    .bg-info {
        background-color: #17a2b8 !important;
    }

    .bg-success {
        background-color: #28a745 !important;
    }

    .text-white {
        color: white !important;
    }

    .text-success {
        color: #28a745 !important;
    }

    .text-danger {
        color: #dc3545 !important;
    }

    /* ============================================
       BOUTONS RESPONSIVES
       ============================================ */
    .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 0.375rem;
        padding: 0.5rem 0.875rem;
        font-size: 0.85rem;
        font-weight: 500;
        line-height: 1.4;
        text-align: center;
        text-decoration: none;
        white-space: nowrap;
        vertical-align: middle;
        cursor: pointer;
        border: 1px solid transparent;
        border-radius: 6px;
        transition: all 0.2s ease;
    }

    .btn-sm {
        padding: 0.375rem 0.625rem;
        font-size: 0.8rem;
    }

    .btn-success {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
        border-color: #059669;
    }

    .btn-success:hover {
        background: linear-gradient(135deg, #059669 0%, #047857 100%);
        transform: translateY(-1px);
    }

    .btn-info {
        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
        color: white;
        border-color: #2563eb;
    }

    .btn-info:hover {
        background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
        transform: translateY(-1px);
    }

    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-color: #764ba2;
    }

    .btn-primary:hover {
        background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
        transform: translateY(-1px);
    }

    /* Conteneur de boutons */
    .buttons-container {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        justify-content: flex-end;
        align-items: center;
        width: 100%;
    }

    /* ============================================
       ALERTE RESPONSIVE
       ============================================ */
    .alert {
        padding: 1rem 1.25rem;
        border-radius: 10px;
        margin-bottom: 1rem;
        width: 100%;
        word-wrap: break-word;
        overflow-wrap: break-word;
    }

    .alert-info {
        background-color: #e7f5ff;
        border: 1px solid #d0ebff;
        color: #055160;
    }

    .alert i {
        margin-right: 0.5rem;
        flex-shrink: 0;
    }

    /* ============================================
       PAGINATION RESPONSIVE
       ============================================ */
    .pagination {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        padding-left: 0;
        list-style: none;
        margin: 1.5rem 0;
        gap: 0.25rem;
    }

    .page-item {
        margin: 0;
    }

    .page-link {
        display: block;
        padding: 0.5rem 0.875rem;
        color: #667eea;
        background-color: #fff;
        border: 1px solid #dee2e6;
        border-radius: 6px;
        text-decoration: none;
        font-size: 0.9rem;
        transition: all 0.2s ease;
    }

    .page-link:hover {
        background-color: #e9ecef;
        border-color: #667eea;
        color: #5a67d8;
    }

    .page-item.active .page-link {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-color: #764ba2;
        color: white;
    }

    /* ============================================
       TEXTE MISE À JOUR
       ============================================ */
    .stock-card .mt-2 {
        margin-top: 0.75rem;
        padding-top: 0.75rem;
        border-top: 1px solid #f1f5f9;
    }

    .stock-card .mt-2 small {
        color: #94a3b8;
        font-size: 0.8rem;
    }

    /* ============================================
       HIGHLIGHT DE RECHERCHE
       ============================================ */
    .search-highlight {
        background-color: #fef08a;
        padding: 0 2px;
        border-radius: 2px;
        font-weight: inherit;
    }

    /* ============================================
       MEDIA QUERIES - VERSION PC (≥ 768px)
       ============================================ */
    @media (min-width: 768px) {
        .page-header h2 {
            font-size: 1.75rem;
        }

        .stat-box {
            padding: 1.75rem;
        }

        .stat-box h4 {
            font-size: 1.75rem;
        }

        .stock-card .col-md-4 {
            flex: 0 0 33.333333%;
            max-width: 33.333333%;
            margin-bottom: 0;
        }

        .stock-header {
            flex-wrap: nowrap;
        }

        .buttons-container {
            justify-content: flex-end;
        }

        .search-input-wrapper {
            flex-wrap: nowrap;
        }

        .search-input-group input {
            padding-right: 2.5rem;
        }
    }

    /* ============================================
       MEDIA QUERIES - GRANDS ÉCRANS (≥ 1024px)
       ============================================ */
    @media (min-width: 1024px) {
        .container-fluid {
            padding-left: 2rem;
            padding-right: 2rem;
        }

        .stats-grid {
            grid-template-columns: repeat(4, 1fr);
        }

        .stock-card {
            padding: 1.75rem;
        }

        .search-container {
            padding: 1.5rem;
        }

        .search-input-group input {
            font-size: 1rem;
        }
    }

    /* ============================================
       MEDIA QUERIES - MOBILE (≤ 767px)
       ============================================ */
    @media (max-width: 767px) {
        /* CORRECTION CRITIQUE : Empêcher le défilement horizontal */
        html, body {
            overflow-x: hidden !important;
            width: 100% !important;
            max-width: 100vw !important;
            position: relative !important;
        }

        .main-content {
            overflow-x: hidden !important;
            width: 100% !important;
            max-width: 100vw !important;
        }

        .content-wrapper {
            min-width: 100% !important;
            width: 100% !important;
            max-width: 100vw !important;
            padding: 1rem !important;
            overflow-x: hidden !important;
        }

        /* Conteneur principal */
        .container-fluid {
            padding-left: 12px;
            padding-right: 12px;
            width: 100%;
            max-width: 100vw;
            overflow-x: hidden;
        }

        /* En-tête */
        .page-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 0.75rem;
            margin-bottom: 1.25rem;
        }

        .page-header h2 {
            font-size: 1.25rem;
            width: 100%;
        }

        /* Statistiques */
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .stat-box {
            padding: 1rem;
            border-radius: 10px;
        }

        .stat-box h4 {
            font-size: 1.15rem;
        }

        .stat-box p {
            font-size: 0.8rem;
        }

        /* Barre de recherche */
        .search-container {
            padding: 1rem;
            margin-bottom: 1.25rem;
            border-radius: 10px;
        }

        .search-container label {
            font-size: 0.9rem;
            margin-bottom: 0.625rem;
        }

        .search-input-wrapper {
            flex-direction: column;
            gap: 0.625rem;
        }

        .search-input-group input {
            padding: 0.75rem 2.25rem 0.75rem 2.5rem;
            font-size: 16px; /* Empêche le zoom sur iOS */
            border-radius: 8px;
        }

        .search-input-group .search-icon {
            left: 0.875rem;
            font-size: 0.9rem;
        }

        .search-input-group .clear-search {
            right: 0.625rem;
        }

        .btn-search {
            width: 100%;
            padding: 0.75rem 1rem;
            font-size: 0.9rem;
            border-radius: 8px;
        }

        .search-results-info {
            font-size: 0.8rem;
            padding: 0.5rem 0.75rem;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .search-results-info .btn-reset {
            font-size: 0.8rem;
            padding: 0.3rem 0.625rem;
            margin-left: 0;
            margin-top: 0.25rem;
            width: 100%;
            justify-content: center;
        }

        .no-results-message {
            padding: 1.25rem;
        }

        .no-results-message i {
            font-size: 1.75rem;
        }

        .no-results-message p {
            font-size: 0.875rem;
        }

        /* Cartes de stock */
        .stock-card {
            padding: 1rem;
            margin-bottom: 0.75rem;
            border-radius: 10px;
        }

        .stock-header {
            flex-direction: column;
            gap: 0.75rem;
        }

        .stock-header > div:first-child {
            width: 100%;
        }

        .stock-header > div:last-child {
            width: 100%;
            text-align: left;
        }

        .stock-header h5 {
            font-size: 1rem;
        }

        .stock-value {
            font-size: 1.25rem;
        }

        .stock-tickets {
            font-size: 0.85rem;
        }

        /* Grille interne */
        .stock-card .row {
            margin-left: -8px;
            margin-right: -8px;
            width: calc(100% + 16px);
        }

        .stock-card .col-md-4 {
            padding-left: 8px;
            padding-right: 8px;
            flex: 0 0 100%;
            max-width: 100%;
            margin-bottom: 0.625rem;
        }

        .vente-moyenne {
            font-size: 0.8rem;
        }

        .date-epuisement {
            font-size: 0.8rem;
            padding: 0.2rem 0.5rem;
        }

        /* Boutons */
        .buttons-container {
            justify-content: flex-start;
            width: 100%;
        }

        .btn-sm {
            padding: 0.35rem 0.5rem;
            font-size: 0.75rem;
        }

        /* Pagination */
        .pagination {
            margin: 1rem 0;
        }

        .page-link {
            padding: 0.4rem 0.65rem;
            font-size: 0.8rem;
        }
    }

    /* ============================================
       MEDIA QUERIES - PETITS MOBILES (≤ 576px)
       ============================================ */
    @media (max-width: 576px) {
        .content-wrapper {
            padding: 0.75rem !important;
        }

        .container-fluid {
            padding-left: 10px;
            padding-right: 10px;
        }

        .page-header h2 {
            font-size: 1.15rem;
        }

        /* Statistiques - 1 colonne sur très petits écrans */
        .stats-grid {
            grid-template-columns: 1fr;
            gap: 0.625rem;
        }

        .stat-box {
            padding: 0.875rem;
        }

        .stat-box h4 {
            font-size: 1.1rem;
        }

        .stat-box p {
            font-size: 0.75rem;
        }

        /* Barre de recherche */
        .search-container {
            padding: 0.875rem;
        }

        .search-container label {
            font-size: 0.85rem;
        }

        .search-input-group input {
            padding: 0.625rem 2rem 0.625rem 2.25rem;
            font-size: 16px;
        }

        .btn-search {
            padding: 0.625rem 0.875rem;
            font-size: 0.85rem;
        }

        .search-results-info {
            font-size: 0.75rem;
        }

        /* Cartes de stock */
        .stock-card {
            padding: 0.875rem;
        }

        .stock-header h5 {
            font-size: 0.95rem;
        }

        .stock-value {
            font-size: 1.15rem;
        }

        .stock-tickets {
            font-size: 0.8rem;
        }

        .vente-moyenne {
            font-size: 0.75rem;
        }

        .date-epuisement {
            font-size: 0.75rem;
        }

        /* Boutons - empilés */
        .buttons-container {
            flex-direction: column;
            align-items: stretch;
        }

        .btn-sm {
            width: 100%;
            justify-content: center;
            padding: 0.5rem 0.75rem;
            font-size: 0.8rem;
        }

        .page-link {
            padding: 0.35rem 0.5rem;
            font-size: 0.75rem;
        }
    }

    /* ============================================
       MEDIA QUERIES - TRÈS PETITS ÉCRANS (≤ 375px)
       ============================================ */
    @media (max-width: 375px) {
        .content-wrapper {
            padding: 0.5rem !important;
        }

        .container-fluid {
            padding-left: 8px;
            padding-right: 8px;
        }

        .page-header h2 {
            font-size: 1.05rem;
        }

        .stat-box h4 {
            font-size: 1rem;
        }

        .stat-box p {
            font-size: 0.7rem;
        }

        .search-container {
            padding: 0.75rem;
        }

        .search-container label {
            font-size: 0.8rem;
        }

        .search-input-group input {
            padding: 0.5rem 1.75rem 0.5rem 2rem;
        }

        .btn-search {
            padding: 0.5rem 0.75rem;
            font-size: 0.8rem;
        }

        .stock-header h5 {
            font-size: 0.9rem;
        }

        .stock-value {
            font-size: 1.05rem;
        }

        .btn-sm {
            font-size: 0.75rem;
            padding: 0.4rem 0.625rem;
        }
    }

    /* ============================================
       ORIENTATION PAYSAGE SUR MOBILE
       ============================================ */
    @media (max-width: 896px) and (orientation: landscape) {
        .stats-grid {
            grid-template-columns: repeat(4, 1fr);
        }

        .stock-card .col-md-4 {
            flex: 0 0 33.333333%;
            max-width: 33.333333%;
        }

        .stock-header {
            flex-direction: row;
            flex-wrap: nowrap;
        }

        .buttons-container {
            flex-direction: row;
            justify-content: flex-end;
        }

        .btn-sm {
            width: auto;
        }

        .search-input-wrapper {
            flex-direction: row;
        }

        .btn-search {
            width: auto;
        }

        .search-results-info .btn-reset {
            width: auto;
            margin-left: auto;
            margin-top: 0;
        }
    }

    /* ============================================
       CORRECTION DU ZOOM SUR iOS
       ============================================ */
    @media (max-width: 768px) {
        input[type="text"],
        input[type="number"],
        input[type="date"],
        input[type="search"],
        select,
        textarea {
            font-size: 16px !important;
        }
    }

    /* ============================================
       ACCESSIBILITÉ
       ============================================ */
    .stock-card:focus-within,
    .btn:focus,
    .search-input-group input:focus,
    .btn-search:focus {
        outline: 2px solid #667eea;
        outline-offset: 2px;
    }

    /* ============================================
       SCROLLBAR GLOBALE MOBILE
       ============================================ */
    @media (max-width: 767px) {
        ::-webkit-scrollbar {
            width: 4px;
            height: 4px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 2px;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 2px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
    }

    /* ============================================
       GESTION DU TEXTE LONG
       ============================================ */
    .stock-header h5,
    .stock-value,
    .stat-box h4,
    .stat-box p,
    .vente-moyenne,
    .date-epuisement {
        word-wrap: break-word;
        overflow-wrap: break-word;
        hyphens: auto;
    }

    /* ============================================
       ANIMATION D'APPARITION
       ============================================ */
    .stock-card {
        animation: fadeInUp 0.4s ease-out;
    }

    .stat-box {
        animation: fadeInUp 0.3s ease-out;
    }

    .search-container {
        animation: fadeInUp 0.35s ease-out;
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(15px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Délai d'animation pour les stat-box */
    .stats-grid .stat-box:nth-child(1) { animation-delay: 0.05s; }
    .stats-grid .stat-box:nth-child(2) { animation-delay: 0.1s; }
    .stats-grid .stat-box:nth-child(3) { animation-delay: 0.15s; }
    .stats-grid .stat-box:nth-child(4) { animation-delay: 0.2s; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- En-tête de page -->
    <div class="page-header d-flex justify-content-between align-items-center mb-4">
        <h2>
            <i class="fas fa-boxes"></i> 
            Gestion des Stocks - Tous les Postes
        </h2>
    </div>
    
    <!-- Statistiques globales -->
    <div class="stats-grid">
        <div class="stat-box">
            <h4>{{ total_stock|floatformat:0|default:"0"|format_milliers }} FCFA</h4>
            <p>Stock total</p>
        </div>
        <div class="stat-box" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
            <h4>{{ total_tickets|default:"0"|format_milliers }}</h4>
            <p>Tickets totaux</p>
        </div>
        <div class="stat-box" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
            <h4>{{ stocks_critiques }}</h4>
            <p>Stocks critiques</p>
        </div>
        <div class="stat-box" style="background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);">
            <h4>{{ stocks_faibles }}</h4>
            <p>Stocks faibles</p>
        </div>
    </div>
    
    <!-- Barre de recherche -->
    <div class="search-container">
        <label for="searchInput">
            <i class="fas fa-search"></i>
            Rechercher un poste
        </label>
        <form method="GET" action="" class="search-form" id="searchForm">
            <div class="search-input-wrapper">
                <div class="search-input-group">
                    <input type="text" 
                           id="searchInput" 
                           name="q"
                           value="{{ search_query|default:'' }}"
                           placeholder="Tapez le nom ou le code du poste..."
                           autocomplete="off"
                           aria-label="Rechercher un poste">
                    <i class="fas fa-search search-icon"></i>
                    <button type="button" class="clear-search {% if search_query %}visible{% endif %}" id="clearSearch" aria-label="Effacer la recherche">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <button type="submit" class="btn-search" id="btnSearch">
                    <i class="fas fa-search"></i>
                    Rechercher
                </button>
            </div>
            
            <!-- Indicateur de chargement -->
            <div class="search-loading" id="searchLoading">
                <div class="spinner"></div>
                <span>Recherche en cours...</span>
            </div>
            
            <!-- Informations sur les résultats (affiché si recherche active) -->
            {% if search_query %}
            <div class="search-results-info visible">
                <i class="fas fa-info-circle"></i>
                <span>
                    <span class="results-count">{{ page_obj.paginator.count }}</span> poste(s) trouvé(s) pour 
                    "<span class="search-term">{{ search_query }}</span>"
                </span>
                <a href="{% url 'inventaire:liste_postes_stocks' %}" class="btn-reset">
                    <i class="fas fa-times"></i> Effacer
                </a>
            </div>
            {% endif %}
        </form>
    </div>
    
    <!-- Message aucun résultat -->
    {% if search_query and not page_obj.object_list %}
    <div class="no-results-message">
        <i class="fas fa-search"></i>
        <p>Aucun poste trouvé pour "<strong>{{ search_query }}</strong>"</p>
        <a href="{% url 'inventaire:liste_postes_stocks' %}" class="btn-reset-results">
            <i class="fas fa-undo"></i> Afficher tous les postes
        </a>
    </div>
    {% endif %}
    
    <!-- Liste des stocks -->
    <div class="stocks-list" id="stocksList">
        {% for item in page_obj %}
        <div class="stock-card stock-{{ item.alerte }}">
            <div class="stock-header">
                <div>
                    <h5 class="mb-1">
                        <i class="fas fa-map-marker-alt"></i> 
                        <span class="poste-nom-text">{{ item.poste.nom }}</span>
                    </h5>
                    <span class="text-muted">Code: <span class="poste-code-text">{{ item.poste.code }}</span></span>
                </div>
                <div class="text-end">
                    <div class="stock-value">{{ item.valeur_monetaire|floatformat:0|default:"0"|format_milliers }} FCFA</div>
                    <div class="stock-tickets">{{ item.nombre_tickets|format_milliers }} tickets</div>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-4">
                    <small class="text-muted">Vente moyenne journalière:</small><br>
                    <span class="vente-moyenne">{{ item.vente_moyenne|floatformat:0|default:"0"|format_milliers }} FCFA/jour</span>
                </div>
                <div class="col-md-4">
                    {% if item.date_epuisement %}
                    <small class="text-muted">Date d'épuisement prévue:</small><br>
                    <span class="date-epuisement bg-{{ item.alerte }} text-white">
                        {{ item.date_epuisement|date:"d/m/Y" }}
                        {% if item.jours_restants %}
                        ({{ item.jours_restants }} jours)
                        {% endif %}
                    </span>
                    {% else %}
                    <small class="text-muted">Pas de ventes récentes</small>
                    {% endif %}
                </div>
                <div class="col-md-4">
                    <div class="buttons-container">
                        <a href="{% url 'inventaire:charger_stock_tickets' item.poste.id %}" 
                           class="btn btn-sm btn-success"
                           title="Charger du stock">
                            <i class="fas fa-plus"></i> Charger
                        </a>
                        <a href="{% url 'inventaire:historique_stock' item.poste.id %}" 
                           class="btn btn-sm btn-info"
                           title="Voir l'historique">
                            <i class="fas fa-history"></i> Historique
                        </a>
                        <a href="{% url 'inventaire:stock_historique_date' item.poste.id %}?date={{ 'now'|date:'Y-m-d' }}" 
                           class="btn btn-sm btn-primary"
                           title="Voir le stock de ce poste à une date précise">
                            <i class="fas fa-calendar"></i> Stock par date
                        </a>
                        <a href="{% url 'inventaire:rebuild_stock_events' item.poste.id %}?date={{ 'now'|date:'Y-m-d' }}" 
                           class="btn btn-sm btn-primary"
                           title="Reconstruire le stock">
                            <i class="fas fa-building"></i> Reconstr. Stock
                        </a>
                    </div>
                </div>
            </div>
            
            <div class="mt-2">
                <small class="text-muted">
                    <i class="fas fa-clock me-1"></i>
                    Dernière mise à jour: {{ item.derniere_mise_a_jour|date:"d/m/Y H:i" }}
                </small>
            </div>
        </div>
        {% empty %}
        {% if not search_query %}
        <div class="alert alert-info">
            <i class="fas fa-info-circle"></i> Aucun stock configuré pour le moment
        </div>
        {% endif %}
        {% endfor %}
    </div>
    
    <!-- Pagination -->
    {% if page_obj.has_other_pages %}
    <nav id="paginationNav">
        <ul class="pagination justify-content-center">
            {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?{% if search_query %}q={{ search_query }}&{% endif %}page={{ page_obj.previous_page_number }}">
                    <i class="fas fa-chevron-left me-1"></i>Précédent
                </a>
            </li>
            {% endif %}
            
            <li class="page-item active">
                <span class="page-link">
                    Page {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}
                </span>
            </li>
            
            {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link" href="?{% if search_query %}q={{ search_query }}&{% endif %}page={{ page_obj.next_page_number }}">
                    Suivant<i class="fas fa-chevron-right ms-1"></i>
                </a>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // ============================================
    // ÉLÉMENTS DU DOM
    // ============================================
    const searchInput = document.getElementById('searchInput');
    const searchForm = document.getElementById('searchForm');
    const btnSearch = document.getElementById('btnSearch');
    const clearSearch = document.getElementById('clearSearch');
    const searchLoading = document.getElementById('searchLoading');
    
    // ============================================
    // GESTION DU BOUTON D'EFFACEMENT
    // ============================================
    function updateClearButton() {
        if (searchInput.value.trim() !== '') {
            clearSearch.classList.add('visible');
        } else {
            clearSearch.classList.remove('visible');
        }
    }
    
    // ============================================
    // SOUMISSION DU FORMULAIRE
    // ============================================
    function submitSearch() {
        const searchTerm = searchInput.value.trim();
        
        // Si le champ est vide, rediriger vers la page sans paramètre
        if (searchTerm === '') {
            window.location.href = window.location.pathname;
            return;
        }
        
        // Afficher l'indicateur de chargement
        searchLoading.classList.add('visible');
        
        // Soumettre le formulaire
        searchForm.submit();
    }
    
    // ============================================
    // EFFACER LA RECHERCHE
    // ============================================
    function clearSearchInput() {
        searchInput.value = '';
        clearSearch.classList.remove('visible');
        
        // Rediriger vers la page sans paramètre de recherche
        window.location.href = window.location.pathname;
    }
    
    // ============================================
    // ÉCOUTEURS D'ÉVÉNEMENTS
    // ============================================
    
    // Mise à jour du bouton d'effacement lors de la saisie
    searchInput.addEventListener('input', function() {
        updateClearButton();
    });
    
    // Soumission du formulaire
    searchForm.addEventListener('submit', function(e) {
        e.preventDefault();
        submitSearch();
    });
    
    // Bouton de recherche
    btnSearch.addEventListener('click', function(e) {
        e.preventDefault();
        submitSearch();
    });
    
    // Bouton d'effacement
    clearSearch.addEventListener('click', function(e) {
        e.preventDefault();
        clearSearchInput();
    });
    
    // Touche Entrée dans le champ de recherche
    searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            submitSearch();
        }
    });
    
    // Touche Échap pour effacer
    searchInput.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            if (searchInput.value.trim() !== '') {
                clearSearchInput();
            }
        }
    });
    
    // Focus sur le champ de recherche au chargement si une recherche est active
    {% if search_query %}
    searchInput.focus();
    searchInput.setSelectionRange(searchInput.value.length, searchInput.value.length);
    {% endif %}
    
    // ============================================
    // MISE EN SURBRILLANCE DES TERMES RECHERCHÉS
    // ============================================
    {% if search_query %}
    (function highlightSearchTerms() {
        const searchTerm = "{{ search_query|escapejs }}".toLowerCase();
        const stockCards = document.querySelectorAll('.stock-card');
        
        stockCards.forEach(function(card) {
            const nomElement = card.querySelector('.poste-nom-text');
            const codeElement = card.querySelector('.poste-code-text');
            
            if (nomElement) {
                highlightInElement(nomElement, searchTerm);
            }
            if (codeElement) {
                highlightInElement(codeElement, searchTerm);
            }
        });
        
        function highlightInElement(element, term) {
            const originalText = element.textContent;
            const lowerText = originalText.toLowerCase();
            
            if (lowerText.includes(term)) {
                // Créer une expression régulière insensible à la casse
                const regex = new RegExp('(' + escapeRegExp(term) + ')', 'gi');
                element.innerHTML = originalText.replace(regex, '<mark class="search-highlight">$1</mark>');
            }
        }
        
        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }
    })();
    {% endif %}
    
    // ============================================
    // CORRECTION DU DÉFILEMENT HORIZONTAL SUR MOBILE
    // ============================================
    function fixMobileScrolling() {
        if (window.innerWidth <= 768) {
            document.documentElement.style.overflowX = 'hidden';
            document.body.style.overflowX = 'hidden';
            document.body.style.width = '100%';
            document.body.style.maxWidth = '100vw';
        } else {
            document.documentElement.style.overflowX = '';
            document.body.style.overflowX = '';
            document.body.style.width = '';
            document.body.style.maxWidth = '';
        }
    }
    
    // Exécuter au chargement et au redimensionnement
    fixMobileScrolling();
    window.addEventListener('resize', fixMobileScrolling);
    window.addEventListener('orientationchange', fixMobileScrolling);
    
    // Correction pour éviter le zoom automatique sur iOS
    document.addEventListener('touchstart', function() {}, { passive: true });
});
</script>
{% endblock %}