{% extends "admin/base_site.html" %}
{% load static i18n inventaire_extras %}

{% block title %}Confirmer le Transfert{% endblock %}

{% block extra_css %}
<style>
    .alerte-confirmation {
        background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 8px;
        font-weight: 600;
        margin-bottom: 2rem;
    }
    
    .stock-evolution {
        background: #fef3c7;
        border-left: 4px solid #f59e0b;
        padding: 1rem;
        margin: 1rem 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    
    <!-- Alerte de confirmation -->
    <div class="alerte-confirmation">
        <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
        <h4 class="mb-2">⚠️ CONFIRMATION REQUISE</h4>
        <p class="mb-0">
            Veuillez vérifier attentivement les informations avant de valider le transfert.<br>
            <strong>Cette opération est irréversible.</strong>
        </p>
    </div>
    
    <h2 class="mb-4">Confirmation du Transfert de Tickets</h2>
    
    <!-- Informations du transfert -->
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">
                <i class="fas fa-info-circle me-2"></i>
                Informations du Transfert
            </h5>
        </div>
        <div class="card-body">
            <table class="table table-bordered">
                <tr>
                    <th width="30%">Couleur des Tickets</th>
                    <td>
                        <span class="badge" 
                              style="background-color: {{ couleur.code_hex|default:'#6B7280' }}; 
                                     font-size: 1.1rem; padding: 0.5rem 1rem;">
                            {{ couleur.libelle_affichage }}
                        </span>
                    </td>
                </tr>
                <tr>
                    <th>Série à Transférer</th>
                    <td>
                        <strong style="font-size: 1.2rem;">
                            N° {{ numero_premier }} <i class="fas fa-arrow-right mx-2"></i> N° {{ numero_dernier }}
                        </strong>
                    </td>
                </tr>
                <tr>
                    <th>Nombre de Tickets</th>
                    <td>
                        <span class="badge bg-primary" style="font-size: 1.1rem;">
                            {{ nombre_tickets }} tickets
                        </span>
                    </td>
                </tr>
                <tr>
                    <th>Valeur Monétaire</th>
                    <td>
                        <strong class="text-success" style="font-size: 1.3rem;">
                            {{ montant|floatformat:0|format_milliers }} FCFA
                        </strong>
                        <small class="text-muted">
                            ({{ nombre_tickets }} × 500 FCFA)
                        </small>
                    </td>
                </tr>
                {% if commentaire %}
                <tr>
                    <th>Commentaire</th>
                    <td>{{ commentaire }}</td>
                </tr>
                {% endif %}
            </table>
        </div>
    </div>
    
    <!-- Impact sur les stocks -->
    <h5 class="mb-3">
        <i class="fas fa-warehouse me-2"></i>
        Impact sur les Stocks
    </h5>
    
    <div class="row mb-4">
        <!-- Stock Origine -->
        <div class="col-md-6">
            <div class="card border-danger">
                <div class="card-header bg-danger text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-minus-circle me-2"></i>
                        POSTE ORIGINE (Cède)
                    </h6>
                </div>
                <div class="card-body">
                    <h5 class="mb-3">{{ poste_origine.nom }}</h5>
                    
                    <div class="stock-evolution">
                        <div class="row text-center">
                            <div class="col-4">
                                <h6 class="text-muted">Avant</h6>
                                <h5>{{ stock_origine_avant|floatformat:0|format_milliers }} FCFA</h5>
                            </div>
                            <div class="col-4">
                                <h6 class="text-danger">Déduction</h6>
                                <h5 class="text-danger">- {{ montant|floatformat:0|format_milliers }}</h5>
                            </div>
                            <div class="col-4">
                                <h6 class="text-muted">Après</h6>
                                <h5 class="text-primary">{{ stock_origine_apres|floatformat:0|format_milliers }} FCFA</h5>
                            </div>
                        </div>
                    </div>
                    
                    {% if stock_origine_apres < 0 %}
                    <div class="alert alert-danger mt-3">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        ⚠️ ATTENTION : Stock négatif après transfert !
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Stock Destination -->
        <div class="col-md-6">
            <div class="card border-success">
                <div class="card-header bg-success text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-plus-circle me-2"></i>
                        POSTE DESTINATION (Reçoit)
                    </h6>
                </div>
                <div class="card-body">
                    <h5 class="mb-3">{{ poste_destination.nom }}</h5>
                    
                    <div class="stock-evolution">
                        <div class="row text-center">
                            <div class="col-4">
                                <h6 class="text-muted">Avant</h6>
                                <h5>{{ stock_destination_avant|floatformat:0|format_milliers }} FCFA</h5>
                            </div>
                            <div class="col-4">
                                <h6 class="text-success">Ajout</h6>
                                <h5 class="text-success">+ {{ montant|floatformat:0|format_milliers }}</h5>
                            </div>
                            <div class="col-4">
                                <h6 class="text-muted">Après</h6>
                                <h5 class="text-primary">{{ stock_destination_apres|floatformat:0|format_milliers }} FCFA</h5>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Ce qui va se passer -->
    <div class="alert alert-info">
        <h6>
            <i class="fas fa-info-circle me-2"></i>
            Que va-t-il se passer après validation ?
        </h6>
        <ul class="mb-0">
            <li>La série <strong>{{ couleur.libelle_affichage }} #{{ numero_premier }}-{{ numero_dernier }}</strong> 
                sera <strong>retirée du stock</strong> de <strong>{{ poste_origine.nom }}</strong></li>
            <li>Cette même série sera <strong>ajoutée au stock</strong> de <strong>{{ poste_destination.nom }}</strong></li>
            <li>Un bordereau de transfert sera généré avec tous les détails</li>
            <li>L'historique complet sera enregistré pour traçabilité</li>
            <li><strong class="text-danger">Cette action est définitive et irréversible</strong></li>
        </ul>
    </div>
    
    <!-- Boutons d'action -->
    <form method="post">
        {% csrf_token %}
        
        <div class="d-flex justify-content-between mt-4">
            <button type="submit" name="action" value="annuler" 
                    class="btn btn-secondary btn-lg">
                <i class="fas fa-times me-2"></i>
                Annuler
            </button>
            
            {% if stock_origine_apres >= 0 %}
            <button type="submit" name="action" value="confirmer" 
                    class="btn btn-success btn-lg">
                <i class="fas fa-check-circle me-2"></i>
                Valider le Transfert
            </button>
            {% else %}
            <button type="button" class="btn btn-danger btn-lg" disabled>
                <i class="fas fa-ban me-2"></i>
                Validation impossible (stock insuffisant)
            </button>
            {% endif %}
        </div>
    </form>
    
</div>
{% endblock %}