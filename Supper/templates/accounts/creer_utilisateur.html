{% extends "admin/base_site.html" %}
{% load static i18n %}

{% block title %}Cr√©er un utilisateur - SUPPER{% endblock %}

{% block content %}
<style>
    .page-header {
        background: linear-gradient(135deg, #10B981 0%, #059669 100%) !important;
        color: white !important;
        border-radius: 12px !important;
        padding: 1.5rem 2rem !important;
        margin-bottom: 1.5rem !important;
        box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3) !important;
    }
    .form-container {
        background: white !important;
        border-radius: 12px !important;
        padding: 2rem !important;
        box-shadow: 0 2px 15px rgba(0, 0, 0, 0.08) !important;
        border: 1px solid #E2E8F0 !important;
    }
    .section-title {
        color: #10B981 !important;
        border-bottom: 2px solid #E2E8F0 !important;
        padding-bottom: 0.75rem !important;
        margin-bottom: 1.5rem !important;
        font-weight: 600 !important;
        font-size: 1.1rem !important;
    }
    .form-label { font-weight: 600 !important; color: #334155 !important; margin-bottom: 0.5rem !important; }
    .form-control, .form-select {
        border: 2px solid #E2E8F0 !important;
        border-radius: 8px !important;
        padding: 0.75rem 1rem !important;
        transition: all 0.3s ease !important;
    }
    .form-control:focus, .form-select:focus {
        border-color: #10B981 !important;
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.15) !important;
    }
    .btn-primary-gradient {
        background: linear-gradient(135deg, #10B981, #059669) !important;
        border: none !important; color: white !important;
        padding: 0.75rem 2rem !important; border-radius: 8px !important; font-weight: 600 !important;
    }
    .btn-primary-gradient:hover {
        background: linear-gradient(135deg, #059669, #047857) !important;
        transform: translateY(-2px) !important;
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4) !important;
    }
    .btn-secondary { background: #64748B !important; border: none !important; padding: 0.75rem 2rem !important; border-radius: 8px !important; font-weight: 600 !important; color: white !important; }
    .required { color: #EF4444 !important; }
    .help-text { font-size: 0.875rem !important; color: #64748B !important; margin-top: 0.25rem !important; }
    .filter-alert { border-radius: 8px !important; padding: 1rem !important; margin-bottom: 1rem !important; display: none; }
    .filter-alert-pesage { background: linear-gradient(135deg, #F3E8FF 0%, #E9D5FF 100%) !important; border: 1px solid #8B5CF6 !important; border-left: 4px solid #8B5CF6 !important; }
    .filter-alert-peage { background: linear-gradient(135deg, #DBEAFE 0%, #BFDBFE 100%) !important; border: 1px solid #3B82F6 !important; border-left: 4px solid #3B82F6 !important; }
    .filter-alert-multi { background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%) !important; border: 1px solid #F59E0B !important; border-left: 4px solid #F59E0B !important; }
    .postes-stats { display: flex !important; gap: 1rem !important; margin-bottom: 0.5rem !important; }
    .postes-stats .stat-item { font-size: 0.8rem !important; padding: 0.25rem 0.75rem !important; border-radius: 6px !important; background: #F1F5F9 !important; }
    .postes-stats .stat-item.peage { border-left: 3px solid #3B82F6 !important; }
    .postes-stats .stat-item.pesage { border-left: 3px solid #8B5CF6 !important; }
    .form-check-input:checked { background-color: #10B981 !important; border-color: #10B981 !important; }
    .accordion-button:not(.collapsed) { background: linear-gradient(135deg, #D1FAE5 0%, #A7F3D0 100%) !important; color: #047857 !important; }
    .perm-count-badge { background: #10B981 !important; color: white !important; font-size: 0.7rem !important; padding: 0.2rem 0.5rem !important; border-radius: 10px !important; margin-left: 0.5rem !important; }
    .password-toggle { cursor: pointer; position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #64748B; }
    .permissions-controls { display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1rem; }
    .permissions-controls .btn { font-size: 0.8rem; padding: 0.4rem 0.8rem; }
</style>

<div class="container-fluid py-4">
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
            <div>
                <h2 class="mb-1" style="color: white;"><i class="fas fa-user-plus me-2"></i>Cr√©er un utilisateur</h2>
                <p class="mb-0" style="opacity: 0.85; color: white;">Ajouter un nouvel utilisateur au syst√®me SUPPER</p>
            </div>
            <a href="{% url 'accounts:user_list' %}" class="btn btn-light"><i class="fas fa-arrow-left me-2"></i>Retour</a>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-xl-10 col-lg-11">
            <div class="form-container">
                <form method="post" enctype="multipart/form-data" id="form-creer-utilisateur" novalidate>
                    {% csrf_token %}
                    
                    {% if messages %}{% for message in messages %}<div class="alert alert-{{ message.tags }} alert-dismissible fade show">{{ message }}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>{% endfor %}{% endif %}
                    {% if form.non_field_errors %}{% for error in form.non_field_errors %}<div class="alert alert-danger alert-dismissible fade show"><i class="fas fa-exclamation-triangle me-2"></i>{{ error }}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>{% endfor %}{% endif %}

                    <!-- Section Identification -->
                    <h5 class="section-title"><i class="fas fa-id-card me-2"></i>Identification</h5>
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label for="id_username" class="form-label">Matricule <span class="required">*</span></label>
                            <input type="text" name="username" id="id_username" class="form-control {% if form.username.errors %}is-invalid{% endif %}" value="{{ form.username.value|default:'' }}" required placeholder="Ex: 123456A">
                            <div class="help-text">Matricule unique de l'agent</div>
                            {% if form.username.errors %}<div class="invalid-feedback">{{ form.username.errors.0 }}</div>{% endif %}
                        </div>
                        <div class="col-md-6">
                            <label for="id_nom_complet" class="form-label">Nom Complet <span class="required">*</span></label>
                            <input type="text" name="nom_complet" id="id_nom_complet" class="form-control {% if form.nom_complet.errors %}is-invalid{% endif %}" value="{{ form.nom_complet.value|default:'' }}" required placeholder="Ex: KAMGA Jean Pierre">
                            {% if form.nom_complet.errors %}<div class="invalid-feedback">{{ form.nom_complet.errors.0 }}</div>{% endif %}
                        </div>
                    </div>

                    <!-- Section Contact -->
                    <h5 class="section-title"><i class="fas fa-address-book me-2"></i>Contact</h5>
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label for="id_telephone" class="form-label">T√©l√©phone <span class="required">*</span></label>
                            <input type="tel" name="telephone" id="id_telephone" class="form-control {% if form.telephone.errors %}is-invalid{% endif %}" value="{{ form.telephone.value|default:'' }}" required placeholder="+237XXXXXXXXX">
                            <div class="help-text">Format: +237XXXXXXXXX</div>
                            {% if form.telephone.errors %}<div class="invalid-feedback">{{ form.telephone.errors.0 }}</div>{% endif %}
                        </div>
                        <div class="col-md-6">
                            <label for="id_email" class="form-label">Email</label>
                            <input type="email" name="email" id="id_email" class="form-control {% if form.email.errors %}is-invalid{% endif %}" value="{{ form.email.value|default:'' }}" placeholder="agent@exemple.cm">
                            <div class="help-text">Optionnel</div>
                            {% if form.email.errors %}<div class="invalid-feedback">{{ form.email.errors.0 }}</div>{% endif %}
                        </div>
                    </div>

                    <!-- Section S√©curit√© -->
                    <h5 class="section-title"><i class="fas fa-lock me-2"></i>S√©curit√©</h5>
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label for="id_password" class="form-label">Mot de passe <span class="required">*</span></label>
                            <div class="position-relative">
                                <input type="password" name="password" id="id_password" class="form-control {% if form.password.errors %}is-invalid{% endif %}" required value="0000">
                                <span class="password-toggle" onclick="togglePassword()"><i class="fas fa-eye" id="toggle-icon"></i></span>
                            </div>
                            <div class="help-text">Minimum 4 caract√®res (d√©faut: 0000)</div>
                            {% if form.password.errors %}<div class="invalid-feedback">{{ form.password.errors.0 }}</div>{% endif %}
                        </div>
                        <div class="col-md-6">
                            <label for="id_password_confirm" class="form-label">Confirmer le mot de passe <span class="required">*</span></label>
                            <input type="password" name="password_confirm" id="id_password_confirm" class="form-control" required value="0000">
                        </div>
                    </div>

                    <!-- Section Affectation -->
                    <h5 class="section-title"><i class="fas fa-briefcase me-2"></i>Affectation Professionnelle</h5>
                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label for="id_habilitation" class="form-label">R√¥le / Habilitation <span class="required">*</span></label>
                            <select name="habilitation" id="id_habilitation" class="form-select" required>
                                <option value="">-- S√©lectionner un r√¥le --</option>
                                {% for value, label in habilitations %}
                                <option value="{{ value }}">{{ label }}</option>
                                {% endfor %}
                            </select>
                            <div class="help-text">Les permissions seront automatiquement attribu√©es selon le r√¥le</div>
                        </div>
                        <div class="col-md-6">
                            <label for="id_poste_affectation" class="form-label" id="label-poste">Poste d'affectation</label>
                            <div class="postes-stats">
                                <span class="stat-item peage"><i class="fas fa-road me-1"></i>{{ postes_peage|length }} p√©age</span>
                                <span class="stat-item pesage"><i class="fas fa-weight me-1"></i>{{ postes_pesage|length }} pesage</span>
                            </div>
                            <select name="poste_affectation" id="id_poste_affectation" class="form-select">
                                <option value="">-- Aucun poste --</option>
                                <optgroup label="üîµ Postes de P√©age" id="optgroup-peage">
                                    {% for poste in postes_peage %}
                                    <option value="{{ poste.id }}" data-type="peage">{{ poste.nom }} ({{ poste.code }})</option>
                                    {% endfor %}
                                </optgroup>
                                <optgroup label="üü£ Stations de Pesage" id="optgroup-pesage">
                                    {% for poste in postes_pesage %}
                                    <option value="{{ poste.id }}" data-type="pesage">{{ poste.nom }} ({{ poste.code }})</option>
                                    {% endfor %}
                                </optgroup>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Alertes de filtrage -->
                    <div id="filter-alert-pesage" class="filter-alert filter-alert-pesage">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-weight me-3 fa-lg" style="color: #8B5CF6;"></i>
                            <div><strong>R√¥le Pesage</strong><br><small>Station de pesage <strong>obligatoire</strong>.</small></div>
                        </div>
                    </div>
                    <div id="filter-alert-peage" class="filter-alert filter-alert-peage">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-road me-3 fa-lg" style="color: #3B82F6;"></i>
                            <div><strong>R√¥le P√©age</strong><br><small>Poste de p√©age <strong>obligatoire</strong>.</small></div>
                        </div>
                    </div>
                    <div id="filter-alert-multi" class="filter-alert filter-alert-multi">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-globe me-3 fa-lg" style="color: #F59E0B;"></i>
                            <div><strong>R√¥le Administration</strong><br><small>Poste optionnel (tous postes accessibles).</small></div>
                        </div>
                    </div>

                    <!-- Section Permissions -->
                    <h5 class="section-title">
                        <i class="fas fa-shield-alt me-2"></i>Permissions Granulaires
                        <span id="permissions-count" class="badge bg-secondary ms-2">0/{{ total_permissions }}</span>
                    </h5>
                    
                    <p class="text-muted mb-2">
                        <i class="fas fa-info-circle me-1"></i>
                        S√©lectionnez un r√¥le ci-dessus pour charger automatiquement les permissions par d√©faut. 
                        Vous pouvez ensuite personnaliser les permissions.
                    </p>
                    
                    <!-- Contr√¥les des permissions -->
                    <div class="permissions-controls">
                        <button type="button" class="btn btn-outline-success btn-sm" onclick="cocherToutesPermissions()">
                            <i class="fas fa-check-double me-1"></i>Tout cocher
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="decocherToutesPermissions()">
                            <i class="fas fa-times me-1"></i>Tout d√©cocher
                        </button>
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="reinitialiserPermissionsDefaut()">
                            <i class="fas fa-undo me-1"></i>R√©initialiser au r√¥le
                        </button>
                    </div>
                    
                    <!-- Accord√©on des permissions par cat√©gorie -->
                    <div class="accordion" id="accordionPermissions">
                        {% for cat_id, cat in permissions_categories.items %}
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ cat_id }}">
                                    <i class="{{ cat.icon }} me-2"></i>{{ cat.label }}
                                    <span class="perm-count-badge" id="count-{{ cat_id }}">{{ cat.count_actives }}/{{ cat.count_total }}</span>
                                </button>
                            </h2>
                            <div id="collapse-{{ cat_id }}" class="accordion-collapse collapse" data-bs-parent="#accordionPermissions">
                                <div class="accordion-body">
                                    <div class="row">
                                        {% for perm in cat.permissions %}
                                        <div class="col-md-6">
                                            <div class="form-check mb-2">
                                                <input type="checkbox" 
                                                       class="form-check-input perm-checkbox" 
                                                       name="{{ perm.name }}" 
                                                       id="id_{{ perm.name }}"
                                                       data-category="{{ cat_id }}"
                                                       {% if perm.checked %}checked{% endif %}>
                                                <label class="form-check-label" for="id_{{ perm.name }}">{{ perm.label }}</label>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    <!-- Boutons de soumission -->
                    <div class="d-flex justify-content-end gap-3 mt-4 pt-3 border-top">
                        <a href="{% url 'accounts:user_list' %}" class="btn btn-secondary">
                            <i class="fas fa-times me-2"></i>Annuler
                        </a>
                        <button type="submit" class="btn btn-primary-gradient">
                            <i class="fas fa-user-plus me-2"></i>Cr√©er l'utilisateur
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// ===================================================================
// DONN√âES DES PERMISSIONS DEPUIS LE SERVEUR
// ===================================================================

// Dictionnaire des permissions par habilitation (g√©n√©r√© c√¥t√© serveur)
const PERMISSIONS_PAR_HABILITATION = {{ permissions_par_habilitation_json|safe }};

// Liste de toutes les permissions
const TOUTES_PERMISSIONS = {{ toutes_permissions_json|safe }};

// Structure des cat√©gories pour les compteurs
const CATEGORIES = {
    {% for cat_id, cat in permissions_categories.items %}
    '{{ cat_id }}': {
        permissions: [{% for perm in cat.permissions %}'{{ perm.name }}'{% if not forloop.last %}, {% endif %}{% endfor %}]
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
};


// ===================================================================
// FONCTIONS DE GESTION DES PERMISSIONS
// ===================================================================

/**
 * Applique les permissions par d√©faut pour une habilitation
 */
function appliquerPermissionsHabilitation(habilitation) {
    // D'abord, d√©cocher toutes les permissions
    TOUTES_PERMISSIONS.forEach(perm => {
        const checkbox = document.getElementById('id_' + perm);
        if (checkbox) {
            checkbox.checked = false;
        }
    });
    
    // Puis cocher les permissions de l'habilitation
    const permissions = PERMISSIONS_PAR_HABILITATION[habilitation];
    if (permissions) {
        permissions.forEach(perm => {
            const checkbox = document.getElementById('id_' + perm);
            if (checkbox) {
                checkbox.checked = true;
            }
        });
    }
    
    mettreAJourCompteurs();
}

/**
 * Coche toutes les permissions
 */
function cocherToutesPermissions() {
    TOUTES_PERMISSIONS.forEach(perm => {
        const checkbox = document.getElementById('id_' + perm);
        if (checkbox) checkbox.checked = true;
    });
    mettreAJourCompteurs();
}

/**
 * D√©coche toutes les permissions
 */
function decocherToutesPermissions() {
    TOUTES_PERMISSIONS.forEach(perm => {
        const checkbox = document.getElementById('id_' + perm);
        if (checkbox) checkbox.checked = false;
    });
    mettreAJourCompteurs();
}

/**
 * R√©initialise aux permissions par d√©faut du r√¥le s√©lectionn√©
 */
function reinitialiserPermissionsDefaut() {
    const select = document.getElementById('id_habilitation');
    const habilitation = select ? select.value : '';
    
    if (!habilitation) {
        alert('Veuillez d\'abord s√©lectionner un r√¥le.');
        return;
    }
    
    if (confirm('Voulez-vous r√©initialiser les permissions aux valeurs par d√©faut du r√¥le s√©lectionn√© ?')) {
        appliquerPermissionsHabilitation(habilitation);
    }
}

/**
 * Met √† jour tous les compteurs de permissions
 */
function mettreAJourCompteurs() {
    let totalActives = 0;
    
    // Compteur par cat√©gorie
    Object.keys(CATEGORIES).forEach(catId => {
        let countCat = 0;
        CATEGORIES[catId].permissions.forEach(perm => {
            const checkbox = document.getElementById('id_' + perm);
            if (checkbox && checkbox.checked) countCat++;
        });
        
        const badge = document.getElementById('count-' + catId);
        if (badge) {
            badge.textContent = countCat + '/' + CATEGORIES[catId].permissions.length;
        }
        totalActives += countCat;
    });
    
    // Compteur total
    const totalBadge = document.getElementById('permissions-count');
    if (totalBadge) {
        totalBadge.textContent = totalActives + '/{{ total_permissions }}';
        
        // Couleur selon le pourcentage
        totalBadge.className = 'badge ms-2 ';
        if (totalActives === 0) {
            totalBadge.className += 'bg-secondary';
        } else if (totalActives < {{ total_permissions }} * 0.3) {
            totalBadge.className += 'bg-warning';
        } else if (totalActives < {{ total_permissions }} * 0.7) {
            totalBadge.className += 'bg-info';
        } else {
            totalBadge.className += 'bg-success';
        }
    }
}


// ===================================================================
// FONCTIONS DE FILTRAGE DES POSTES
// ===================================================================

const ROLES_PESAGE = ['chef_station_pesage', 'regisseur_pesage', 'chef_equipe_pesage', 'cisop_pesage'];
const ROLES_PEAGE = ['chef_peage', 'agent_inventaire', 'cisop_peage'];
const ROLES_ADMIN = ['admin_principal', 'coord_psrr', 'serv_info', 'serv_emission', 'chef_ag', 'serv_controle', 'serv_ordre', 'imprimerie', 'comptable_mat'];

function filterPostes() {
    const hab = document.getElementById('id_habilitation').value;
    const optgroupPeage = document.getElementById('optgroup-peage');
    const optgroupPesage = document.getElementById('optgroup-pesage');
    const alertPesage = document.getElementById('filter-alert-pesage');
    const alertPeage = document.getElementById('filter-alert-peage');
    const alertMulti = document.getElementById('filter-alert-multi');
    
    // Cacher toutes les alertes
    alertPesage.style.display = 'none';
    alertPeage.style.display = 'none';
    alertMulti.style.display = 'none';
    
    // R√©afficher tous les optgroups
    optgroupPeage.style.display = '';
    optgroupPesage.style.display = '';
    
    if (ROLES_PESAGE.includes(hab)) {
        optgroupPeage.style.display = 'none';
        alertPesage.style.display = 'block';
    } else if (ROLES_PEAGE.includes(hab)) {
        optgroupPesage.style.display = 'none';
        alertPeage.style.display = 'block';
    } else if (ROLES_ADMIN.includes(hab)) {
        alertMulti.style.display = 'block';
    }
}


// ===================================================================
// AUTRES FONCTIONS
// ===================================================================

function togglePassword() {
    const pwd = document.getElementById('id_password');
    const icon = document.getElementById('toggle-icon');
    if (pwd.type === 'password') {
        pwd.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
    } else {
        pwd.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
    }
}


// ===================================================================
// INITIALISATION
// ===================================================================

document.addEventListener('DOMContentLoaded', function() {
    const habSelect = document.getElementById('id_habilitation');
    
    if (habSelect) {
        // G√©rer le changement d'habilitation
        habSelect.addEventListener('change', function() {
            const habilitation = this.value;
            
            // Filtrer les postes
            filterPostes();
            
            // Appliquer les permissions par d√©faut pour la nouvelle habilitation
            if (habilitation) {
                appliquerPermissionsHabilitation(habilitation);
            } else {
                decocherToutesPermissions();
            }
        });
    }
    
    // Ajouter l'√©couteur sur tous les checkboxes de permissions
    document.querySelectorAll('.perm-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', mettreAJourCompteurs);
    });
    
    // Initialiser les compteurs
    mettreAJourCompteurs();
    
    // Initialiser le filtrage des postes
    filterPostes();
    
    console.log('SUPPER Permissions Manager initialis√©');
    console.log('Total habilitations disponibles:', Object.keys(PERMISSIONS_PAR_HABILITATION).length);
    console.log('Total permissions:', TOUTES_PERMISSIONS.length);
});
</script>
{% endblock %}