{% extends "admin/base_site.html" %}
{% load static i18n %}

{% block title %}Modifier {{ user_edit.nom_complet }} - SUPPER{% endblock %}

{% block content %}
<style>
    .page-header {
        background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%) !important;
        color: white !important;
        border-radius: 12px !important;
        padding: 1.5rem 2rem !important;
        margin-bottom: 1.5rem !important;
        box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3) !important;
    }
    .form-container {
        background: white !important;
        border-radius: 12px !important;
        padding: 2rem !important;
        box-shadow: 0 2px 15px rgba(0, 0, 0, 0.08) !important;
        border: 1px solid #E2E8F0 !important;
    }
    .section-title {
        color: #8B5CF6 !important;
        border-bottom: 2px solid #E2E8F0 !important;
        padding-bottom: 0.75rem !important;
        margin-bottom: 1.5rem !important;
        font-weight: 600 !important;
        font-size: 1.1rem !important;
    }
    .form-label { font-weight: 600 !important; color: #334155 !important; margin-bottom: 0.5rem !important; }
    .form-control, .form-select {
        border: 2px solid #E2E8F0 !important;
        border-radius: 8px !important;
        padding: 0.75rem 1rem !important;
        transition: all 0.3s ease !important;
    }
    .form-control:focus, .form-select:focus {
        border-color: #8B5CF6 !important;
        box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.15) !important;
    }
    .form-control:disabled, .form-control[readonly] { background-color: #F1F5F9 !important; color: #64748B !important; }
    .btn-primary-gradient {
        background: linear-gradient(135deg, #8B5CF6, #7C3AED) !important;
        border: none !important; color: white !important;
        padding: 0.75rem 2rem !important; border-radius: 8px !important; font-weight: 600 !important;
    }
    .btn-primary-gradient:hover {
        background: linear-gradient(135deg, #7C3AED, #6D28D9) !important;
        transform: translateY(-2px) !important;
        box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4) !important;
    }
    .btn-secondary { background: #64748B !important; border: none !important; padding: 0.75rem 2rem !important; border-radius: 8px !important; font-weight: 600 !important; color: white !important; }
    .required { color: #EF4444 !important; }
    .help-text { font-size: 0.875rem !important; color: #64748B !important; margin-top: 0.25rem !important; }
    .user-badge { display: inline-flex !important; align-items: center !important; padding: 0.5rem 1rem !important; border-radius: 8px !important; font-size: 0.875rem !important; font-weight: 600 !important; }
    .user-badge.active { background: rgba(16, 185, 129, 0.2) !important; color: #059669 !important; }
    .user-badge.inactive { background: rgba(239, 68, 68, 0.2) !important; color: #DC2626 !important; }
    .user-info-card { background: linear-gradient(135deg, #F8FAFC 0%, #F1F5F9 100%) !important; border: 1px solid #E2E8F0 !important; border-radius: 12px !important; padding: 1.5rem !important; margin-bottom: 1.5rem !important; }
    .user-info-card .user-avatar { width: 80px !important; height: 80px !important; border-radius: 50% !important; background: linear-gradient(135deg, #8B5CF6, #7C3AED) !important; display: flex !important; align-items: center !important; justify-content: center !important; color: white !important; font-size: 2rem !important; font-weight: 700 !important; }
    .user-info-card .info-label { font-size: 0.75rem !important; color: #64748B !important; text-transform: uppercase !important; letter-spacing: 0.5px !important; }
    .user-info-card .info-value { font-weight: 600 !important; color: #334155 !important; }
    .filter-alert { border-radius: 8px !important; padding: 1rem !important; margin-bottom: 1rem !important; display: none; }
    .filter-alert-pesage { background: linear-gradient(135deg, #F3E8FF 0%, #E9D5FF 100%) !important; border: 1px solid #8B5CF6 !important; border-left: 4px solid #8B5CF6 !important; }
    .filter-alert-peage { background: linear-gradient(135deg, #DBEAFE 0%, #BFDBFE 100%) !important; border: 1px solid #3B82F6 !important; border-left: 4px solid #3B82F6 !important; }
    .filter-alert-multi { background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%) !important; border: 1px solid #F59E0B !important; border-left: 4px solid #F59E0B !important; }
    .postes-stats { display: flex !important; gap: 1rem !important; margin-bottom: 0.5rem !important; }
    .postes-stats .stat-item { font-size: 0.8rem !important; padding: 0.25rem 0.75rem !important; border-radius: 6px !important; background: #F1F5F9 !important; }
    .postes-stats .stat-item.peage { border-left: 3px solid #3B82F6 !important; }
    .postes-stats .stat-item.pesage { border-left: 3px solid #8B5CF6 !important; }
    .form-check-input:checked { background-color: #8B5CF6 !important; border-color: #8B5CF6 !important; }
    .accordion-button:not(.collapsed) { background: linear-gradient(135deg, #F5F3FF 0%, #EDE9FE 100%) !important; color: #6D28D9 !important; }
    .perm-count-badge { background: #8B5CF6 !important; color: white !important; font-size: 0.7rem !important; padding: 0.2rem 0.5rem !important; border-radius: 10px !important; margin-left: 0.5rem !important; }
    .permissions-controls { display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1rem; }
    .permissions-controls .btn { font-size: 0.8rem; padding: 0.4rem 0.8rem; }
    .alert-custom { border-radius: 8px; padding: 0.75rem 1rem; margin-bottom: 1rem; font-size: 0.9rem; }
    .alert-custom.warning { background: #FEF3C7; border: 1px solid #F59E0B; color: #92400E; }
</style>

<div class="container-fluid py-4">
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
            <div>
                <h2 class="mb-1" style="color: white;"><i class="fas fa-user-edit me-2"></i>Modifier l'utilisateur</h2>
                <p class="mb-0" style="opacity: 0.85; color: white;">{{ user_edit.nom_complet }} ({{ user_edit.username }})</p>
            </div>
            <div class="d-flex gap-2">
                <span class="user-badge {% if user_edit.is_active %}active{% else %}inactive{% endif %}">
                    <i class="fas fa-{% if user_edit.is_active %}check-circle{% else %}times-circle{% endif %} me-2"></i>
                    {% if user_edit.is_active %}Actif{% else %}Inactif{% endif %}
                </span>
                <a href="{% url 'accounts:user_list' %}" class="btn btn-light"><i class="fas fa-arrow-left me-2"></i>Retour</a>
            </div>
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-xl-10 col-lg-11">
            <!-- Carte info utilisateur -->
            <div class="user-info-card">
                <div class="row align-items-center">
                    <div class="col-auto">
                        <div class="user-avatar">{{ user_edit.nom_complet|slice:":1"|upper }}</div>
                    </div>
                    <div class="col">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="info-label">Matricule</div>
                                <div class="info-value">{{ user_edit.username }}</div>
                            </div>
                            <div class="col-md-3">
                                <div class="info-label">R√¥le actuel</div>
                                <div class="info-value">{{ user_edit.get_habilitation_display }}</div>
                            </div>
                            <div class="col-md-3">
                                <div class="info-label">Poste</div>
                                <div class="info-value">
                                    {% if user_edit.poste_affectation %}{{ user_edit.poste_affectation.nom }}{% else %}<span class="text-muted">Aucun</span>{% endif %}
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="info-label">Cr√©√© le</div>
                                <div class="info-value">{{ user_edit.date_joined|date:"d/m/Y" }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="form-container">
                <form method="post" enctype="multipart/form-data" id="form-modifier-utilisateur" novalidate>
                    {% csrf_token %}
                    
                    {% if messages %}{% for message in messages %}<div class="alert alert-{{ message.tags }} alert-dismissible fade show">{{ message }}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>{% endfor %}{% endif %}
                    {% if form.non_field_errors %}{% for error in form.non_field_errors %}<div class="alert alert-danger alert-dismissible fade show"><i class="fas fa-exclamation-triangle me-2"></i>{{ error }}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>{% endfor %}{% endif %}

                    <!-- Section Identification -->
                    <h5 class="section-title"><i class="fas fa-id-card me-2"></i>Identification</h5>
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label class="form-label">Matricule</label>
                            <input type="text" class="form-control" value="{{ user_edit.username }}" readonly disabled>
                            <div class="help-text"><i class="fas fa-lock me-1"></i>Le matricule ne peut pas √™tre modifi√©</div>
                        </div>
                        <div class="col-md-6">
                            <label for="id_nom_complet" class="form-label">Nom Complet <span class="required">*</span></label>
                            <input type="text" name="nom_complet" id="id_nom_complet" class="form-control {% if form.nom_complet.errors %}is-invalid{% endif %}" value="{{ user_edit.nom_complet }}" required>
                            {% if form.nom_complet.errors %}<div class="invalid-feedback">{{ form.nom_complet.errors.0 }}</div>{% endif %}
                        </div>
                    </div>

                    <!-- Section Contact -->
                    <h5 class="section-title"><i class="fas fa-address-book me-2"></i>Contact</h5>
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label for="id_telephone" class="form-label">T√©l√©phone <span class="required">*</span></label>
                            <input type="tel" name="telephone" id="id_telephone" class="form-control {% if form.telephone.errors %}is-invalid{% endif %}" value="{{ user_edit.telephone }}" required>
                            <div class="help-text">Format: +237XXXXXXXXX</div>
                            {% if form.telephone.errors %}<div class="invalid-feedback">{{ form.telephone.errors.0 }}</div>{% endif %}
                        </div>
                        <div class="col-md-6">
                            <label for="id_email" class="form-label">Email</label>
                            <input type="email" name="email" id="id_email" class="form-control {% if form.email.errors %}is-invalid{% endif %}" value="{{ user_edit.email|default:'' }}">
                            <div class="help-text">Optionnel</div>
                            {% if form.email.errors %}<div class="invalid-feedback">{{ form.email.errors.0 }}</div>{% endif %}
                        </div>
                    </div>

                    <!-- Section Affectation -->
                    <h5 class="section-title"><i class="fas fa-briefcase me-2"></i>Affectation Professionnelle</h5>
                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label for="id_habilitation" class="form-label">R√¥le / Habilitation <span class="required">*</span></label>
                            <select name="habilitation" id="id_habilitation" class="form-select" required>
                                <option value="">-- S√©lectionner --</option>
                                {% for value, label in habilitations %}
                                <option value="{{ value }}" {% if user_edit.habilitation == value %}selected{% endif %}>{{ label }}</option>
                                {% endfor %}
                            </select>
                            <div class="help-text">
                                <i class="fas fa-exclamation-triangle text-warning me-1"></i>
                                Changer le r√¥le r√©initialisera les permissions aux valeurs par d√©faut
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="id_poste_affectation" class="form-label" id="label-poste">Poste d'affectation</label>
                            <div class="postes-stats">
                                <span class="stat-item peage"><i class="fas fa-road me-1"></i>{{ count_peage }} p√©age</span>
                                <span class="stat-item pesage"><i class="fas fa-weight me-1"></i>{{ count_pesage }} pesage</span>
                            </div>
                            <select name="poste_affectation" id="id_poste_affectation" class="form-select">
                                <option value="">-- Aucun poste --</option>
                                <optgroup label="üîµ Postes de P√©age" id="optgroup-peage">
                                    {% for poste in postes_peage %}
                                    <option value="{{ poste.id }}" data-type="peage" {% if user_edit.poste_affectation_id == poste.id %}selected{% endif %}>{{ poste.nom }} ({{ poste.code }})</option>
                                    {% endfor %}
                                </optgroup>
                                <optgroup label="üü£ Stations de Pesage" id="optgroup-pesage">
                                    {% for poste in postes_pesage %}
                                    <option value="{{ poste.id }}" data-type="pesage" {% if user_edit.poste_affectation_id == poste.id %}selected{% endif %}>{{ poste.nom }} ({{ poste.code }})</option>
                                    {% endfor %}
                                </optgroup>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Alertes de filtrage -->
                    <div id="filter-alert-pesage" class="filter-alert filter-alert-pesage">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-weight me-3 fa-lg" style="color: #8B5CF6;"></i>
                            <div><strong>R√¥le Pesage</strong><br><small>Station de pesage <strong>obligatoire</strong>.</small></div>
                        </div>
                    </div>
                    <div id="filter-alert-peage" class="filter-alert filter-alert-peage">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-road me-3 fa-lg" style="color: #3B82F6;"></i>
                            <div><strong>R√¥le P√©age</strong><br><small>Poste de p√©age <strong>obligatoire</strong>.</small></div>
                        </div>
                    </div>
                    <div id="filter-alert-multi" class="filter-alert filter-alert-multi">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-globe me-3 fa-lg" style="color: #F59E0B;"></i>
                            <div><strong>R√¥le Administration</strong><br><small>Poste optionnel (tous postes accessibles).</small></div>
                        </div>
                    </div>

                    <!-- Statut du compte -->
                    <div class="row g-3 mb-4">
                        <div class="col-md-6">
                            <label for="id_is_active" class="form-label">Statut du compte</label>
                            <select name="is_active" id="id_is_active" class="form-select">
                                <option value="True" {% if user_edit.is_active %}selected{% endif %}>‚úÖ Actif</option>
                                <option value="False" {% if not user_edit.is_active %}selected{% endif %}>‚ùå Inactif</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Mot de passe</label>
                            <div class="d-flex gap-2">
                                <input type="text" class="form-control" value="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" readonly disabled>
                                <a href="{% url 'accounts:password_reset' user_edit.pk %}" class="btn btn-outline-secondary">
                                    <i class="fas fa-key me-1"></i>R√©initialiser
                                </a>
                            </div>
                        </div>
                    </div>

                    <!-- Section Permissions -->
                    <h5 class="section-title">
                        <i class="fas fa-shield-alt me-2"></i>Permissions Granulaires
                        <span id="permissions-count" class="badge bg-info ms-2">{{ count_permissions_actives }}/{{ total_permissions }}</span>
                    </h5>
                    
                    
                    <!-- Contr√¥les des permissions -->
                    <div class="permissions-controls">
                        <button type="button" class="btn btn-outline-success btn-sm" onclick="cocherToutesPermissions()">
                            <i class="fas fa-check-double me-1"></i>Tout cocher
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="decocherToutesPermissions()">
                            <i class="fas fa-times me-1"></i>Tout d√©cocher
                        </button>
                        <button type="button" class="btn btn-outline-warning btn-sm" onclick="reinitialiserPermissionsDefaut()">
                            <i class="fas fa-undo me-1"></i>R√©initialiser aux permissions du r√¥le
                        </button>
                    </div>
                    
                    <!-- Accord√©on des permissions par cat√©gorie -->
                    <div class="accordion" id="accordionPermissions">
                        {% for cat_id, cat in permissions_categories.items %}
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ cat_id }}">
                                    <i class="{{ cat.icon }} me-2"></i>{{ cat.label }}
                                    <span class="perm-count-badge" id="count-{{ cat_id }}">{{ cat.count_actives }}/{{ cat.count_total }}</span>
                                </button>
                            </h2>
                            <div id="collapse-{{ cat_id }}" class="accordion-collapse collapse" data-bs-parent="#accordionPermissions">
                                <div class="accordion-body">
                                    <div class="row">
                                        {% for perm in cat.permissions %}
                                        <div class="col-md-6">
                                            <div class="form-check mb-2">
                                                <input type="checkbox" 
                                                       class="form-check-input perm-checkbox" 
                                                       name="{{ perm.name }}" 
                                                       id="id_{{ perm.name }}"
                                                       data-category="{{ cat_id }}"
                                                       {% if perm.checked %}checked{% endif %}>
                                                <label class="form-check-label" for="id_{{ perm.name }}">{{ perm.label }}</label>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    <!-- Boutons de soumission -->
                    <div class="d-flex justify-content-end gap-3 mt-4 pt-3 border-top">
                        <a href="{% url 'accounts:user_list' %}" class="btn btn-secondary">
                            <i class="fas fa-times me-2"></i>Annuler
                        </a>
                        <button type="submit" class="btn btn-primary-gradient">
                            <i class="fas fa-save me-2"></i>Enregistrer les modifications
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// ===================================================================
// DONN√âES DES PERMISSIONS DEPUIS LE SERVEUR
// ===================================================================

// Dictionnaire des permissions par habilitation (g√©n√©r√© c√¥t√© serveur)
const PERMISSIONS_PAR_HABILITATION = {{ permissions_par_habilitation_json|safe }};

// Liste de toutes les permissions
const TOUTES_PERMISSIONS = {{ toutes_permissions_json|safe }};

// Habilitation actuelle de l'utilisateur (pour d√©tecter les changements)
const HABILITATION_INITIALE = "{{ user_edit.habilitation }}";

// Structure des cat√©gories pour les compteurs
const CATEGORIES = {
    {% for cat_id, cat in permissions_categories.items %}
    '{{ cat_id }}': {
        permissions: [{% for perm in cat.permissions %}'{{ perm.name }}'{% if not forloop.last %}, {% endif %}{% endfor %}]
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
};


// ===================================================================
// FONCTIONS DE GESTION DES PERMISSIONS
// ===================================================================

/**
 * Applique les permissions par d√©faut pour une habilitation
 */
function appliquerPermissionsHabilitation(habilitation) {
    // D'abord, d√©cocher toutes les permissions
    TOUTES_PERMISSIONS.forEach(perm => {
        const checkbox = document.getElementById('id_' + perm);
        if (checkbox) {
            checkbox.checked = false;
        }
    });
    
    // Puis cocher les permissions de l'habilitation
    const permissions = PERMISSIONS_PAR_HABILITATION[habilitation];
    if (permissions) {
        permissions.forEach(perm => {
            const checkbox = document.getElementById('id_' + perm);
            if (checkbox) {
                checkbox.checked = true;
            }
        });
    }
    
    mettreAJourCompteurs();
}

/**
 * Coche toutes les permissions
 */
function cocherToutesPermissions() {
    TOUTES_PERMISSIONS.forEach(perm => {
        const checkbox = document.getElementById('id_' + perm);
        if (checkbox) checkbox.checked = true;
    });
    mettreAJourCompteurs();
}

/**
 * D√©coche toutes les permissions
 */
function decocherToutesPermissions() {
    TOUTES_PERMISSIONS.forEach(perm => {
        const checkbox = document.getElementById('id_' + perm);
        if (checkbox) checkbox.checked = false;
    });
    mettreAJourCompteurs();
}

/**
 * R√©initialise aux permissions par d√©faut du r√¥le s√©lectionn√©
 */
function reinitialiserPermissionsDefaut() {
    const select = document.getElementById('id_habilitation');
    const habilitation = select ? select.value : '';
    
    if (!habilitation) {
        alert('Veuillez d\'abord s√©lectionner un r√¥le.');
        return;
    }
    
    if (confirm('Voulez-vous r√©initialiser les permissions aux valeurs par d√©faut du r√¥le "' + select.options[select.selectedIndex].text + '" ?')) {
        appliquerPermissionsHabilitation(habilitation);
    }
}

/**
 * Met √† jour tous les compteurs de permissions
 */
function mettreAJourCompteurs() {
    let totalActives = 0;
    
    // Compteur par cat√©gorie
    Object.keys(CATEGORIES).forEach(catId => {
        let countCat = 0;
        CATEGORIES[catId].permissions.forEach(perm => {
            const checkbox = document.getElementById('id_' + perm);
            if (checkbox && checkbox.checked) countCat++;
        });
        
        const badge = document.getElementById('count-' + catId);
        if (badge) {
            badge.textContent = countCat + '/' + CATEGORIES[catId].permissions.length;
        }
        totalActives += countCat;
    });
    
    // Compteur total
    const totalBadge = document.getElementById('permissions-count');
    if (totalBadge) {
        totalBadge.textContent = totalActives + '/{{ total_permissions }}';
        
        // Couleur selon le pourcentage
        totalBadge.className = 'badge ms-2 ';
        if (totalActives === 0) {
            totalBadge.className += 'bg-secondary';
        } else if (totalActives < {{ total_permissions }} * 0.3) {
            totalBadge.className += 'bg-warning';
        } else if (totalActives < {{ total_permissions }} * 0.7) {
            totalBadge.className += 'bg-info';
        } else {
            totalBadge.className += 'bg-success';
        }
    }
}


// ===================================================================
// FONCTIONS DE FILTRAGE DES POSTES
// ===================================================================

const ROLES_PESAGE = ['chef_station_pesage', 'regisseur_pesage', 'chef_equipe_pesage', 'cisop_pesage'];
const ROLES_PEAGE = ['chef_peage', 'agent_inventaire', 'cisop_peage'];
const ROLES_ADMIN = ['admin_principal', 'coord_psrr', 'serv_info', 'serv_emission', 'chef_ag', 'serv_controle', 'serv_ordre', 'imprimerie', 'comptable_mat'];

function filterPostes() {
    const hab = document.getElementById('id_habilitation').value;
    const optgroupPeage = document.getElementById('optgroup-peage');
    const optgroupPesage = document.getElementById('optgroup-pesage');
    const alertPesage = document.getElementById('filter-alert-pesage');
    const alertPeage = document.getElementById('filter-alert-peage');
    const alertMulti = document.getElementById('filter-alert-multi');
    
    // Cacher toutes les alertes
    alertPesage.style.display = 'none';
    alertPeage.style.display = 'none';
    alertMulti.style.display = 'none';
    
    // R√©afficher tous les optgroups
    optgroupPeage.style.display = '';
    optgroupPesage.style.display = '';
    
    if (ROLES_PESAGE.includes(hab)) {
        optgroupPeage.style.display = 'none';
        alertPesage.style.display = 'block';
    } else if (ROLES_PEAGE.includes(hab)) {
        optgroupPesage.style.display = 'none';
        alertPeage.style.display = 'block';
    } else if (ROLES_ADMIN.includes(hab)) {
        alertMulti.style.display = 'block';
    }
}


// ===================================================================
// INITIALISATION
// ===================================================================

document.addEventListener('DOMContentLoaded', function() {
    const habSelect = document.getElementById('id_habilitation');
    
    if (habSelect) {
        // G√©rer le changement d'habilitation
        habSelect.addEventListener('change', function() {
            const nouvelleHabilitation = this.value;
            
            // Filtrer les postes
            filterPostes();
            
            // Si l'habilitation a chang√©, demander confirmation avant de r√©initialiser
            if (nouvelleHabilitation && nouvelleHabilitation !== HABILITATION_INITIALE) {
                const nomRole = this.options[this.selectedIndex].text;
                if (confirm('Voulez-vous appliquer les permissions par d√©faut du r√¥le "' + nomRole + '" ?\n\nAttention: les permissions actuelles seront remplac√©es.')) {
                    appliquerPermissionsHabilitation(nouvelleHabilitation);
                }
            }
        });
    }
    
    // Ajouter l'√©couteur sur tous les checkboxes de permissions
    document.querySelectorAll('.perm-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', mettreAJourCompteurs);
    });
    
    // Initialiser les compteurs
    mettreAJourCompteurs();
    
    // Initialiser le filtrage des postes
    filterPostes();
    
    console.log('SUPPER Permissions Manager (modification) initialis√©');
    console.log('Habilitation initiale:', HABILITATION_INITIALE);
});
</script>
{% endblock %}