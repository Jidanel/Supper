{% extends "admin/base_site.html" %}
{% load static i18n %}

{% block title %}{% trans "Créer un Poste" %} - SUPPER{% endblock %}

{% block extra_css %}
<style>
    .form-section {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        margin-bottom: 1.5rem;
    }
    
    .form-group {
        margin-bottom: 1.5rem;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        color: #475569;
        font-weight: 500;
        font-size: 0.9rem;
    }
    
    .required-field::after {
        content: " *";
        color: #ef4444;
    }
    
    .form-control, .form-select {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        font-size: 1rem;
        transition: all 0.2s;
    }
    
    .form-control:focus, .form-select:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .form-help {
        display: block;
        margin-top: 0.25rem;
        font-size: 0.85rem;
        color: #64748B;
    }
    
    .section-title {
        font-size: 1.125rem;
        font-weight: 700;
        color: #0F172A;
        margin-bottom: 1.5rem;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid #f1f5f9;
    }
    
    .section-icon {
        color: #764ba2;
        margin-right: 0.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- En-tête -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-0">
                <i class="fas fa-plus-circle me-2" style="color: #764ba2;"></i>
                {% trans "Créer un Nouveau Poste" %}
            </h2>
            <p class="text-muted mt-2">
                {% trans "Ajoutez un nouveau poste de péage ou de pesage au système" %}
            </p>
        </div>
        <a href="{% url 'accounts:liste_postes' %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-2"></i>
            {% trans "Retour à la liste" %}
        </a>
    </div>

    <!-- Formulaire -->
    <div class="form-section">
        <form method="post" action="{% url 'accounts:creer_poste' %}">
            {% csrf_token %}
            
            <!-- Section Identification -->
            <h3 class="section-title">
                <i class="fas fa-id-card section-icon"></i>
                {% trans "Identification du Poste" %}
            </h3>
            
            <div class="row">
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="required-field">{% trans "Code du Poste" %}</label>
                        <input type="text" name="code" class="form-control" required 
                               placeholder="Ex: PG001, PS001" maxlength="10"
                               style="text-transform: uppercase;">
                        <small class="form-help">{% trans "Code unique (ex: PG001 pour péage, PS001 pour pesage)" %}</small>
                    </div>
                </div>
                
                <div class="col-md-3">
                    <div class="form-group">
                        <label class="required-field">{% trans "Type de Poste" %}</label>
                        <select name="type" class="form-select" required>
                            <option value="">-- {% trans "Sélectionner" %} --</option>
                            <option value="peage">{% trans "Poste de Péage" %}</option>
                            <option value="pesage">{% trans "Poste de Pesage" %}</option>
                        </select>
                    </div>
                </div>
                
                <div class="col-md-3">
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <div class="form-check mt-2">
                            <input type="checkbox" name="is_active" id="is_active" checked class="form-check-input">
                            <label for="is_active" class="form-check-label">{% trans "Poste actif" %}</label>
                        </div>
                    </div>
                </div>
                
                <div class="col-md-3">
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <div class="form-check mt-2">
                            <input type="checkbox" name="nouveau" id="nouveau" class="form-check-input">
                            <label for="nouveau" class="form-check-label">{% trans "Nouveau poste" %}</label>
                        </div>
                        <small class="form-help">{% trans "Cocher si nouveau pour l'année en cours" %}</small>
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label class="required-field">{% trans "Nom du Poste" %}</label>
                <input type="text" name="nom" class="form-control" required 
                       placeholder="Ex: Péage de Douala-Nord" maxlength="100">
            </div>
            
            <!-- Section Localisation -->
            <h3 class="section-title mt-4">
                <i class="fas fa-map-marker-alt section-icon"></i>
                {% trans "Localisation" %}
            </h3>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label class="required-field">{% trans "Région" %}</label>
                        <select name="region" id="id_region" class="form-select" required>
                            <option value="">-- {% trans "Sélectionner une région" %} --</option>
                            {% for region in regions %}
                            <option value="{{ region.id }}">{{ region.nom }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="form-group">
                        <label>{% trans "Département" %}</label>
                        <select name="departement" id="id_departement" class="form-select">
                            <option value="">-- {% trans "Sélectionner une région d'abord" %} --</option>
                        </select>
                        <small class="form-help">{% trans "Optionnel - Sélectionnez d'abord une région" %}</small>
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label>{% trans "Axe Routier" %}</label>
                <input type="text" name="axe_routier" class="form-control" 
                       placeholder="Ex: Yaoundé-Douala, Douala-Bafoussam" maxlength="100">
                <small class="form-help">{% trans "Axe routier où se situe le poste" %}</small>
            </div>
            
            <!-- Section Coordonnées GPS -->
            <h3 class="section-title mt-4">
                <i class="fas fa-globe section-icon"></i>
                {% trans "Coordonnées GPS" %} <span class="text-muted fw-normal">({% trans "optionnel" %})</span>
            </h3>
            
            <div class="row">
                <div class="col-md-6">
                    <div class="form-group">
                        <label>{% trans "Latitude" %}</label>
                        <input type="number" name="latitude" class="form-control" 
                               step="0.000001" min="-90" max="90"
                               placeholder="Ex: 3.848033">
                    </div>
                </div>
                
                <div class="col-md-6">
                    <div class="form-group">
                        <label>{% trans "Longitude" %}</label>
                        <input type="number" name="longitude" class="form-control" 
                               step="0.000001" min="-180" max="180"
                               placeholder="Ex: 11.502075">
                    </div>
                </div>
            </div>
            
            <!-- Section Description -->
            <h3 class="section-title mt-4">
                <i class="fas fa-align-left section-icon"></i>
                {% trans "Description" %}
            </h3>
            
            <div class="form-group">
                <textarea name="description" class="form-control" rows="4" 
                          placeholder="{% trans 'Description détaillée du poste et de sa situation...' %}"></textarea>
            </div>
            
            <!-- Actions -->
            <div class="d-flex gap-2 justify-content-end mt-4 pt-4" style="border-top: 1px solid #f1f5f9;">
                <a href="{% url 'accounts:liste_postes' %}" class="btn btn-secondary">
                    <i class="fas fa-times me-1"></i>
                    {% trans "Annuler" %}
                </a>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save me-1"></i>
                    {% trans "Créer le Poste" %}
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Données des départements pré-chargées (pas d'appel AJAX) -->
<script>
// Données chargées depuis Django - pas d'appel réseau
const departementsParRegion = {{ departements_par_region|safe }};

document.addEventListener('DOMContentLoaded', function() {
    const regionSelect = document.getElementById('id_region');
    const departementSelect = document.getElementById('id_departement');
    
    regionSelect.addEventListener('change', function() {
        const regionId = this.value;
        
        // Vider le select des départements
        departementSelect.innerHTML = '';
        
        if (!regionId) {
            departementSelect.innerHTML = '<option value="">-- Sélectionner une région d\'abord --</option>';
            return;
        }
        
        // Ajouter l'option par défaut
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = '-- Sélectionner un département --';
        departementSelect.appendChild(defaultOption);
        
        // Ajouter les départements de cette région
        const departements = departementsParRegion[regionId] || [];
        departements.forEach(function(dept) {
            const option = document.createElement('option');
            option.value = dept.id;
            option.textContent = dept.nom;
            departementSelect.appendChild(option);
        });
    });
    
    // Convertir le code en majuscules automatiquement
    const codeInput = document.querySelector('input[name="code"]');
    if (codeInput) {
        codeInput.addEventListener('input', function() {
            this.value = this.value.toUpperCase();
        });
    }
});
</script>
{% endblock %}