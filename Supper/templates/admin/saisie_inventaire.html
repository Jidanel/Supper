{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block title %}{{ title }} | {{ site_title|default:_('Django site admin') }}{% endblock %}

{% block extrahead %}
    {{ block.super }}
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .saisie-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 30px;
            margin-bottom: 20px;
        }
        
        .periode-input {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            transition: all 0.3s;
        }
        
        .periode-input:focus-within {
            border-color: #007cba;
            background: white;
            box-shadow: 0 0 0 0.2rem rgba(0, 124, 186, 0.25);
        }
        
        .periode-label {
            font-weight: bold;
            color: #495057;
            margin-bottom: 8px;
        }
        
        .periode-vehicules {
            width: 100%;
            border: none;
            background: transparent;
            font-size: 1.2rem;
            text-align: center;
            outline: none;
        }
        
        .total-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            margin: 20px 0;
        }
        
        .btn-submit {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            color: white;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .poste-selector {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 30px;
        }
        
        .breadcrumb {
            background: none;
            padding: 0;
            margin-bottom: 20px;
        }
        
        .page-header {
            background: linear-gradient(135deg, #17a2b8 0%, #6f42c1 100%);
            color: white;
            padding: 30px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        
        @media (max-width: 768px) {
            .saisie-card { padding: 20px; }
            .page-header { padding: 20px; }
        }
        
        .aide-saisie {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
    </style>
{% endblock %}

{% block content %}
<div class="page-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1 class="mb-2">
                <i class="fas fa-edit me-2"></i>
                {{ title }}
            </h1>
            <p class="mb-0">Interface de saisie rapide pour les administrateurs</p>
        </div>
        <div>
            <a href="{% url 'admin:dashboard' %}" class="btn btn-light">
                <i class="fas fa-arrow-left"></i> Retour Dashboard
            </a>
        </div>
    </div>
</div>

<!-- Fil d'Ariane -->
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item">
            <i class="fas fa-home"></i>
            <a href="{% url 'admin:index' %}">Administration</a>
        </li>
        <li class="breadcrumb-item">
            <a href="{% url 'admin:dashboard' %}">Dashboard</a>
        </li>
        <li class="breadcrumb-item active">
            <i class="fas fa-edit"></i>
            Saisie Inventaire
        </li>
    </ol>
</nav>

<!-- Messages -->
{% if messages %}
<div class="messages mb-4">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- Aide à la saisie -->
<div class="aide-saisie">
    <h6><i class="fas fa-info-circle"></i> Instructions de saisie</h6>
    <ul class="mb-0">
        <li>Sélectionnez le poste et la date pour l'inventaire</li>
        <li>Saisissez le nombre de véhicules pour chaque créneau horaire (0 à 1000)</li>
        <li>Les créneaux vides seront ignorés dans les calculs</li>
        <li>Le total se calcule automatiquement</li>
    </ul>
</div>

<form method="post" id="inventaire-form">
    {% csrf_token %}
    
    <!-- Sélection Poste et Date -->
    <div class="saisie-card">
        <h4><i class="fas fa-map-marker-alt text-primary"></i> Sélection du Poste</h4>
        
        <div class="row">
            <div class="col-md-6">
                <div class="poste-selector">
                    <label for="poste" class="form-label">
                        <strong>Poste :</strong>
                    </label>
                    <select name="poste" id="poste" class="form-select form-select-lg" required>
                        <option value="">-- Sélectionner un poste --</option>
                        {% for poste in postes %}
                        <option value="{{ poste.id }}">
                            {{ poste.nom }} ({{ poste.get_type_poste_display }})
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="col-md-6">
                <div class="poste-selector">
                    <label for="date" class="form-label">
                        <strong>Date :</strong>
                    </label>
                    <input type="date" name="date" id="date" class="form-control form-control-lg" 
                           value="{{ date_today|date:'Y-m-d' }}" required>
                </div>
            </div>
        </div>
    </div>

    <!-- Saisie par Périodes -->
    <div class="saisie-card">
        <h4><i class="fas fa-clock text-success"></i> Saisie par Créneaux Horaires</h4>
        
        <div class="row">
            <!-- Créneaux du matin -->
            <div class="col-lg-6">
                <h5 class="text-muted mb-3">
                    <i class="fas fa-sun"></i> Créneaux Matin
                </h5>
                
                {% for periode in periodes_matin %}
                <div class="periode-input">
                    <div class="periode-label">
                        <i class="fas fa-clock"></i> {{ periode }}
                    </div>
                    <input type="number" 
                           name="periode_{{ periode }}" 
                           class="periode-vehicules" 
                           placeholder="Nombre de véhicules"
                           min="0" 
                           max="1000"
                           onchange="calculateTotal()">
                </div>
                {% endfor %}
            </div>
            
            <!-- Créneaux de l'après-midi -->
            <div class="col-lg-6">
                <h5 class="text-muted mb-3">
                    <i class="fas fa-sun"></i> Créneaux Après-midi
                </h5>
                
                {% for periode in periodes_apresmidi %}
                <div class="periode-input">
                    <div class="periode-label">
                        <i class="fas fa-clock"></i> {{ periode }}
                    </div>
                    <input type="number" 
                           name="periode_{{ periode }}" 
                           class="periode-vehicules" 
                           placeholder="Nombre de véhicules"
                           min="0" 
                           max="1000"
                           onchange="calculateTotal()">
                </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- Affichage du Total -->
        <div class="total-display">
            <h3><i class="fas fa-calculator"></i> Récapitulatif</h3>
            <div class="row text-center">
                <div class="col-md-4">
                    <h2 id="total-vehicules">0</h2>
                    <small>Total Véhicules</small>
                </div>
                <div class="col-md-4">
                    <h2 id="nb-periodes">0</h2>
                    <small>Périodes Saisies</small>
                </div>
                <div class="col-md-4">
                    <h2 id="moyenne-horaire">0</h2>
                    <small>Moyenne/Heure</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Observations -->
    <div class="saisie-card">
        <h4><i class="fas fa-sticky-note text-warning"></i> Observations (Optionnel)</h4>
        <textarea name="observations" class="form-control" rows="3" 
                  placeholder="Notes particulières sur cet inventaire..."></textarea>
    </div>

    <!-- Boutons d'action -->
    <div class="saisie-card text-center">
        <button type="submit" class="btn btn-submit btn-lg me-3">
            <i class="fas fa-save"></i> Enregistrer l'Inventaire
        </button>
        <button type="button" class="btn btn-secondary btn-lg" onclick="resetForm()">
            <i class="fas fa-undo"></i> Réinitialiser
        </button>
    </div>
</form>

<!-- Modal de confirmation -->
<div class="modal fade" id="confirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-check-circle text-success"></i>
                    Confirmer la saisie
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Vous êtes sur le point d'enregistrer l'inventaire suivant :</p>
                <ul>
                    <li><strong>Poste :</strong> <span id="confirm-poste"></span></li>
                    <li><strong>Date :</strong> <span id="confirm-date"></span></li>
                    <li><strong>Total véhicules :</strong> <span id="confirm-total"></span></li>
                    <li><strong>Périodes saisies :</strong> <span id="confirm-periodes"></span></li>
                </ul>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    Une fois enregistré, cet inventaire pourra être verrouillé.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    Annuler
                </button>
                <button type="button" class="btn btn-success" onclick="submitForm()">
                    <i class="fas fa-check"></i> Confirmer
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Initialisation
document.addEventListener('DOMContentLoaded', function() {
    // Auto-calcul initial
    calculateTotal();
    
    // Validation du formulaire
    setupFormValidation();
});

// Calcul automatique du total
function calculateTotal() {
    let total = 0;
    let periodesRenseignees = 0;
    
    // Parcourir tous les inputs de période
    document.querySelectorAll('.periode-vehicules').forEach(input => {
        const value = parseInt(input.value) || 0;
        if (value > 0) {
            total += value;
            periodesRenseignees++;
        }
    });
    
    // Calculer la moyenne horaire
    const moyenne = periodesRenseignees > 0 ? (total / periodesRenseignees).toFixed(1) : 0;
    
    // Mettre à jour l'affichage
    document.getElementById('total-vehicules').textContent = total;
    document.getElementById('nb-periodes').textContent = periodesRenseignees;
    document.getElementById('moyenne-horaire').textContent = moyenne;
    
    // Animation des changements
    animateCounter('total-vehicules');
    animateCounter('nb-periodes');
    animateCounter('moyenne-horaire');
}

// Animation des compteurs
function animateCounter(elementId) {
    const element = document.getElementById(elementId);
    element.style.transform = 'scale(1.2)';
    element.style.color = '#ffc107';
    
    setTimeout(() => {
        element.style.transform = 'scale(1)';
        element.style.color = 'white';
    }, 300);
}

// Configuration de la validation du formulaire
function setupFormValidation() {
    const form = document.getElementById('inventaire-form');
    
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Validation des champs obligatoires
        const poste = document.getElementById('poste').value;
        const date = document.getElementById('date').value;
        
        if (!poste || !date) {
            alert('Veuillez sélectionner un poste et une date.');
            return;
        }
        
        // Vérification qu'au moins une période est renseignée
        const total = parseInt(document.getElementById('total-vehicules').textContent);
        if (total === 0) {
            if (!confirm('Aucune période n\'est renseignée. Voulez-vous continuer ?')) {
                return;
            }
        }
        
        // Afficher la modal de confirmation
        showConfirmModal();
    });
}

// Afficher la modal de confirmation
function showConfirmModal() {
    const posteSelect = document.getElementById('poste');
    const posteText = posteSelect.options[posteSelect.selectedIndex].text;
    const dateValue = document.getElementById('date').value;
    const total = document.getElementById('total-vehicules').textContent;
    const periodes = document.getElementById('nb-periodes').textContent;
    
    // Formater la date
    const dateObj = new Date(dateValue);
    const dateFormatted = dateObj.toLocaleDateString('fr-FR');
    
    // Remplir la modal
    document.getElementById('confirm-poste').textContent = posteText;
    document.getElementById('confirm-date').textContent = dateFormatted;
    document.getElementById('confirm-total').textContent = total;
    document.getElementById('confirm-periodes').textContent = periodes;
    
    // Afficher la modal
    const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
    modal.show();
}

// Soumettre le formulaire après confirmation
function submitForm() {
    const form = document.getElementById('inventaire-form');
    
    // Désactiver le bouton pour éviter les doubles soumissions
    const submitBtn = form.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enregistrement...';
    
    // Soumettre le formulaire
    form.submit();
}

// Réinitialiser le formulaire
function resetForm() {
    if (confirm('Êtes-vous sûr de vouloir réinitialiser le formulaire ?')) {
        document.getElementById('inventaire-form').reset();
        calculateTotal();
        
        // Focus sur le premier champ
        document.getElementById('poste').focus();
    }
}

// Gestion du changement de poste (pour futures améliorations)
document.getElementById('poste').addEventListener('change', function() {
    const posteId = this.value;
    if (posteId) {
        // Ici on pourrait charger des données spécifiques au poste
        // Par exemple, vérifier s'il y a déjà un inventaire pour cette date
        checkExistingInventaire(posteId);
    }
});

// Vérifier l'existence d'un inventaire (fonction placeholder)
function checkExistingInventaire(posteId) {
    const date = document.getElementById('date').value;
    if (!date) return;
    
    // Cette fonction pourrait être développée pour faire un appel AJAX
    // et vérifier s'il existe déjà un inventaire pour ce poste/date
    console.log(`Vérification inventaire pour poste ${posteId} le ${date}`);
}

// Gestion du changement de date
document.getElementById('date').addEventListener('change', function() {
    const posteId = document.getElementById('poste').value;
    if (posteId) {
        checkExistingInventaire(posteId);
    }
});

// Validation en temps réel des champs numériques
document.querySelectorAll('.periode-vehicules').forEach(input => {
    input.addEventListener('input', function() {
        // Limiter à 4 chiffres maximum
        if (this.value.length > 4) {
            this.value = this.value.slice(0, 4);
        }
        
        // Vérifier les limites
        const value = parseInt(this.value);
        if (value > 1000) {
            this.value = 1000;
        } else if (value < 0) {
            this.value = 0;
        }
        
        // Highlight du champ modifié
        this.style.background = '#e3f2fd';
        setTimeout(() => {
            this.style.background = 'transparent';
        }, 500);
    });
    
    // Animation au focus
    input.addEventListener('focus', function() {
        this.closest('.periode-input').style.transform = 'scale(1.02)';
    });
    
    input.addEventListener('blur', function() {
        this.closest('.periode-input').style.transform = 'scale(1)';
    });
});

// Raccourcis clavier
document.addEventListener('keydown', function(e) {
    // Ctrl+S pour sauvegarder
    if (e.ctrlKey && e.key === 's') {
        e.preventDefault();
        document.getElementById('inventaire-form').dispatchEvent(new Event('submit'));
    }
    
    // Ctrl+R pour réinitialiser
    if (e.ctrlKey && e.key === 'r') {
        e.preventDefault();
        resetForm();
    }
});
</script>
{% endblock %}