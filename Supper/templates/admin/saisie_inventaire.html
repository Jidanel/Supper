<!-- ===================================================================
     CORRECTION du fichier templates/admin/saisie_inventaire.html
     üìÑ REMPLACE le contenu existant - ERREURS CORRIG√âES
     ================================================================= -->

{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}Saisie d'Inventaire - SUPPER{% endblock %}

{% block extrastyle %}
{{ block.super }}
<style>
/* Variables CSS modernes */
:root {
    --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --success-gradient: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
    --warning-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    --info-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    --shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    --shadow-hover: 0 12px 48px rgba(0, 0, 0, 0.15);
    --border-radius: 16px;
    --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

body {
    background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
    min-height: 100vh;
}

/* Page Header avec design technologique */
.page-header-tech {
    background: var(--primary-gradient);
    color: white;
    padding: 2rem 0;
    margin: -20px -20px 30px -20px;
    border-radius: 0 0 var(--border-radius) var(--border-radius);
    position: relative;
    overflow: hidden;
}

.page-header-tech::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="2" fill="rgba(255,255,255,0.1)"/></svg>') repeat;
    opacity: 0.3;
}

.page-header-tech .container {
    position: relative;
    z-index: 1;
}

/* Cartes modernes avec glassmorphism */
.modern-card {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: var(--border-radius);
    box-shadow: var(--shadow);
    padding: 2rem;
    margin-bottom: 2rem;
    transition: var(--transition);
}

.modern-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-hover);
}

/* Inputs de p√©riode avec animation */
.periode-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
    margin: 2rem 0;
}

.periode-input-modern {
    background: linear-gradient(145deg, #ffffff, #f0f4f8);
    border: 2px solid transparent;
    border-radius: 12px;
    padding: 1.5rem;
    transition: var(--transition);
    position: relative;
    overflow: hidden;
}

.periode-input-modern::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 2px;
    background: var(--primary-gradient);
    transition: left 0.5s ease;
}

.periode-input-modern:hover::before,
.periode-input-modern:focus-within::before {
    left: 0;
}

.periode-input-modern:focus-within {
    border-color: #667eea;
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.2);
}

.periode-label-modern {
    display: flex;
    align-items: center;
    font-weight: 600;
    color: #4a5568;
    margin-bottom: 1rem;
    font-size: 0.95rem;
}

.periode-input-field {
    width: 100%;
    border: none;
    background: transparent;
    font-size: 1.5rem;
    font-weight: 700;
    text-align: center;
    color: #2d3748;
    padding: 0.5rem;
    border-radius: 8px;
    transition: var(--transition);
}

.periode-input-field:focus {
    outline: none;
    background: rgba(102, 126, 234, 0.1);
}

/* Panneau de totaux avec design futuriste */
.totaux-panel {
    background: var(--primary-gradient);
    color: white;
    border-radius: var(--border-radius);
    padding: 2rem;
    position: sticky;
    top: 100px;
    box-shadow: var(--shadow);
}

.stat-item {
    text-align: center;
    padding: 1rem 0;
    border-bottom: 1px solid rgba(255, 255, 255, 0.2);
}

.stat-item:last-child {
    border-bottom: none;
}

.stat-number {
    font-size: 2.5rem;
    font-weight: 800;
    margin-bottom: 0.5rem;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.stat-label {
    font-size: 0.9rem;
    opacity: 0.9;
    text-transform: uppercase;
    letter-spacing: 1px;
}

/* Boutons avec effets modernes */
.btn-modern {
    background: var(--success-gradient);
    border: none;
    border-radius: 50px;
    padding: 1rem 2rem;
    font-weight: 600;
    font-size: 1.1rem;
    color: white;
    text-transform: uppercase;
    letter-spacing: 1px;
    transition: var(--transition);
    position: relative;
    overflow: hidden;
}

.btn-modern::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    transition: left 0.5s;
}

.btn-modern:hover::before {
    left: 100%;
}

.btn-modern:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 30px rgba(86, 171, 47, 0.4);
    color: white;
}

.btn-secondary-modern {
    background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
}

.btn-secondary-modern:hover {
    box-shadow: 0 10px 30px rgba(108, 117, 125, 0.4);
}

/* S√©lecteurs avec style moderne */
.select-modern {
    background: rgba(255, 255, 255, 0.9);
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    padding: 1rem 1.5rem;
    font-size: 1.1rem;
    font-weight: 500;
    transition: var(--transition);
}

.select-modern:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    transform: translateY(-1px);
}

/* Alerts avec design moderne */
.alert-modern {
    background: rgba(255, 255, 255, 0.9);
    backdrop-filter: blur(10px);
    border: none;
    border-left: 4px solid #667eea;
    border-radius: var(--border-radius);
    padding: 1.5rem;
    box-shadow: var(--shadow);
}

/* Animations */
@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

.animate-pulse {
    animation: pulse 0.6s ease-in-out;
}

@keyframes slideInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.slide-in-up {
    animation: slideInUp 0.6s ease-out;
}

/* Progress bar moderne */
.progress-modern {
    height: 8px;
    background: rgba(255, 255, 255, 0.3);
    border-radius: 4px;
    overflow: hidden;
    margin: 1rem 0;
}

.progress-bar-modern {
    height: 100%;
    background: linear-gradient(90deg, #56ab2f, #a8e6cf);
    border-radius: 4px;
    transition: width 0.5s ease;
}

/* Responsive design */
@media (max-width: 768px) {
    .periode-container {
        grid-template-columns: 1fr;
    }
    
    .totaux-panel {
        position: static;
        margin-top: 2rem;
    }
    
    .page-header-tech {
        margin: -15px -15px 20px -15px;
        padding: 1.5rem 0;
    }
    
    .modern-card {
        padding: 1.5rem;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="inventaire-saisie-container">
    <!-- En-t√™te moderne -->
    <div class="page-header-tech">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1 class="display-5 fw-bold mb-2">
                        <i class="fas fa-clipboard-list me-3"></i>
                        Saisie d'Inventaire Journalier
                    </h1>
                    <p class="lead mb-0 opacity-75">
                        Interface de saisie par cr√©neaux horaires avec calculs automatiques
                    </p>
                </div>
                <div class="col-md-4 text-md-end">
                    <a href="{% url 'admin:index' %}" class="btn btn-light btn-lg">
                        <i class="fas fa-arrow-left me-2"></i>
                        Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Messages -->
    {% if messages %}
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show alert-modern mb-4">
            <i class="fas fa-{% if message.tags == 'success' %}check-circle{% elif message.tags == 'error' %}exclamation-triangle{% else %}info-circle{% endif %} me-2"></i>
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endfor %}
    {% endif %}

    <!-- Instructions -->
    <div class="alert-modern mb-4">
        <h6 class="fw-bold mb-2">
            <i class="fas fa-lightbulb text-warning me-2"></i>
            Instructions de saisie
        </h6>
        <ul class="mb-0 small">
            <li>S√©lectionnez le poste et la date d'inventaire</li>
            <li>Saisissez le nombre de v√©hicules par p√©riode (0 √† 1000)</li>
            <li>Les totaux se calculent en temps r√©el</li>
            <li>Utilisez le bouton "Sauvegarder" pour enregistrer</li>
        </ul>
    </div>

    <form method="post" id="inventaireForm" class="slide-in-up">
        {% csrf_token %}
        
        <!-- S√©lection Poste et Date -->
        <div class="modern-card">
            <h4 class="fw-bold mb-4">
                <i class="fas fa-map-marker-alt text-primary me-2"></i>
                Configuration de l'Inventaire
            </h4>
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="poste" class="form-label fw-semibold">
                        <i class="fas fa-building me-2"></i>
                        S√©lectionner le Poste
                    </label>
                    <select name="poste" id="poste" class="form-select select-modern" required>
                        <option value="">Choisir un poste...</option>
                        {% for poste in postes %}
                            <option value="{{ poste.id }}">
                                {{ poste.nom }} - {{ poste.get_type_poste_display }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="col-md-6 mb-3">
                    <label for="date" class="form-label fw-semibold">
                        <i class="fas fa-calendar-alt me-2"></i>
                        Date de l'Inventaire
                    </label>
                    <input type="date" name="date" id="date" class="form-control select-modern" 
                           value="{% now 'Y-m-d' %}" required>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Saisie par p√©riodes -->
            <div class="col-lg-8">
                <div class="modern-card">
                    <h4 class="fw-bold mb-4">
                        <i class="fas fa-clock text-success me-2"></i>
                        Saisie par Cr√©neaux Horaires
                    </h4>
                    
                    <div class="periode-container">
                        <!-- P√©riodes cod√©es en dur pour √©viter l'erreur -->
                        <div class="periode-input-modern">
                            <div class="periode-label-modern">
                                <i class="fas fa-clock me-2 text-primary"></i>
                                <span>08h-09h</span>
                            </div>
                            <input type="number" name="vehicules_0809" class="periode-input-field" 
                                   placeholder="0" min="0" max="1000" data-periode="08h-09h">
                        </div>
                        
                        <div class="periode-input-modern">
                            <div class="periode-label-modern">
                                <i class="fas fa-clock me-2 text-primary"></i>
                                <span>09h-10h</span>
                            </div>
                            <input type="number" name="vehicules_0910" class="periode-input-field" 
                                   placeholder="0" min="0" max="1000" data-periode="09h-10h">
                        </div>
                        
                        <div class="periode-input-modern">
                            <div class="periode-label-modern">
                                <i class="fas fa-clock me-2 text-primary"></i>
                                <span>10h-11h</span>
                            </div>
                            <input type="number" name="vehicules_1011" class="periode-input-field" 
                                   placeholder="0" min="0" max="1000" data-periode="10h-11h">
                        </div>
                        
                        <div class="periode-input-modern">
                            <div class="periode-label-modern">
                                <i class="fas fa-clock me-2 text-primary"></i>
                                <span>11h-12h</span>
                            </div>
                            <input type="number" name="vehicules_1112" class="periode-input-field" 
                                   placeholder="0" min="0" max="1000" data-periode="11h-12h">
                        </div>
                        
                        <div class="periode-input-modern">
                            <div class="periode-label-modern">
                                <i class="fas fa-clock me-2 text-primary"></i>
                                <span>12h-13h</span>
                            </div>
                            <input type="number" name="vehicules_1213" class="periode-input-field" 
                                   placeholder="0" min="0" max="1000" data-periode="12h-13h">
                        </div>
                        
                        <div class="periode-input-modern">
                            <div class="periode-label-modern">
                                <i class="fas fa-clock me-2 text-primary"></i>
                                <span>13h-14h</span>
                            </div>
                            <input type="number" name="vehicules_1314" class="periode-input-field" 
                                   placeholder="0" min="0" max="1000" data-periode="13h-14h">
                        </div>
                        
                        <div class="periode-input-modern">
                            <div class="periode-label-modern">
                                <i class="fas fa-clock me-2 text-primary"></i>
                                <span>14h-15h</span>
                            </div>
                            <input type="number" name="vehicules_1415" class="periode-input-field" 
                                   placeholder="0" min="0" max="1000" data-periode="14h-15h">
                        </div>
                        
                        <div class="periode-input-modern">
                            <div class="periode-label-modern">
                                <i class="fas fa-clock me-2 text-primary"></i>
                                <span>15h-16h</span>
                            </div>
                            <input type="number" name="vehicules_1516" class="periode-input-field" 
                                   placeholder="0" min="0" max="1000" data-periode="15h-16h">
                        </div>
                        
                        <div class="periode-input-modern">
                            <div class="periode-label-modern">
                                <i class="fas fa-clock me-2 text-primary"></i>
                                <span>16h-17h</span>
                            </div>
                            <input type="number" name="vehicules_1617" class="periode-input-field" 
                                   placeholder="0" min="0" max="1000" data-periode="16h-17h">
                        </div>
                        
                        <div class="periode-input-modern">
                            <div class="periode-label-modern">
                                <i class="fas fa-clock me-2 text-primary"></i>
                                <span>17h-18h</span>
                            </div>
                            <input type="number" name="vehicules_1718" class="periode-input-field" 
                                   placeholder="0" min="0" max="1000" data-periode="17h-18h">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Panneau des totaux -->
            <div class="col-lg-4">
                <div class="totaux-panel">
                    <h5 class="fw-bold mb-3 text-center">
                        <i class="fas fa-calculator me-2"></i>
                        Calculs Automatiques
                    </h5>
                    
                    <div class="stat-item">
                        <div class="stat-number" id="totalVehicules">0</div>
                        <div class="stat-label">Total V√©hicules</div>
                    </div>
                    
                    <div class="stat-item">
                        <div class="stat-number" id="periodesSaisies">0</div>
                        <div class="stat-label">P√©riodes Saisies</div>
                    </div>
                    
                    <div class="stat-item">
                        <div class="stat-number" id="moyenneHoraire">0</div>
                        <div class="stat-label">Moyenne/Heure</div>
                    </div>
                    
                    <div class="stat-item">
                        <div class="stat-number" id="estimation24h">0</div>
                        <div class="stat-label">Estimation 24H</div>
                    </div>
                    
                    <div class="progress-modern">
                        <div class="progress-bar-modern" id="progressBar" style="width: 0%"></div>
                    </div>
                    
                    <div class="d-grid gap-2 mt-4">
                        <button type="submit" name="sauvegarder" class="btn btn-modern">
                            <i class="fas fa-save me-2"></i>
                            Sauvegarder
                        </button>
                        
                        <button type="submit" name="verrouiller" class="btn btn-modern" 
                                onclick="return confirm('Attention ! Une fois verrouill√©, l\'inventaire ne pourra plus √™tre modifi√©. Continuer ?')">
                            <i class="fas fa-lock me-2"></i>
                            Sauvegarder et Verrouiller
                        </button>
                        
                        <button type="button" class="btn btn-secondary-modern" onclick="resetForm()">
                            <i class="fas fa-undo me-2"></i>
                            R√©initialiser
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Observations -->
        <div class="modern-card">
            <h5 class="fw-bold mb-3">
                <i class="fas fa-sticky-note text-warning me-2"></i>
                Observations (Optionnel)
            </h5>
            <textarea name="observations" class="form-control select-modern" rows="3" 
                      placeholder="Notes particuli√®res sur cet inventaire..."></textarea>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Interface de saisie initialis√©e');
    
    // √âl√©ments DOM
    const inputs = document.querySelectorAll('.periode-input-field');
    const totalElement = document.getElementById('totalVehicules');
    const periodesElement = document.getElementById('periodesSaisies');
    const moyenneElement = document.getElementById('moyenneHoraire');
    const estimation24hElement = document.getElementById('estimation24h');
    const progressBar = document.getElementById('progressBar');
    
    // Variables de calcul
    let totalVehicules = 0;
    let periodesSaisies = 0;
    const totalPeriodes = 10; // 10 p√©riodes de 8h √† 18h
    
    // √âcouteurs d'√©v√©nements
    inputs.forEach(input => {
        input.addEventListener('input', function() {
            updateCalculations();
            this.closest('.periode-input-modern').classList.add('animate-pulse');
            setTimeout(() => {
                this.closest('.periode-input-modern').classList.remove('animate-pulse');
            }, 600);
        });
        
        input.addEventListener('focus', function() {
            this.select();
        });
    });
    
    // Fonction de calcul principal
    function updateCalculations() {
        totalVehicules = 0;
        periodesSaisies = 0;
        
        inputs.forEach(input => {
            const value = parseInt(input.value) || 0;
            if (value > 0) {
                totalVehicules += value;
                periodesSaisies++;
            }
        });
        
        // Calculs
        const moyenne = periodesSaisies > 0 ? totalVehicules / periodesSaisies : 0;
        const estimation24h = moyenne * 24;
        const progress = (periodesSaisies / totalPeriodes) * 100;
        
        // Mise √† jour affichage avec animation
        animateValue(totalElement, totalVehicules);
        animateValue(periodesElement, periodesSaisies);
        animateValue(moyenneElement, moyenne.toFixed(1));
        animateValue(estimation24hElement, Math.round(estimation24h));
        
        // Barre de progression
        progressBar.style.width = progress + '%';
        
        console.log('üìä Calculs mis √† jour:', {
            total: totalVehicules,
            periodes: periodesSaisies,
            moyenne: moyenne.toFixed(1),
            estimation: Math.round(estimation24h)
        });
    }
    
    // Animation des valeurs
    function animateValue(element, newValue) {
        element.style.transform = 'scale(1.1)';
        element.style.color = '#ffd700';
        element.textContent = newValue;
        
        setTimeout(() => {
            element.style.transform = 'scale(1)';
            element.style.color = 'white';
        }, 300);
    }
    
    // Validation du formulaire
    document.getElementById('inventaireForm').addEventListener('submit', function(e) {
        const poste = document.getElementById('poste').value;
        const date = document.getElementById('date').value;
        
        if (!poste || !date) {
            e.preventDefault();
            alert('‚ö†Ô∏è Veuillez s√©lectionner un poste et une date.');
            return false;
        }
        
        if (totalVehicules === 0) {
            if (!confirm('‚ö†Ô∏è Aucun v√©hicule saisi. Voulez-vous continuer ?')) {
                e.preventDefault();
                return false;
            }
        }
        
        // Animation de soumission
        const submitBtn = e.submitter || this.querySelector('button[type="submit"]');
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Enregistrement...';
        submitBtn.disabled = true;
        
        console.log('‚úÖ Formulaire soumis:', {
            poste: poste,
            date: date,
            total: totalVehicules,
            periodes: periodesSaisies
        });
    });
    
    // Fonction de r√©initialisation
    window.resetForm = function() {
        if (confirm('üîÑ √ätes-vous s√ªr de vouloir r√©initialiser le formulaire ?')) {
            document.getElementById('inventaireForm').reset();
            updateCalculations();
            document.getElementById('poste').focus();
        }
    };
    
    // Raccourcis clavier
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.key === 's') {
            e.preventDefault();
            document.getElementById('inventaireForm').dispatchEvent(new Event('submit'));
        }
    });
    
    // Navigation avec les fl√®ches
    inputs.forEach((input, index) => {
        input.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === 'ArrowDown') {
                e.preventDefault();
                const nextInput = inputs[index + 1];
                if (nextInput) nextInput.focus();
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                const prevInput = inputs[index - 1];
                if (prevInput) prevInput.focus();
            }
        });
    });
    
    // Initialisation
    updateCalculations();
    
    // Animation d'entr√©e
    setTimeout(() => {
        document.querySelectorAll('.periode-input-modern').forEach((el, i) => {
            setTimeout(() => {
                el.style.opacity = '0';
                el.style.transform = 'translateY(20px)';
                el.style.transition = 'all 0.5s ease';
                el.style.opacity = '1';
                el.style.transform = 'translateY(0)';
            }, i * 100);
        });
    }, 200);
});
</script>
{% endblock %}