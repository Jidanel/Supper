{% extends "admin/base_site.html" %}
{% load static %}
{% load i18n %}
{% load inventaire_extras %}
{% comment %}
===================================================================
templates/admin/index.html - Template Dashboard SUPPER CORRIG√â
Avec conditions de permissions granulaires
CHEMIN: Supper/templates/admin/index.html
===================================================================


PERMISSIONS UTILIS√âES:
- can_view_global_stats : Stats utilisateurs/postes
- can_view_inventaires : Stats inventaires
- can_view_recettes_peage : Stats recettes p√©age
- can_view_objectifs : Objectifs annuels
- can_view_graphs : Graphiques √©volution
- can_view_classement : Top postes / classements
- has_pesage_access : Section pesage
- user_permissions.gestion.peut_voir_journal_audit : Activit√©s syst√®me
{% endcomment %}



{% block title %}{{ title }} - SUPPER{% endblock %}

{% block content %}
<!-- STYLES INT√âGR√âS DIRECTEMENT -->
<style>
    /* Reset et base */
    .supper-dashboard * { box-sizing: border-box; }
    
    .supper-dashboard {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: linear-gradient(180deg, #f8fafc 0%, #ffffff 100%);
        min-height: calc(100vh - 80px);
        padding: 1.5rem;
        margin: -20px;
        margin-top: 0;
    }
    
    .supper-container {
        max-width: 1600px;
        margin: 0 auto;
    }
    
    /* Header */
    .supper-header {
        background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%);
        border-radius: 16px;
        padding: 1.5rem 2rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 1rem;
        color: #fff;
    }
    
    .supper-header h1 {
        margin: 0;
        font-size: 1.75rem;
        font-weight: 800;
        color: #fff;
    }
    
    .supper-header-sub {
        color: rgba(255,255,255,0.9);
        font-size: 0.95rem;
        margin-top: 0.25rem;
    }
    
    .supper-header-sub strong {
        color: #fff;
        font-weight: 600;
    }
    
    .supper-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1rem;
        background: rgba(255,255,255,0.2);
        border-radius: 50px;
        font-size: 0.8rem;
        color: #fff;
    }
    
    /* Actions Grid */
    .supper-actions {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }
    
    .supper-action-card {
        background: #fff;
        border-radius: 12px;
        padding: 1.25rem;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 1rem;
        box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        border: 1px solid #e2e8f0;
        transition: all 0.2s ease;
    }
    
    .supper-action-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 25px -5px rgba(0,0,0,0.15);
        border-color: #3b82f6;
    }
    
    .supper-action-icon {
        width: 48px;
        height: 48px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
        color: #fff;
        flex-shrink: 0;
    }
    
    .supper-action-icon.primary { background: linear-gradient(135deg, #1e40af, #3b82f6); }
    .supper-action-icon.success { background: linear-gradient(135deg, #059669, #10b981); }
    .supper-action-icon.warning { background: linear-gradient(135deg, #d97706, #f59e0b); }
    .supper-action-icon.danger { background: linear-gradient(135deg, #dc2626, #ef4444); }
    .supper-action-icon.info { background: linear-gradient(135deg, #0891b2, #22d3ee); }
    .supper-action-icon.secondary { background: linear-gradient(135deg, #475569, #64748b); }
    
    .supper-action-text {
        font-weight: 600;
        font-size: 0.9rem;
        color: #1e293b;
    }
    
    /* Stats Grid */
    .supper-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
    }
    
    .supper-stat-card {
        background: #fff;
        border-radius: 12px;
        padding: 1.25rem;
        box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        border: 1px solid #e2e8f0;
        position: relative;
        overflow: hidden;
    }
    
    .supper-stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
    }
    
    .supper-stat-card.blue::before { background: linear-gradient(90deg, #1e40af, #3b82f6); }
    .supper-stat-card.cyan::before { background: linear-gradient(90deg, #0891b2, #22d3ee); }
    .supper-stat-card.green::before { background: linear-gradient(90deg, #059669, #10b981); }
    .supper-stat-card.amber::before { background: linear-gradient(90deg, #d97706, #f59e0b); }
    .supper-stat-card.red::before { background: linear-gradient(90deg, #dc2626, #ef4444); }
    .supper-stat-card.purple::before { background: linear-gradient(90deg, #7c3aed, #8b5cf6); }
    
    .supper-stat-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 0.75rem;
    }
    
    .supper-stat-label {
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        color: #64748b;
    }
    
    .supper-stat-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
        color: #fff;
    }
    
    .supper-stat-icon.blue { background: linear-gradient(135deg, #1e40af, #3b82f6); }
    .supper-stat-icon.cyan { background: linear-gradient(135deg, #0891b2, #22d3ee); }
    .supper-stat-icon.green { background: linear-gradient(135deg, #059669, #10b981); }
    .supper-stat-icon.amber { background: linear-gradient(135deg, #d97706, #f59e0b); }
    .supper-stat-icon.red { background: linear-gradient(135deg, #dc2626, #ef4444); }
    .supper-stat-icon.purple { background: linear-gradient(135deg, #7c3aed, #8b5cf6); }
    
    .supper-stat-value {
        font-size: 1.75rem;
        font-weight: 700;
        color: #0f172a;
        line-height: 1.2;
        margin-bottom: 0.25rem;
    }
    
    .supper-stat-detail {
        font-size: 0.8rem;
        color: #64748b;
    }
    
    /* Section Card */
    .supper-section {
        background: #fff;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        border: 1px solid #e2e8f0;
        margin-bottom: 1.5rem;
    }
    
    .supper-section-title {
        font-size: 1.1rem;
        font-weight: 700;
        color: #0f172a;
        margin: 0 0 1.25rem 0;
        padding-bottom: 0.75rem;
        border-bottom: 2px solid #dbeafe;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    
    .supper-section-title i {
        color: #1e40af;
    }
    
    .supper-section-meta {
        font-size: 0.8rem;
        color: #64748b;
        font-weight: 400;
        margin-left: auto;
    }
    
    /* Progress Bar */
    .supper-progress {
        background: #dbeafe;
        height: 28px;
        border-radius: 14px;
        overflow: hidden;
        margin: 1rem 0;
    }
    
    .supper-progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #1e40af, #3b82f6);
        display: flex;
        align-items: center;
        justify-content: center;
        color: #fff;
        font-weight: 600;
        font-size: 0.8rem;
        min-width: 50px;
    }
    
    /* Objectives Grid */
    .supper-objectives {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
        margin-top: 1rem;
    }
    
    .supper-objective {
        text-align: center;
        padding: 1rem;
        background: #f8fafc;
        border-radius: 10px;
        border: 1px solid #e2e8f0;
    }
    
    .supper-objective-label {
        font-size: 0.75rem;
        color: #64748b;
        margin-bottom: 0.25rem;
    }
    
    .supper-objective-value {
        font-size: 1.25rem;
        font-weight: 700;
    }
    
    .supper-objective-value.blue { color: #1e40af; }
    .supper-objective-value.green { color: #059669; }
    .supper-objective-value.amber { color: #d97706; }
    
    .supper-objective-unit {
        font-size: 0.7rem;
        color: #94a3b8;
    }
    
    /* Charts Grid */
    .supper-charts {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
        gap: 1.5rem;
        margin-bottom: 1.5rem;
    }
    
    .supper-chart-container {
        position: relative;
        height: 280px;
        width: 100%;
    }
    
    /* Rank Card */
    .supper-rank {
        display: flex;
        align-items: center;
        gap: 1.25rem;
        padding: 1.25rem;
        background: #eff6ff;
        border-radius: 12px;
        border: 1px solid #dbeafe;
    }
    
    .supper-rank-badge {
        width: 64px;
        height: 64px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 800;
        font-size: 1.5rem;
        flex-shrink: 0;
        box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
    }
    
    .supper-rank-badge.gold { background: linear-gradient(135deg, #fbbf24, #f59e0b); color: #78350f; }
    .supper-rank-badge.silver { background: linear-gradient(135deg, #d1d5db, #9ca3af); color: #374151; }
    .supper-rank-badge.bronze { background: linear-gradient(135deg, #d97706, #b45309); color: #fff; }
    .supper-rank-badge.default { background: linear-gradient(135deg, #1e40af, #3b82f6); color: #fff; }
    .supper-rank-badge.purple { background: linear-gradient(135deg, #7c3aed, #8b5cf6); color: #fff; }
    
    .supper-rank-info h4 {
        margin: 0 0 0.25rem 0;
        font-size: 1rem;
        font-weight: 700;
        color: #1e3a8a;
    }
    
    .supper-rank-info p {
        margin: 0;
        font-size: 0.85rem;
        color: #334155;
    }
    
    .supper-rank-info small {
        font-size: 0.75rem;
        color: #475569;
    }
    
    /* Pesage Stats */
    .supper-pesage-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 0.75rem;
    }
    
    .supper-pesage-stat {
        text-align: center;
        padding: 1rem;
        border-radius: 10px;
        color: #fff;
    }
    
    .supper-pesage-stat.purple { background: linear-gradient(135deg, #7c3aed, #8b5cf6); }
    .supper-pesage-stat.amber { background: linear-gradient(135deg, #d97706, #f59e0b); }
    .supper-pesage-stat.blue { background: linear-gradient(135deg, #1e40af, #3b82f6); }
    .supper-pesage-stat.green { background: linear-gradient(135deg, #059669, #10b981); }
    .supper-pesage-stat.red { background: linear-gradient(135deg, #dc2626, #ef4444); }
    .supper-pesage-stat.outline {
        background: #fff;
        border: 2px dashed #cbd5e1;
        color: #334155;
    }
    .supper-pesage-stat.outline.warning-border { border-color: #f59e0b; }
    .supper-pesage-stat.outline.success-border { border-color: #10b981; }
    
    .supper-pesage-stat-label {
        font-size: 0.7rem;
        opacity: 0.9;
        margin-bottom: 0.375rem;
    }
    
    .supper-pesage-stat-value {
        font-size: 1.25rem;
        font-weight: 700;
    }
    
    .supper-pesage-stat-unit {
        font-size: 0.65rem;
        opacity: 0.8;
    }
    
    /* Month Stats */
    .supper-month-stats {
        margin-top: 1.25rem;
        padding: 1rem;
        background: #f8fafc;
        border-radius: 10px;
        border: 1px solid #e2e8f0;
    }
    
    .supper-month-stats h4 {
        font-size: 0.85rem;
        font-weight: 600;
        color: #334155;
        margin: 0 0 0.75rem 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .supper-month-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 0.75rem;
    }
    
    .supper-month-item {
        text-align: center;
    }
    
    .supper-month-item label {
        font-size: 0.7rem;
        color: #64748b;
        display: block;
    }
    
    .supper-month-item span {
        font-size: 1rem;
        font-weight: 700;
    }
    
    .supper-month-item span.blue { color: #1e40af; }
    .supper-month-item span.amber { color: #d97706; }
    .supper-month-item span.green { color: #059669; }
    .supper-month-item span.red { color: #dc2626; }
    .supper-month-item span.purple { color: #7c3aed; }
    
    /* Alert Boxes */
    .supper-alert {
        margin-top: 1rem;
        padding: 0.875rem 1rem;
        border-radius: 10px;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    
    .supper-alert.warning {
        background: #fef3c7;
        border-left: 4px solid #f59e0b;
    }
    
    .supper-alert.info {
        background: #eff6ff;
        border-left: 4px solid #3b82f6;
    }
    
    .supper-alert i {
        font-size: 1.25rem;
    }
    
    .supper-alert.warning i { color: #f59e0b; }
    .supper-alert.info i { color: #3b82f6; }
    
    .supper-alert-content strong {
        display: block;
        font-size: 0.875rem;
        color: #1e293b;
    }
    
    .supper-alert-content small {
        font-size: 0.8rem;
        color: #475569;
    }
    
    .supper-alert-action {
        margin-left: auto;
        padding: 0.5rem 0.875rem;
        border-radius: 6px;
        text-decoration: none;
        font-weight: 500;
        font-size: 0.8rem;
        color: #fff;
        background: #f59e0b;
    }
    
    /* Action Buttons */
    .supper-actions-bar {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 1.25rem;
        padding-top: 1.25rem;
        border-top: 1px solid #e2e8f0;
    }
    
    .supper-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 0.875rem;
        border-radius: 8px;
        text-decoration: none;
        font-weight: 500;
        font-size: 0.8rem;
        transition: all 0.2s ease;
        position: relative;
    }
    
    .supper-btn.purple { background: #7c3aed; color: #fff; }
    .supper-btn.indigo { background: #6366f1; color: #fff; }
    .supper-btn.green { background: #059669; color: #fff; }
    .supper-btn.pink { background: #ec4899; color: #fff; }
    .supper-btn.blue { background: #1e40af; color: #fff; }
    .supper-btn.outline { background: #fff; color: #475569; border: 1px solid #cbd5e1; }
    
    .supper-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
    }
    
    .supper-btn .badge {
        position: absolute;
        top: -6px;
        right: -6px;
        background: #ef4444;
        color: #fff;
        font-size: 0.65rem;
        padding: 0.125rem 0.375rem;
        border-radius: 50px;
        font-weight: 600;
    }
    
    /* Link Button */
    .supper-link-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.625rem 1.25rem;
        background: #1e40af;
        color: #fff;
        border-radius: 8px;
        text-decoration: none;
        font-weight: 600;
        font-size: 0.875rem;
    }
    
    .supper-link-btn:hover {
        background: #1e3a8a;
    }
    
    /* Activity list */
    .supper-activity-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    
    .supper-activity-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem 0;
        border-bottom: 1px solid #f1f5f9;
    }
    
    .supper-activity-item:last-child {
        border-bottom: none;
    }
    
    .supper-activity-icon {
        width: 32px;
        height: 32px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #eff6ff;
        color: #3b82f6;
        font-size: 0.8rem;
    }
    
    .supper-activity-content {
        flex: 1;
    }
    
    .supper-activity-content strong {
        display: block;
        font-size: 0.85rem;
        color: #1e293b;
    }
    
    .supper-activity-content small {
        font-size: 0.75rem;
        color: #64748b;
    }
    
    .supper-activity-time {
        font-size: 0.7rem;
        color: #94a3b8;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
        .supper-dashboard { padding: 1rem; }
        .supper-header { flex-direction: column; align-items: flex-start; padding: 1.25rem; }
        .supper-header h1 { font-size: 1.5rem; }
        .supper-stats { grid-template-columns: repeat(2, 1fr); }
        .supper-pesage-stats { grid-template-columns: repeat(2, 1fr); }
        .supper-charts { grid-template-columns: 1fr; }
        .supper-rank { flex-direction: column; text-align: center; }
        .supper-objectives { grid-template-columns: 1fr; }
    }
    
    @media (max-width: 480px) {
        .supper-stats { grid-template-columns: 1fr; }
        .supper-actions { grid-template-columns: 1fr; }
        .supper-pesage-stats { grid-template-columns: 1fr; }
    }
</style>

<!-- CONTENU DU DASHBOARD -->
<div class="supper-dashboard">
    <div class="supper-container">
        
        <!-- ============================================================ -->
        <!-- EN-T√äTE - Toujours visible pour utilisateur connect√© -->
        <!-- ============================================================ -->
        <div class="supper-header">
            <div>
                <h1>{% trans "Tableau de Bord" %} SUPPER</h1>
                <div class="supper-header-sub">
                    {% trans "Bienvenue," %} <strong>{{ user_stats.nom_complet }}</strong> 
                    ({{ user_stats.habilitation }})
                    {% if user_stats.poste_affectation %}
                        - {{ user_stats.poste_affectation.nom }}
                    {% endif %}
                </div>
            </div>
            <div class="supper-badge">
                <i class="fas fa-clock"></i>
                <span id="current-time"></span>
            </div>
        </div>

        <!-- ============================================================ -->
        <!-- ACTIONS RAPIDES - Conditionn√©es par permissions individuelles -->
        <!-- ============================================================ -->
        {% if actions_rapides %}
        <div class="supper-actions">
            {% for action in actions_rapides %}
            <a href="{{ action.url }}" class="supper-action-card">
                <div class="supper-action-icon {% if 'primary' in action.class %}primary{% elif 'success' in action.class %}success{% elif 'warning' in action.class %}warning{% elif 'danger' in action.class %}danger{% elif 'info' in action.class %}info{% elif 'secondary' in action.class %}secondary{% else %}primary{% endif %}">
                    <i class="{{ action.icon }}"></i>
                </div>
                <span class="supper-action-text">{{ action.titre }}</span>
            </a>
            {% endfor %}
        </div>
        {% endif %}

        <!-- ============================================================ -->
        <!-- STATISTIQUES PRINCIPALES -->
        <!-- ============================================================ -->
        <div class="supper-stats">
            
            <!-- Stats Globales - Permission: can_view_global_stats -->
            {% if can_view_global_stats and stats_globales %}
            <div class="supper-stat-card blue">
                <div class="supper-stat-header">
                    <span class="supper-stat-label">{% trans "Utilisateurs" %}</span>
                    <div class="supper-stat-icon blue">
                        <i class="fas fa-users"></i>
                    </div>
                </div>
                <div class="supper-stat-value">{{ stats_globales.total_utilisateurs }}</div>
                <div class="supper-stat-detail">{{ stats_globales.utilisateurs_actifs }} {% trans "actifs" %}</div>
            </div>

            <div class="supper-stat-card cyan">
                <div class="supper-stat-header">
                    <span class="supper-stat-label">{% trans "Postes" %}</span>
                    <div class="supper-stat-icon cyan">
                        <i class="fas fa-map-marker-alt"></i>
                    </div>
                </div>
                <div class="supper-stat-value">{{ stats_globales.total_postes }}</div>
                <div class="supper-stat-detail">{{ stats_globales.postes_peage }} p√©age | {{ stats_globales.postes_pesage }} pesage</div>
            </div>
            {% endif %}

            <!-- Stats Inventaires - Permission: can_view_inventaires -->
            {% if can_view_inventaires and stats_inventaires %}
            <div class="supper-stat-card green">
                <div class="supper-stat-header">
                    <span class="supper-stat-label">{% trans "Inventaires Aujourd'hui" %}</span>
                    <div class="supper-stat-icon green">
                        <i class="fas fa-clipboard-check"></i>
                    </div>
                </div>
                <div class="supper-stat-value">{{ stats_inventaires.inventaires_today }}</div>
                <div class="supper-stat-detail">{{ stats_inventaires.inventaires_semaine }} {% trans "cette semaine" %}</div>
            </div>
            {% endif %}

            <!-- Stats Recettes - Permission: can_view_recettes_peage -->
            {% if can_view_recettes_peage and stats_recettes %}
            <div class="supper-stat-card amber">
                <div class="supper-stat-header">
                    <span class="supper-stat-label">{% trans "Recettes du Mois" %}</span>
                    <div class="supper-stat-icon amber">
                        <i class="fas fa-coins"></i>
                    </div>
                </div>
                <div class="supper-stat-value">{{ stats_recettes.montant_mois|floatformat:0|intcomma }}</div>
                <div class="supper-stat-detail">{{ stats_recettes.nombre_recettes_mois }} {% trans "recettes saisies" %} ‚Ä¢ FCFA</div>
            </div>

            <!-- Taux D√©perdition - Uniquement si permission voir_taux_deperdition -->
            {% if stats_recettes.can_view_taux and stats_recettes.taux_moyen_mois is not None %}
            <div class="supper-stat-card {% if stats_recettes.taux_moyen_mois > -10 %}green{% elif stats_recettes.taux_moyen_mois > -30 %}amber{% else %}red{% endif %}">
                <div class="supper-stat-header">
                    <span class="supper-stat-label">{% trans "Taux Moyen D√©perdition" %}</span>
                    <div class="supper-stat-icon {% if stats_recettes.taux_moyen_mois > -10 %}green{% elif stats_recettes.taux_moyen_mois > -30 %}amber{% else %}red{% endif %}">
                        <i class="fas fa-chart-line"></i>
                    </div>
                </div>
                <div class="supper-stat-value">{{ stats_recettes.taux_moyen_mois|floatformat:2 }}%</div>
                {% if stats_recettes.can_view_potentiel and stats_recettes.ecart_mois is not None %}
                <div class="supper-stat-detail">{% trans "√âcart:" %} {{ stats_recettes.ecart_mois|floatformat:0|intcomma }} FCFA</div>
                {% endif %}
            </div>
            {% endif %}

            <div class="supper-stat-card blue">
                <div class="supper-stat-header">
                    <span class="supper-stat-label">{% trans "Recettes Aujourd'hui" %}</span>
                    <div class="supper-stat-icon blue">
                        <i class="fas fa-euro-sign"></i>
                    </div>
                </div>
                <div class="supper-stat-value">{{ stats_recettes.recettes_today }}</div>
                <div class="supper-stat-detail">{{ stats_recettes.total_recettes }} {% trans "total" %}</div>
            </div>
            {% endif %}
        </div>

        <!-- ============================================================ -->
        <!-- OBJECTIFS ANNUELS - Permission: can_view_objectifs -->
        <!-- ============================================================ -->
        {% if can_view_objectifs and stats_objectifs %}
        <div class="supper-section">
            <h2 class="supper-section-title">
                <i class="fas fa-bullseye"></i> 
                {% trans "Objectifs" %} {{ stats_objectifs.annee }}
                <span class="supper-section-meta">({{ stats_objectifs.nombre_postes }} postes actifs)</span>
            </h2>
            
            <div class="supper-progress">
                <div class="supper-progress-bar" style="width: {{ stats_objectifs.taux_realisation }}%;">
                    {{ stats_objectifs.taux_realisation|floatformat:1 }}%
                </div>
            </div>

            <div class="supper-objectives">
                <div class="supper-objective">
                    <div class="supper-objective-label">{% trans "Objectif" %}</div>
                    <div class="supper-objective-value blue">{{ stats_objectifs.total_objectif|floatformat:0|intcomma }}</div>
                    <div class="supper-objective-unit">FCFA</div>
                </div>
                
                <div class="supper-objective">
                    <div class="supper-objective-label">{% trans "R√©alis√©" %}</div>
                    <div class="supper-objective-value green">{{ stats_objectifs.total_realise|floatformat:0|intcomma }}</div>
                    <div class="supper-objective-unit">FCFA</div>
                </div>
                
                <div class="supper-objective">
                    <div class="supper-objective-label">{% trans "Reste" %}</div>
                    <div class="supper-objective-value amber">{{ stats_objectifs.reste_a_realiser|floatformat:0|intcomma }}</div>
                    <div class="supper-objective-unit">FCFA</div>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 1.25rem;">
                <a href="{% url 'inventaire:gestion_objectifs_annuels' %}?annee={{ stats_objectifs.annee }}" class="supper-link-btn">
                    <i class="fas fa-cog"></i>
                    {% trans "G√©rer les objectifs d√©taill√©s" %}
                </a>
            </div>
        </div>
        {% endif %}

        <!-- ============================================================ -->
        <!-- GRAPHIQUES - Permission: can_view_graphs -->
        <!-- ============================================================ -->
        {% if can_view_graphs and graph_data_json %}
        <div class="supper-charts">
            <div class="supper-section">
                <h2 class="supper-section-title">
                    <i class="fas fa-chart-area"></i> 
                    {% trans "√âvolution des Recettes (7 jours)" %}
                </h2>
                <div class="supper-chart-container">
                    <canvas id="chartRecettes"></canvas>
                </div>
            </div>

            <!-- Graphique Taux uniquement si permission voir_taux_deperdition -->
            {% if user_permissions.acces_global.voir_taux_deperdition %}
            <div class="supper-section">
                <h2 class="supper-section-title">
                    <i class="fas fa-chart-bar"></i> 
                    {% trans "Taux de D√©perdition (7 jours)" %}
                </h2>
                <div class="supper-chart-container">
                    <canvas id="chartTaux"></canvas>
                </div>
            </div>
            {% endif %}
        </div>
        {% endif %}

        <!-- ============================================================ -->
        <!-- RANG POSTE P√âAGE - Affich√© si classement disponible -->
        <!-- ============================================================ -->
        {% if rang_poste_peage and rang_poste_peage.rang %}
        <div class="supper-section">
            <div class="supper-rank">
                <div class="supper-rank-badge {% if rang_poste_peage.rang == 1 %}gold{% elif rang_poste_peage.rang == 2 %}silver{% elif rang_poste_peage.rang == 3 %}bronze{% else %}default{% endif %}">
                    {{ rang_poste_peage.rang }}{% if rang_poste_peage.rang == 1 %}<sup style="font-size: 0.5em;">er</sup>{% endif %}
                </div>
                <div class="supper-rank-info">
                    <h4>
                        <i class="fas fa-road" style="margin-right: 0.5rem;"></i>
                        {% if rang_poste_peage.rang == 1 %}
                        üèÜ {% trans "Meilleur poste de p√©age !" %}
                        {% elif rang_poste_peage.rang <= 3 %}
                        ü•à {% trans "Top 3 des postes de p√©age" %}
                        {% elif rang_poste_peage.rang <= 5 %}
                        ‚≠ê {% trans "Top 5 des postes" %}
                        {% else %}
                        üìä {% trans "Votre classement p√©age" %}
                        {% endif %}
                    </h4>
                    <p>{{ rang_poste_peage.rang }}{% if rang_poste_peage.rang == 1 %}er{% else %}√®me{% endif %} {% trans "sur" %} {{ rang_poste_peage.total_postes }} {% trans "postes de p√©age" %}</p>
                    <small>{% trans "Total recettes" %} {{ current_year }}: {{ rang_poste_peage.total_recettes|floatformat:0|intcomma }} FCFA</small>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- ============================================================ -->
        <!-- STATISTIQUES PESAGE - Permission: has_pesage_access -->
        <!-- ============================================================ -->
        {% if has_pesage_access and stats_pesage %}
        <div class="supper-section">
            <h2 class="supper-section-title">
                <i class="fas fa-weight-scale" style="color: #7c3aed;"></i> 
                {% trans "Module Pesage" %}
                <span class="supper-section-meta">
                    {{ stats_pesage.label_scope }}
                    {% if stats_pesage.jour_travail %}
                    <span style="margin-left: 0.5rem; padding: 0.25rem 0.5rem; background: #ede9fe; border-radius: 4px; font-size: 0.7rem;">
                        {% trans "Jour:" %} {{ stats_pesage.jour_travail|date:"d/m/Y" }} (9h-9h)
                    </span>
                    {% endif %}
                </span>
            </h2>
            
            <div class="supper-pesage-stats">
                <!-- Pes√©es - si permission peut_saisir_pesee_jour ou peut_voir_historique_pesees -->
                {% if stats_pesage.can_saisir_pesee or stats_pesage.can_voir_historique %}
                <div class="supper-pesage-stat purple">
                    <div class="supper-pesage-stat-label"><i class="fas fa-balance-scale"></i> {% trans "Pes√©es Jour" %}</div>
                    <div class="supper-pesage-stat-value">{{ stats_pesage.pesees_jour|default:"‚Äî" }}</div>
                </div>
                {% endif %}
                
                <!-- √âmissions - visible pour tous avec acc√®s pesage -->
                <div class="supper-pesage-stat amber">
                    <div class="supper-pesage-stat-label"><i class="fas fa-file-invoice"></i> {% trans "√âmissions Jour" %}</div>
                    <div class="supper-pesage-stat-value">{{ stats_pesage.emissions_jour|default:0 }}</div>
                    <div class="supper-pesage-stat-unit">{% trans "dont" %} {{ stats_pesage.hors_gabarit_jour|default:0 }} HG</div>
                </div>
                
                <div class="supper-pesage-stat blue">
                    <div class="supper-pesage-stat-label"><i class="fas fa-coins"></i> {% trans "√âmis Jour" %}</div>
                    <div class="supper-pesage-stat-value">{{ stats_pesage.montant_emis_jour|floatformat:0|intcomma }}</div>
                    <div class="supper-pesage-stat-unit">FCFA</div>
                </div>
                
                <!-- Recouvr√© - si permission peut_valider_paiement_amende -->
                {% if stats_pesage.can_valider_paiement or stats_pesage.can_voir_recettes %}
                <div class="supper-pesage-stat green">
                    <div class="supper-pesage-stat-label"><i class="fas fa-hand-holding-usd"></i> {% trans "Recouvr√© Jour" %}</div>
                    <div class="supper-pesage-stat-value">{{ stats_pesage.montant_recouvre_jour|floatformat:0|intcomma }}</div>
                    <div class="supper-pesage-stat-unit">{{ stats_pesage.paiements_jour }} paiement{{ stats_pesage.paiements_jour|pluralize }}</div>
                </div>
                
                <div class="supper-pesage-stat red">
                    <div class="supper-pesage-stat-label"><i class="fas fa-clock"></i> {% trans "Reste Jour" %}</div>
                    <div class="supper-pesage-stat-value">{{ stats_pesage.reste_a_recouvrer_jour|floatformat:0|intcomma }}</div>
                    <div class="supper-pesage-stat-unit">FCFA</div>
                </div>
                {% endif %}
                
                <div class="supper-pesage-stat outline {% if stats_pesage.amendes_non_payees > 0 %}warning-border{% else %}success-border{% endif %}">
                    <div class="supper-pesage-stat-label"><i class="fas fa-hourglass-half"></i> {% trans "Non Pay√©es" %}</div>
                    <div class="supper-pesage-stat-value" style="color: {% if stats_pesage.amendes_non_payees > 0 %}#f59e0b{% else %}#10b981{% endif %};">
                        {{ stats_pesage.amendes_non_payees|default:0 }}
                    </div>
                    <div class="supper-pesage-stat-unit" style="color: #64748b;">{{ stats_pesage.montant_non_paye_total|floatformat:0|intcomma }} FCFA</div>
                </div>
            </div>
            
            <!-- Stats du mois - si permission peut_voir_stats_pesage -->
            {% if stats_pesage.can_voir_stats %}
            <div class="supper-month-stats">
                <h4>
                    <i class="fas fa-calendar-alt"></i> 
                    {% trans "Statistiques du mois" %} ({{ current_month }} {{ current_year }})
                </h4>
                <div class="supper-month-grid">
                    <div class="supper-month-item">
                        <label>{% trans "√âmissions" %}</label>
                        <span class="blue">{{ stats_pesage.emissions_mois }}</span>
                    </div>
                    <div class="supper-month-item">
                        <label>{% trans "Montant √âmis" %}</label>
                        <span class="amber">{{ stats_pesage.montant_emis_mois|floatformat:0|intcomma }}</span>
                    </div>
                    <div class="supper-month-item">
                        <label>{% trans "Recouvr√©" %}</label>
                        <span class="green">{{ stats_pesage.montant_recouvre_mois|floatformat:0|intcomma }}</span>
                    </div>
                    <div class="supper-month-item">
                        <label>{% trans "Taux Recouvrement" %}</label>
                        <span class="{% if stats_pesage.taux_recouvrement_mois >= 80 %}green{% elif stats_pesage.taux_recouvrement_mois >= 50 %}amber{% else %}red{% endif %}">
                            {{ stats_pesage.taux_recouvrement_mois }}%
                        </span>
                    </div>
                    {% if stats_pesage.quittancements_mois is not None %}
                    <div class="supper-month-item">
                        <label>{% trans "Quittancements" %}</label>
                        <span class="purple">{{ stats_pesage.quittancements_mois }}</span>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
            
            <!-- Rang station pesage - si classement disponible -->
            {% if rang_station_pesage and rang_station_pesage.rang %}
            <div class="supper-rank" style="margin-top: 1.25rem; background: linear-gradient(135deg, #ede9fe, #ddd6fe);">
                <div class="supper-rank-badge {% if rang_station_pesage.rang == 1 %}gold{% elif rang_station_pesage.rang == 2 %}silver{% elif rang_station_pesage.rang == 3 %}bronze{% else %}purple{% endif %}">
                    {{ rang_station_pesage.rang }}{% if rang_station_pesage.rang == 1 %}<sup style="font-size: 0.5em;">er</sup>{% elif rang_station_pesage.rang <= 3 %}<sup style="font-size: 0.5em;">e</sup>{% endif %}
                </div>
                <div class="supper-rank-info">
                    <h4 style="color: #5b21b6;">
                        {% if rang_station_pesage.rang == 1 %}
                        üèÜ {% trans "Champion des stations !" %}
                        {% elif rang_station_pesage.rang <= 3 %}
                        ü•à {% trans "Dans le top 3 !" %}
                        {% elif rang_station_pesage.rang <= 5 %}
                        ‚≠ê {% trans "Dans le top 5" %}
                        {% else %}
                        üìä {% trans "Classement actuel" %}
                        {% endif %}
                    </h4>
                    <p style="color: #7c3aed;">{{ rang_station_pesage.rang }}{% if rang_station_pesage.rang == 1 %}√®re{% else %}√®me{% endif %} {% trans "position sur" %} {{ rang_station_pesage.total_stations }} {% trans "stations" %}</p>
                    <small style="color: #6d28d9;">
                        {% trans "Total recouvr√©:" %} {{ rang_station_pesage.total_recouvre|floatformat:0|intcomma }} FCFA
                        {% if rang_station_pesage.taux_recouvrement %}
                        ‚Ä¢ {% trans "Taux:" %} {{ rang_station_pesage.taux_recouvrement }}%
                        {% endif %}
                    </small>
                </div>
            </div>
            {% endif %}
            
            <!-- Alertes pesage - conditionn√©es -->
            {% if stats_pesage.demandes_confirmation_attente and stats_pesage.demandes_confirmation_attente > 0 %}
            <div class="supper-alert warning">
                <i class="fas fa-bell"></i>
                <div class="supper-alert-content">
                    <strong>{{ stats_pesage.demandes_confirmation_attente }} {% trans "demande" %}{{ stats_pesage.demandes_confirmation_attente|pluralize }} {% trans "de confirmation en attente" %}</strong>
                    <small>{% trans "Des r√©gisseurs d'autres stations attendent votre validation." %}</small>
                </div>
                <a href="{% url 'inventaire:demandes_confirmation_a_traiter' %}" class="supper-alert-action">{% trans "Traiter" %}</a>
            </div>
            {% endif %}
            
            {% if stats_pesage.mes_saisies_jour is not None %}
            <div class="supper-alert info">
                <i class="fas fa-user-edit"></i>
                <div class="supper-alert-content">
                    <strong>{% trans "Vos saisies aujourd'hui :" %} {{ stats_pesage.mes_saisies_jour }} {% trans "amende" %}{{ stats_pesage.mes_saisies_jour|pluralize }}</strong>
                </div>
            </div>
            {% endif %}
            
            <!-- Actions rapides pesage - conditionn√©es par permissions -->
            <div class="supper-actions-bar">
                {% if stats_pesage.can_saisir_amende %}
                <a href="{% url 'inventaire:saisir_amende' %}" class="supper-btn purple">
                    <i class="fas fa-plus"></i>{% trans "Saisir Amende" %}
                </a>
                {% endif %}
                
                {% if stats_pesage.can_saisir_pesee %}
                <a href="{% url 'inventaire:saisir_pesees' %}" class="supper-btn indigo">
                    <i class="fas fa-balance-scale"></i>{% trans "Saisir Pes√©es" %}
                </a>
                {% endif %}
                
                {% if stats_pesage.can_valider_paiement %}
                <a href="{% url 'inventaire:liste_amendes_a_valider' %}" class="supper-btn green">
                    <i class="fas fa-check-double"></i>{% trans "Valider Paiements" %}
                    {% if stats_pesage.amendes_non_payees > 0 %}
                    <span class="badge">{{ stats_pesage.amendes_non_payees }}</span>
                    {% endif %}
                </a>
                {% endif %}
                
                {% if stats_pesage.can_saisir_quittance %}
                <a href="{% url 'inventaire:saisie_quittancement_pesage' %}" class="supper-btn pink">
                    <i class="fas fa-receipt"></i>{% trans "Quittancement" %}
                </a>
                {% endif %}
                
                <a href="{% url 'inventaire:liste_amendes' %}" class="supper-btn blue">
                    <i class="fas fa-list"></i>{% trans "Liste Amendes" %}
                </a>
                
                {% if stats_pesage.can_voir_recettes %}
                <a href="{% url 'inventaire:recettes_pesage' %}" class="supper-btn outline">
                    <i class="fas fa-coins"></i>{% trans "Recettes" %}
                </a>
                {% endif %}
                
                {% if stats_pesage.can_voir_stats %}
                <a href="{% url 'inventaire:statistiques_pesage' %}" class="supper-btn outline">
                    <i class="fas fa-chart-bar"></i>{% trans "Statistiques" %}
                </a>
                {% endif %}
                
                <a href="{% url 'inventaire:recherche_historique_vehicule' %}" class="supper-btn outline">
                    <i class="fas fa-search"></i>{% trans "Historique V√©hicule" %}
                </a>
            </div>
        </div>
        {% endif %}

        <!-- ============================================================ -->
        <!-- ALERTES - Conditionn√©es selon contexte utilisateur -->
        <!-- ============================================================ -->
        {% if alertes %}
        <div class="supper-section">
            <h2 class="supper-section-title">
                <i class="fas fa-bell"></i>
                {% trans "Alertes" %}
                <span class="supper-section-meta">{{ alertes|length }} {% trans "notification" %}{{ alertes|length|pluralize }}</span>
            </h2>
            
            {% for alerte in alertes %}
            <div class="supper-alert {% if alerte.type == 'warning' %}warning{% else %}info{% endif %}">
                <i class="{{ alerte.icon }}"></i>
                <div class="supper-alert-content">
                    <strong>{{ alerte.titre }}</strong>
                    <small>{{ alerte.message }}</small>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- ============================================================ -->
        <!-- ACTIVIT√âS R√âCENTES - Conditionn√©es par permission journal_audit -->
        <!-- ============================================================ -->
        {% if activites_recentes %}
        <div class="supper-section">
            <h2 class="supper-section-title">
                <i class="fas fa-history"></i>
                {% if user_permissions.gestion.peut_voir_journal_audit %}
                {% trans "Activit√©s R√©centes (Global)" %}
                {% else %}
                {% trans "Vos Activit√©s R√©centes" %}
                {% endif %}
            </h2>
            
            <ul class="supper-activity-list">
                {% for activite in activites_recentes %}
                <li class="supper-activity-item">
                    <div class="supper-activity-icon">
                        {% if activite.succes %}
                        <i class="fas fa-check"></i>
                        {% else %}
                        <i class="fas fa-times" style="color: #ef4444;"></i>
                        {% endif %}
                    </div>
                    <div class="supper-activity-content">
                        <strong>{{ activite.action }}</strong>
                        <small>
                            {% if user_permissions.gestion.peut_voir_journal_audit and activite.utilisateur %}
                            {{ activite.utilisateur.nom_complet }} - 
                            {% endif %}
                            {{ activite.details|truncatechars:60 }}
                        </small>
                    </div>
                    <span class="supper-activity-time">{{ activite.timestamp|date:"d/m H:i" }}</span>
                </li>
                {% endfor %}
            </ul>
            
            {% if user_permissions.gestion.peut_voir_journal_audit %}
            <div style="text-align: center; margin-top: 1rem;">
                <a href="{% url 'accounts:journal_audit' %}" class="supper-link-btn">
                    <i class="fas fa-external-link-alt"></i>
                    {% trans "Voir le journal complet" %}
                </a>
            </div>
            {% endif %}
        </div>
        {% endif %}

        <!-- ============================================================ -->
        <!-- TOP POSTES - Permission: can_view_classement -->
        <!-- ============================================================ -->
        {% if can_view_classement and top_postes %}
        <div class="supper-section">
            <h2 class="supper-section-title">
                <i class="fas fa-trophy"></i>
                {% trans "Top 5 Postes (30 derniers jours)" %}
            </h2>
            
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="border-bottom: 2px solid #e2e8f0;">
                        <th style="padding: 0.75rem; text-align: left; font-size: 0.75rem; color: #64748b;">{% trans "Rang" %}</th>
                        <th style="padding: 0.75rem; text-align: left; font-size: 0.75rem; color: #64748b;">{% trans "Poste" %}</th>
                        <th style="padding: 0.75rem; text-align: right; font-size: 0.75rem; color: #64748b;">{% trans "Recettes" %}</th>
                    </tr>
                </thead>
                <tbody>
                    {% for poste in top_postes %}
                    <tr style="border-bottom: 1px solid #f1f5f9;">
                        <td style="padding: 0.75rem;">
                            <span style="display: inline-flex; align-items: center; justify-content: center; width: 28px; height: 28px; border-radius: 50%; font-weight: 700; font-size: 0.8rem;
                                {% if poste.rang == 1 %}background: linear-gradient(135deg, #fbbf24, #f59e0b); color: #78350f;
                                {% elif poste.rang == 2 %}background: linear-gradient(135deg, #d1d5db, #9ca3af); color: #374151;
                                {% elif poste.rang == 3 %}background: linear-gradient(135deg, #d97706, #b45309); color: #fff;
                                {% else %}background: #f1f5f9; color: #475569;{% endif %}">
                                {{ poste.rang }}
                            </span>
                        </td>
                        <td style="padding: 0.75rem;">
                            <strong style="color: #1e293b;">{{ poste.nom }}</strong>
                            <br><small style="color: #64748b;">{{ poste.code }}</small>
                        </td>
                        <td style="padding: 0.75rem; text-align: right; font-weight: 600; color: #059669;">
                            {{ poste.total|floatformat:0|intcomma }} FCFA
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% endif %}

        <!-- ============================================================ -->
        <!-- STATISTIQUES SYST√àME - Permission: peut_voir_journal_audit -->
        <!-- ============================================================ -->
        {% if stats_systeme and user_permissions.gestion.peut_voir_journal_audit %}
        <div class="supper-section">
            <h2 class="supper-section-title">
                <i class="fas fa-server"></i>
                {% trans "Statistiques Syst√®me" %}
            </h2>
            
            <div class="supper-stats" style="margin-bottom: 0;">
                <div class="supper-stat-card blue">
                    <div class="supper-stat-header">
                        <span class="supper-stat-label">{% trans "Actions Aujourd'hui" %}</span>
                        <div class="supper-stat-icon blue">
                            <i class="fas fa-bolt"></i>
                        </div>
                    </div>
                    <div class="supper-stat-value">{{ stats_systeme.actions_today }}</div>
                    <div class="supper-stat-detail">{{ stats_systeme.actions_succes }} {% trans "r√©ussies" %}</div>
                </div>
                
                {% if stats_systeme.derniere_saisie %}
                <div class="supper-stat-card green">
                    <div class="supper-stat-header">
                        <span class="supper-stat-label">{% trans "Derni√®re Saisie Inventaire" %}</span>
                        <div class="supper-stat-icon green">
                            <i class="fas fa-clipboard-list"></i>
                        </div>
                    </div>
                    <div class="supper-stat-value" style="font-size: 1rem;">{{ stats_systeme.derniere_saisie.poste.nom|truncatechars:20 }}</div>
                    <div class="supper-stat-detail">{{ stats_systeme.derniere_saisie.date_creation|date:"d/m/Y H:i" }}</div>
                </div>
                {% endif %}
                
                {% if stats_systeme.derniere_recette %}
                <div class="supper-stat-card amber">
                    <div class="supper-stat-header">
                        <span class="supper-stat-label">{% trans "Derni√®re Recette" %}</span>
                        <div class="supper-stat-icon amber">
                            <i class="fas fa-coins"></i>
                        </div>
                    </div>
                    <div class="supper-stat-value" style="font-size: 1rem;">{{ stats_systeme.derniere_recette.poste.nom|truncatechars:20 }}</div>
                    <div class="supper-stat-detail">{{ stats_systeme.derniere_recette.date_saisie|date:"d/m/Y H:i" }}</div>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

    </div>
</div>

<!-- ============================================================ -->
<!-- JAVASCRIPT -->
<!-- ============================================================ -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Horloge en temps r√©el
    function updateClock() {
        const now = new Date();
        const options = { weekday: 'short', day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' };
        const timeEl = document.getElementById('current-time');
        if (timeEl) {
            timeEl.textContent = now.toLocaleDateString('fr-FR', options);
        }
    }
    updateClock();
    setInterval(updateClock, 60000);

    // Configuration Chart.js - seulement si graphiques visibles
    {% if can_view_graphs and graph_data_json %}
    const graphData = {{ graph_data_json|safe }};
    Chart.defaults.font.family = "'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif";
    Chart.defaults.color = '#475569';

    if (graphData.evolution_7j && document.getElementById('chartRecettes')) {
        const ctxRecettes = document.getElementById('chartRecettes').getContext('2d');
        new Chart(ctxRecettes, {
            type: 'line',
            data: {
                labels: graphData.evolution_7j.labels,
                datasets: [{
                    label: 'Recettes (FCFA)',
                    data: graphData.evolution_7j.recettes,
                    borderColor: '#1e40af',
                    backgroundColor: 'rgba(30, 64, 175, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 5,
                    pointHoverRadius: 8,
                    pointBackgroundColor: '#1e40af',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: true, position: 'top', labels: { usePointStyle: true, padding: 20 } },
                    tooltip: { backgroundColor: 'rgba(15, 23, 42, 0.9)', padding: 12, cornerRadius: 8, titleFont: { weight: 'bold' } }
                },
                scales: {
                    y: { beginAtZero: true, grid: { color: 'rgba(0, 0, 0, 0.04)' }, ticks: { padding: 10 } },
                    x: { grid: { display: false }, ticks: { padding: 10 } }
                },
                interaction: { intersect: false, mode: 'index' }
            }
        });
    }

    // Graphique Taux - seulement si permission voir_taux_deperdition
    {% if user_permissions.acces_global.voir_taux_deperdition %}
    if (graphData.evolution_7j && graphData.evolution_7j.show_taux && document.getElementById('chartTaux')) {
        const ctxTaux = document.getElementById('chartTaux').getContext('2d');
        const backgroundColors = graphData.evolution_7j.taux.map(taux => {
            if (taux === null) return 'rgba(156, 163, 175, 0.5)';
            if (taux > -10) return 'rgba(5, 150, 105, 0.7)';
            if (taux >= -30) return 'rgba(217, 119, 6, 0.7)';
            return 'rgba(220, 38, 38, 0.7)';
        });
        const borderColors = graphData.evolution_7j.taux.map(taux => {
            if (taux === null) return '#9ca3af';
            if (taux > -10) return '#059669';
            if (taux >= -30) return '#d97706';
            return '#dc2626';
        });

        new Chart(ctxTaux, {
            type: 'bar',
            data: {
                labels: graphData.evolution_7j.labels,
                datasets: [{
                    label: 'Taux de D√©perdition (%)',
                    data: graphData.evolution_7j.taux,
                    backgroundColor: backgroundColors,
                    borderColor: borderColors,
                    borderWidth: 2,
                    borderRadius: 8,
                    borderSkipped: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: true, position: 'top', labels: { usePointStyle: true, padding: 20 } },
                    tooltip: { backgroundColor: 'rgba(15, 23, 42, 0.9)', padding: 12, cornerRadius: 8, titleFont: { weight: 'bold' } }
                },
                scales: {
                    y: { beginAtZero: false, grid: { color: 'rgba(0, 0, 0, 0.04)' }, ticks: { padding: 10 } },
                    x: { grid: { display: false }, ticks: { padding: 10 } }
                }
            }
        });
    }
    {% endif %}
    {% endif %}
});
</script>
{% endblock %}