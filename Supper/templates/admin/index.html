{% extends "admin/base_site.html" %}
{% load static %}
{% load i18n %}
{% load inventaire_extras %}

{% block title %}{{ title }} - SUPPER{% endblock %}

{% block extrastyle %}
<style>
    /* Force le reset complet */
    body { margin: 0 !important; padding: 0 !important; }
    #content.main-content { background: transparent !important; padding: 0 !important; min-height: auto !important; }
    .content-wrapper { padding: 0 !important; max-width: none !important; }
</style>
{% endblock %}

{% block content %}
<!-- WRAPPER avec fond bleu en inline pour priorité maximale -->
<div style="background: linear-gradient(135deg, #2563eb 0%, #1e40af 100%); min-height: calc(100vh - 80px); padding: 2rem; margin: 0; width: 100%;">
    <div style="max-width: 1400px; margin: 0 auto;">
        
        <!-- EN-TÊTE avec fond blanc -->
        <div style="background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px); border-radius: 20px; padding: 2.5rem; margin-bottom: 2rem; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.15); position: relative; overflow: hidden; border-top: 5px solid #2563eb;">
            <h1 style="margin: 0 0 0.5rem 0; font-size: 2.5rem; font-weight: 800; color: #0F172A; line-height: 1.2;">
                {% trans "Tableau de Bord" %} SUPPER
            </h1>
            <div style="color: #475569; font-size: 1.125rem; margin: 0;">
                {% trans "Bienvenue," %} <strong style="color: #2563eb;">{{ user_stats.nom_complet }}</strong> 
                ({{ user_stats.habilitation }})
                {% if user_stats.poste_affectation %}
                    - {{ user_stats.poste_affectation.nom }}
                {% endif %}
            </div>
        </div>

        <!-- ACTIONS RAPIDES -->
        {% if actions_rapides %}
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
            {% for action in actions_rapides %}
            <a href="{{ action.url }}" style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 2rem; background: white; border-radius: 16px; text-decoration: none; color: #1E293B; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); transition: all 0.3s; border: 2px solid transparent;">
                <div style="width: 64px; height: 64px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.75rem; margin-bottom: 1rem; color: white; 
                    {% if 'primary' in action.class %}background: linear-gradient(135deg, #2563eb, #3b82f6);
                    {% elif 'success' in action.class %}background: linear-gradient(135deg, #10B981, #6EE7B7);
                    {% elif 'warning' in action.class %}background: linear-gradient(135deg, #F59E0B, #FCD34D);
                    {% elif 'danger' in action.class %}background: linear-gradient(135deg, #EF4444, #FCA5A5);
                    {% else %}background: linear-gradient(135deg, #2563eb, #3b82f6);{% endif %}">
                    <i class="{{ action.icon }}"></i>
                </div>
                <div style="font-weight: 600; font-size: 1rem; text-align: center; color: #1E293B;">
                    {{ action.titre }}
                </div>
            </a>
            {% endfor %}
        </div>
        {% endif %}

        <!-- STATISTIQUES PRINCIPALES -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
            {% if stats_globales %}
            <div style="background: white; border-radius: 16px; padding: 1.75rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); position: relative; overflow: hidden; border-top: 4px solid #2563eb;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1.25rem;">
                    <div style="color: #64748B; font-size: 0.875rem; font-weight: 600; text-transform: uppercase;">
                        {% trans "Utilisateurs" %}
                    </div>
                    <div style="width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: white; background: linear-gradient(135deg, #2563eb, #3b82f6);">
                        <i class="fas fa-users"></i>
                    </div>
                </div>
                <div style="font-size: 2.25rem; font-weight: 700; color: #0F172A; margin-bottom: 0.5rem;">
                    {{ stats_globales.total_utilisateurs }}
                </div>
                <div style="color: #64748B; font-size: 0.875rem;">
                    {{ stats_globales.utilisateurs_actifs }} {% trans "actifs" %}
                </div>
            </div>

            <div style="background: white; border-radius: 16px; padding: 1.75rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); position: relative; overflow: hidden; border-top: 4px solid #0ea5e9;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1.25rem;">
                    <div style="color: #64748B; font-size: 0.875rem; font-weight: 600; text-transform: uppercase;">
                        {% trans "Postes" %}
                    </div>
                    <div style="width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: white; background: linear-gradient(135deg, #0ea5e9, #38bdf8);">
                        <i class="fas fa-map-marker-alt"></i>
                    </div>
                </div>
                <div style="font-size: 2.25rem; font-weight: 700; color: #0F172A; margin-bottom: 0.5rem;">
                    {{ stats_globales.total_postes }}
                </div>
                <div style="color: #64748B; font-size: 0.875rem;">
                    {{ stats_globales.postes_peage }} péage | {{ stats_globales.postes_pesage }} pesage
                </div>
            </div>
            {% endif %}

            {% if stats_inventaires %}
            <div style="background: white; border-radius: 16px; padding: 1.75rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); position: relative; overflow: hidden; border-top: 4px solid #10B981;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1.25rem;">
                    <div style="color: #64748B; font-size: 0.875rem; font-weight: 600; text-transform: uppercase;">
                        {% trans "Inventaires Aujourd'hui" %}
                    </div>
                    <div style="width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: white; background: linear-gradient(135deg, #10B981, #6EE7B7);">
                        <i class="fas fa-clipboard-check"></i>
                    </div>
                </div>
                <div style="font-size: 2.25rem; font-weight: 700; color: #0F172A; margin-bottom: 0.5rem;">
                    {{ stats_inventaires.inventaires_today }}
                </div>
                <div style="color: #64748B; font-size: 0.875rem;">
                    {{ stats_inventaires.inventaires_semaine }} {% trans "cette semaine" %}
                </div>
            </div>
            {% endif %}

            {% if stats_recettes %}
            <div style="background: white; border-radius: 16px; padding: 1.75rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); position: relative; overflow: hidden; border-top: 4px solid #F59E0B;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1.25rem;">
                    <div style="color: #64748B; font-size: 0.875rem; font-weight: 600; text-transform: uppercase;">
                        {% trans "Recettes du Mois" %}
                    </div>
                    <div style="width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: white; background: linear-gradient(135deg, #F59E0B, #FCD34D);">
                        <i class="fas fa-coins"></i>
                    </div>
                </div>
                <div style="font-size: 2.25rem; font-weight: 700; color: #0F172A; margin-bottom: 0.5rem;">
                    {{ stats_recettes.montant_mois|floatformat:0|intcomma }} FCFA
                </div>
                <div style="color: #64748B; font-size: 0.875rem;">
                    {{ stats_recettes.nombre_recettes_mois }} {% trans "recettes saisies" %}
                </div>
            </div>

            <div style="background: white; border-radius: 16px; padding: 1.75rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); position: relative; overflow: hidden; border-top: 4px solid {% if stats_recettes.taux_moyen_mois > -10 %}#10B981{% elif stats_recettes.taux_moyen_mois > -30 %}#F59E0B{% else %}#EF4444{% endif %};">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1.25rem;">
                    <div style="color: #64748B; font-size: 0.875rem; font-weight: 600; text-transform: uppercase;">
                        {% trans "Taux Moyen Déperdition" %}
                    </div>
                    <div style="width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: white; background: linear-gradient(135deg, {% if stats_recettes.taux_moyen_mois > -10 %}#10B981, #6EE7B7{% elif stats_recettes.taux_moyen_mois > -30 %}#F59E0B, #FCD34D{% else %}#EF4444, #FCA5A5{% endif %});">
                        <i class="fas fa-chart-line"></i>
                    </div>
                </div>
                <div style="font-size: 2.25rem; font-weight: 700; color: #0F172A; margin-bottom: 0.5rem;">
                    {{ stats_recettes.taux_moyen_mois|floatformat:2 }}%
                </div>
                <div style="color: #64748B; font-size: 0.875rem;">
                    {% trans "Écart:" %} {{ stats_recettes.ecart_mois|floatformat:0|intcomma }} FCFA
                </div>
            </div>

            <div style="background: white; border-radius: 16px; padding: 1.75rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); position: relative; overflow: hidden; border-top: 4px solid #2563eb;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1.25rem;">
                    <div style="color: #64748B; font-size: 0.875rem; font-weight: 600; text-transform: uppercase;">
                        {% trans "Recettes Aujourd'hui" %}
                    </div>
                    <div style="width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: white; background: linear-gradient(135deg, #2563eb, #3b82f6);">
                        <i class="fas fa-euro-sign"></i>
                    </div>
                </div>
                <div style="font-size: 2.25rem; font-weight: 700; color: #0F172A; margin-bottom: 0.5rem;">
                    {{ stats_recettes.recettes_today }}
                </div>
                <div style="color: #64748B; font-size: 0.875rem;">
                    {{ stats_recettes.total_recettes }} {% trans "total" %}
                </div>
            </div>
            {% endif %}
        </div>

        <!-- OBJECTIFS (si présents) -->
{% if stats_objectifs %}
        <div style="background: white; border-radius: 16px; padding: 2rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); margin-bottom: 2rem;">
            <h2 style="font-size: 1.25rem; font-weight: 700; color: #0F172A; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid #F1F5F9; display: flex; align-items: center; gap: 0.75rem;">
                <i class="fas fa-bullseye" style="color: #2563eb;"></i> 
                {% trans "Objectifs" %} {{ stats_objectifs.annee }}
                <span style="font-size: 0.875rem; color: #64748B; font-weight: 400; margin-left: auto;">
                    ({{ stats_objectifs.nombre_postes }} postes actifs)
                </span>
            </h2>
            
            <!-- Barre de progression -->
            <div style="background: #E2E8F0; height: 32px; border-radius: 16px; overflow: hidden; margin: 1.5rem 0;">
                <div style="height: 100%; width: {{ stats_objectifs.taux_realisation }}%; background: linear-gradient(90deg, #2563eb, #3b82f6); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 0.875rem; transition: width 1.5s ease;">
                    {{ stats_objectifs.taux_realisation|floatformat:1 }}%
                </div>
            </div>

            <!-- Cartes statistiques -->
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; margin-top: 1.5rem;">
                <div style="text-align: center; padding: 1.25rem; background: #F8FAFC; border-radius: 12px;">
                    <div style="color: #64748B; font-size: 0.875rem; margin-bottom: 0.5rem;">
                        {% trans "Objectif" %}
                    </div>
                    <div style="font-size: 1.75rem; font-weight: 700; color: #2563eb;">
                        {{ stats_objectifs.total_objectif|floatformat:0|intcomma }}
                    </div>
                    <div style="font-size: 0.75rem; color: #94a3b8; margin-top: 0.25rem;">FCFA</div>
                </div>
                
                <div style="text-align: center; padding: 1.25rem; background: #F8FAFC; border-radius: 12px;">
                    <div style="color: #64748B; font-size: 0.875rem; margin-bottom: 0.5rem;">
                        {% trans "Réalisé" %}
                    </div>
                    <div style="font-size: 1.75rem; font-weight: 700; color: #10B981;">
                        {{ stats_objectifs.total_realise|floatformat:0|intcomma }}
                    </div>
                    <div style="font-size: 0.75rem; color: #94a3b8; margin-top: 0.25rem;">FCFA</div>
                </div>
                
                <div style="text-align: center; padding: 1.25rem; background: #F8FAFC; border-radius: 12px;">
                    <div style="color: #64748B; font-size: 0.875rem; margin-bottom: 0.5rem;">
                        {% trans "Reste" %}
                    </div>
                    <div style="font-size: 1.75rem; font-weight: 700; color: #F59E0B;">
                        {{ stats_objectifs.reste_a_realiser|floatformat:0|intcomma }}
                    </div>
                    <div style="font-size: 0.75rem; color: #94a3b8; margin-top: 0.25rem;">FCFA</div>
                </div>
            </div>
            
            <!-- Lien vers la gestion détaillée -->
            <div style="text-align: center; margin-top: 1.5rem;">
                <a href="{% url 'inventaire:gestion_objectifs_annuels' %}?annee={{ stats_objectifs.annee }}" 
                class="btn btn-outline-primary">
                    <i class="fas fa-cog me-2"></i>
                    Gérer les objectifs détaillés
                </a>
            </div>
        </div>
        {% endif %}

        <!-- GRAPHIQUES -->
        {% if graph_data_json %}
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 2rem; margin-bottom: 2rem;">
            <div style="background: white; border-radius: 16px; padding: 2rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
                <h2 style="font-size: 1.25rem; font-weight: 700; color: #0F172A; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.75rem;">
                    <i class="fas fa-chart-area" style="color: #2563eb;"></i> 
                    {% trans "Évolution des Recettes (7 jours)" %}
                </h2>
                <div style="position: relative; height: 300px; width: 100%;">
                    <canvas id="chartRecettes"></canvas>
                </div>
            </div>

            <div style="background: white; border-radius: 16px; padding: 2rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
                <h2 style="font-size: 1.25rem; font-weight: 700; color: #0F172A; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.75rem;">
                    <i class="fas fa-chart-line" style="color: #2563eb;"></i> 
                    {% trans "Taux de Déperdition (7 jours)" %}
                </h2>
                <div style="position: relative; height: 300px; width: 100%;">
                    <canvas id="chartTaux"></canvas>
                </div>
            </div>
        </div>
        {% endif %}

            <!-- STATISTIQUES PESAGE (si l'utilisateur a accès) -->
            {% if stats_pesage %}
            <div style="background: white; border-radius: 16px; padding: 2rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); margin-bottom: 2rem;">
                <h2 style="font-size: 1.25rem; font-weight: 700; color: #0F172A; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid #F1F5F9; display: flex; align-items: center; gap: 0.75rem;">
                    <i class="fas fa-weight-scale" style="color: #8B5CF6;"></i> 
                    {% trans "Module Pesage" %}
                    {% if stats_pesage.station %}
                    <span style="font-size: 0.875rem; color: #64748B; font-weight: 400; margin-left: auto;">
                        {{ stats_pesage.station.nom }}
                    </span>
                    {% endif %}
                </h2>
                
                <!-- Cartes statistiques Pesage -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem;">
                    
                    <!-- Pesées du jour -->
                    <div style="text-align: center; padding: 1.25rem; background: linear-gradient(135deg, #8B5CF6 0%, #A78BFA 100%); border-radius: 12px; color: white;">
                        <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">
                            <i class="fas fa-balance-scale me-1"></i>{% trans "Pesées Aujourd'hui" %}
                        </div>
                        <div style="font-size: 2rem; font-weight: 700;">
                            {{ stats_pesage.pesees_jour|default:"—" }}
                        </div>
                    </div>
                    
                    <!-- Amendes émises aujourd'hui -->
                    <div style="text-align: center; padding: 1.25rem; background: linear-gradient(135deg, #F59E0B 0%, #FCD34D 100%); border-radius: 12px; color: white;">
                        <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">
                            <i class="fas fa-file-invoice me-1"></i>{% trans "Amendes Émises" %}
                        </div>
                        <div style="font-size: 2rem; font-weight: 700;">
                            {{ stats_pesage.emissions_jour|default:0 }}
                        </div>
                        <div style="font-size: 0.75rem; opacity: 0.8;">
                            {% trans "dont" %} {{ stats_pesage.hors_gabarit_jour|default:0 }} HG
                        </div>
                    </div>
                    
                    <!-- Montant émis -->
                    <div style="text-align: center; padding: 1.25rem; background: linear-gradient(135deg, #3B82F6 0%, #60A5FA 100%); border-radius: 12px; color: white;">
                        <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">
                            <i class="fas fa-coins me-1"></i>{% trans "Montant Émis" %}
                        </div>
                        <div style="font-size: 1.5rem; font-weight: 700;">
                            {{ stats_pesage.montant_emis_jour|floatformat:0|intcomma }}
                        </div>
                        <div style="font-size: 0.75rem; opacity: 0.8;">FCFA</div>
                    </div>
                    
                    <!-- Montant recouvré -->
                    <div style="text-align: center; padding: 1.25rem; background: linear-gradient(135deg, #10B981 0%, #6EE7B7 100%); border-radius: 12px; color: white;">
                        <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">
                            <i class="fas fa-hand-holding-usd me-1"></i>{% trans "Recouvré" %}
                        </div>
                        <div style="font-size: 1.5rem; font-weight: 700;">
                            {{ stats_pesage.montant_recouvre_jour|floatformat:0|intcomma }}
                        </div>
                        <div style="font-size: 0.75rem; opacity: 0.8;">FCFA</div>
                    </div>
                    
                    <!-- Reste à recouvrer -->
                    <div style="text-align: center; padding: 1.25rem; background: linear-gradient(135deg, #EF4444 0%, #FCA5A5 100%); border-radius: 12px; color: white;">
                        <div style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">
                            <i class="fas fa-clock me-1"></i>{% trans "Reste à Recouvrer" %}
                        </div>
                        <div style="font-size: 1.5rem; font-weight: 700;">
                            {{ stats_pesage.reste_a_recouvrer_jour|floatformat:0|intcomma }}
                        </div>
                        <div style="font-size: 0.75rem; opacity: 0.8;">FCFA</div>
                    </div>
                    
                    <!-- Amendes non payées (en attente) -->
                    <div style="text-align: center; padding: 1.25rem; background: #F8FAFC; border-radius: 12px; border: 2px dashed #CBD5E1;">
                        <div style="font-size: 0.875rem; color: #64748B; margin-bottom: 0.5rem;">
                            <i class="fas fa-hourglass-half me-1"></i>{% trans "En Attente" %}
                        </div>
                        <div style="font-size: 2rem; font-weight: 700; color: {% if stats_pesage.amendes_non_payees > 0 %}#F59E0B{% else %}#10B981{% endif %};">
                            {{ stats_pesage.amendes_non_payees|default:0 }}
                        </div>
                        <div style="font-size: 0.75rem; color: #94a3b8;">{% trans "amendes" %}</div>
                    </div>
                </div>
                
                <!-- Actions rapides Pesage -->
                <div style="display: flex; flex-wrap: wrap; gap: 1rem; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #E2E8F0;">
                    {% if user.habilitation == 'chef_equipe_pesage' or user.is_admin %}
                    <a href="{% url 'inventaire:saisir_amende' %}" 
                    style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1.25rem; background: #8B5CF6; color: white; border-radius: 8px; text-decoration: none; font-weight: 500; transition: all 0.3s;">
                        <i class="fas fa-plus"></i>{% trans "Saisir Amende" %}
                    </a>
                    {% endif %}
                    
                    {% if user.habilitation == 'regisseur_pesage' or user.habilitation == 'chef_station_pesage' or user.is_admin %}
                    <a href="{% url 'inventaire:liste_amendes_a_valider' %}" 
                    style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1.25rem; background: #10B981; color: white; border-radius: 8px; text-decoration: none; font-weight: 500; transition: all 0.3s; position: relative;">
                        <i class="fas fa-check-double"></i>{% trans "Valider Paiements" %}
                        {% if stats_pesage.amendes_non_payees > 0 %}
                        <span style="position: absolute; top: -8px; right: -8px; background: #EF4444; color: white; font-size: 0.75rem; padding: 0.125rem 0.5rem; border-radius: 50px;">
                            {{ stats_pesage.amendes_non_payees }}
                        </span>
                        {% endif %}
                    </a>
                    {% endif %}
                    
                    <a href="{% url 'inventaire:recettes_pesage' %}" 
                    style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1.25rem; background: #3B82F6; color: white; border-radius: 8px; text-decoration: none; font-weight: 500; transition: all 0.3s;">
                        <i class="fas fa-coins"></i>{% trans "Voir Recettes" %}
                    </a>
                    
                    <a href="{% url 'inventaire:statistiques_pesage' %}" 
                    style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1.25rem; background: white; color: #475569; border: 1px solid #CBD5E1; border-radius: 8px; text-decoration: none; font-weight: 500; transition: all 0.3s;">
                        <i class="fas fa-chart-bar"></i>{% trans "Statistiques" %}
                    </a>
                </div>
            </div>
            {% endif %}

    </div>
</div>

<!-- JAVASCRIPT POUR LES GRAPHIQUES -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const graphData = {{ graph_data_json|safe }};
    Chart.defaults.font.family = "'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif";
    Chart.defaults.color = '#475569';

    {% if graph_data_json %}
    if (graphData.evolution_7j && document.getElementById('chartRecettes')) {
        const ctxRecettes = document.getElementById('chartRecettes').getContext('2d');
        new Chart(ctxRecettes, {
            type: 'line',
            data: {
                labels: graphData.evolution_7j.labels,
                datasets: [{
                    label: 'Recettes (FCFA)',
                    data: graphData.evolution_7j.recettes,
                    borderColor: '#2563eb',
                    backgroundColor: 'rgba(37, 99, 235, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 5,
                    pointHoverRadius: 7,
                    pointBackgroundColor: '#2563eb',
                    pointBorderColor: '#fff',
                    pointBorderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: true, position: 'top' },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        cornerRadius: 8
                    }
                },
                scales: {
                    y: { beginAtZero: true, grid: { color: 'rgba(0, 0, 0, 0.05)' } },
                    x: { grid: { display: false } }
                }
            }
        });
    }

    if (graphData.evolution_7j && document.getElementById('chartTaux')) {
        const ctxTaux = document.getElementById('chartTaux').getContext('2d');
        const backgroundColors = graphData.evolution_7j.taux.map(taux => {
            if (taux > -10) return 'rgba(16, 185, 129, 0.6)';
            if (taux >= -30) return 'rgba(245, 158, 11, 0.6)';
            return 'rgba(239, 68, 68, 0.6)';
        });
        const borderColors = graphData.evolution_7j.taux.map(taux => {
            if (taux > -10) return '#10B981';
            if (taux >= -30) return '#F59E0B';
            return '#EF4444';
        });

        new Chart(ctxTaux, {
            type: 'bar',
            data: {
                labels: graphData.evolution_7j.labels,
                datasets: [{
                    label: 'Taux de Déperdition (%)',
                    data: graphData.evolution_7j.taux,
                    backgroundColor: backgroundColors,
                    borderColor: borderColors,
                    borderWidth: 2,
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: true, position: 'top' },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        cornerRadius: 8
                    }
                },
                scales: {
                    y: { beginAtZero: false, grid: { color: 'rgba(0, 0, 0, 0.05)' } },
                    x: { grid: { display: false } }
                }
            }
        });
    }
    {% endif %}
});
</script>
{% endblock %}