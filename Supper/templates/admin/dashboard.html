{% extends "admin/base_site.html" %}
{% load i18n static admin_urls %}

{% block title %}{{ title }} | {{ site_title|default:_('Django site admin') }}{% endblock %}

{% block extrahead %}
    {{ block.super }}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{% static 'admin/css/supper_modern.css' %}" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* Styles spécifiques au dashboard */
        .dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 16px;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }
        
        .stat-card {
            background: var(--surface-card);
            border-radius: 20px;
            padding: 24px;
            box-shadow: var(--shadow-lg);
            border: 1px solid rgba(148, 163, 184, 0.1);
            position: relative;
            overflow: hidden;
            transition: var(--transition);
        }
        
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left:{% extends "admin/base_site.html" %}
{% load i18n static admin_urls %}

{% block title %}{{ title }} | {{ site_title|default:_('Django site admin') }}{% endblock %}

{% block extrahead %}
    {{ block.super }}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .dashboard-card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 20px;
            margin-bottom: 20px;
            transition: transform 0.2s;
        }
        .dashboard-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .stat-card {
            text-align: center;
            color: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .stat-card.blue { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .stat-card.green { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .stat-card.orange { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .stat-card.purple { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        .stat-change {
            font-size: 0.8rem;
            margin-top: 5px;
        }
        
        .alert-item {
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 6px;
            border-left: 4px solid;
        }
        .alert-item.warning {
            background-color: #fff3cd;
            border-left-color: #ffc107;
            color: #856404;
        }
        .alert-item.danger {
            background-color: #f8d7da;
            border-left-color: #dc3545;
            color: #721c24;
        }
        .alert-item.info {
            background-color: #d1ecf1;
            border-left-color: #17a2b8;
            color: #0c5460;
        }
        
        .activity-item {
            padding: 10px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
        }
        .activity-item:last-child {
            border-bottom: none;
        }
        .activity-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #007cba;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-weight: bold;
        }
        .activity-content {
            flex: 1;
        }
        .activity-time {
            font-size: 0.8rem;
            color: #666;
        }
        .activity-status {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-left: 10px;
        }
        .activity-status.success {
            background: #28a745;
        }
        .activity-status.error {
            background: #dc3545;
        }
        
        .day-status {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin: 5px;
            color: white;
            font-weight: bold;
            font-size: 0.8rem;
        }
        .day-status.success { background: #28a745; }
        .day-status.warning { background: #ffc107; }
        .day-status.secondary { background: #6c757d; }
        
        .action-buttons .btn {
            margin: 5px;
            border-radius: 20px;
            padding: 8px 20px;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin: 20px 0;
        }
        
        .breadcrumb {
            background: none;
            padding: 0;
            margin-bottom: 20px;
        }
        
        .page-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 8px;
            margin-bottom: 30px;
        }
        
        .refresh-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 10;
        }
        
        @media (max-width: 768px) {
            .stat-number { font-size: 2rem; }
            .dashboard-card { padding: 15px; }
        }
    </style>
{% endblock %}

{% block content %}
<div class="page-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h1 class="mb-2">
                <i class="fas fa-tachometer-alt me-2"></i>
                {{ title }}
            </h1>
            <p class="mb-0">{{ subtitle }}</p>
        </div>
        <div class="action-buttons">
            <button class="btn btn-light" onclick="refreshDashboard()">
                <i class="fas fa-sync-alt"></i> Actualiser
            </button>
            <a href="{% url 'admin:open_day' %}" class="btn btn-success">
                <i class="fas fa-calendar-plus"></i> Ouvrir Jour
            </a>
            <a href="{% url 'admin:saisie_inventaire' %}" class="btn btn-info">
                <i class="fas fa-edit"></i> Saisir Inventaire
            </a>
        </div>
    </div>
</div>

<!-- Fil d'Ariane -->
<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item">
            <i class="fas fa-home"></i>
            <a href="{% url 'admin:index' %}">Administration</a>
        </li>
        <li class="breadcrumb-item active">
            <i class="fas fa-chart-line"></i>
            Tableau de Bord
        </li>
    </ol>
</nav>

<!-- Alertes Système -->
{% if alerts %}
<div class="row mb-4">
    <div class="col-12">
        <div class="dashboard-card">
            <h5><i class="fas fa-exclamation-triangle text-warning"></i> Alertes Système</h5>
            {% for alert in alerts %}
            <div class="alert-item {{ alert.type }}">
                <strong>{{ alert.message }}</strong>
                {% if alert.action_url %}
                <a href="{{ alert.action_url }}" class="btn btn-sm btn-outline-primary ms-2">
                    {{ alert.action_text }}
                </a>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<!-- Cartes Statistiques Principales -->
<div class="row mb-4">
    <div class="col-xl-3 col-md-6">
        <div class="stat-card blue">
            <div class="stat-number" id="total-users">{{ stats.total_users }}</div>
            <div class="stat-label">Utilisateurs Actifs</div>
            <div class="stat-change">
                <i class="fas fa-users"></i> 
                Total système
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="stat-card green">
            <div class="stat-number" id="total-postes">{{ stats.total_postes }}</div>
            <div class="stat-label">Postes Actifs</div>
            <div class="stat-change">
                <i class="fas fa-map-marker-alt"></i>
                Péages + Pesages
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="stat-card orange">
            <div class="stat-number" id="inventaires-today">{{ stats.inventaires_today }}</div>
            <div class="stat-label">Inventaires Aujourd'hui</div>
            <div class="stat-change">
                <i class="fas fa-clipboard-list"></i>
                <span id="inventaires-week">{{ stats.inventaires_week }}</span> cette semaine
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="stat-card purple">
            <div class="stat-number" id="recettes-today">{{ stats.recettes_today }}</div>
            <div class="stat-label">Recettes Aujourd'hui</div>
            <div class="stat-change">
                <i class="fas fa-euro-sign"></i>
                Déclarations saisies
            </div>
        </div>
    </div>
</div>

<!-- Statistiques Temps Réel -->
<div class="row mb-4">
    <div class="col-lg-6">
        <div class="dashboard-card">
            <h5><i class="fas fa-wifi text-success"></i> Activité Temps Réel</h5>
            <div class="row text-center">
                <div class="col-6">
                    <h3 class="text-primary" id="users-online">{{ stats.users_online }}</h3>
                    <small class="text-muted">Utilisateurs connectés</small>
                </div>
                <div class="col-6">
                    <h3 class="text-success" id="actions-today">-</h3>
                    <small class="text-muted">Actions aujourd'hui</small>
                </div>
            </div>
            <div class="mt-2">
                <small class="text-muted">
                    <i class="fas fa-clock"></i>
                    Mise à jour automatique toutes les 5 minutes
                </small>
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="dashboard-card">
            <h5><i class="fas fa-calendar-week"></i> Statut des 7 Derniers Jours</h5>
            <div class="text-center">
                {% for day in days_status %}
                <div class="day-status {{ day.status }}" title="{{ day.date|date:'d/m/Y' }}">
                    {{ day.label }}
                </div>
                {% endfor %}
            </div>
            <div class="mt-3">
                <small class="text-muted d-flex justify-content-center">
                    <span class="me-3"><span class="day-status success" style="width:15px;height:15px;"></span> Ouvert</span>
                    <span class="me-3"><span class="day-status warning" style="width:15px;height:15px;"></span> Impertinent</span>
                    <span><span class="day-status secondary" style="width:15px;height:15px;"></span> Fermé</span>
                </small>
            </div>
        </div>
    </div>
</div>

<!-- Graphiques -->
<div class="row mb-4">
    <div class="col-lg-8">
        <div class="dashboard-card">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5><i class="fas fa-chart-line"></i> Activité du Système</h5>
                <div>
                    <button class="btn btn-sm btn-outline-primary" onclick="loadActivity('24h')">24h</button>
                    <button class="btn btn-sm btn-outline-primary" onclick="loadActivity('7d')">7j</button>
                    <button class="btn btn-sm btn-outline-primary" onclick="loadActivity('30d')">30j</button>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="activityChart"></canvas>
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="dashboard-card">
            <h5><i class="fas fa-chart-bar"></i> Taux de Déperdition</h5>
            <div class="chart-container">
                <canvas id="deperditionChart"></canvas>
            </div>
            <div class="mt-2">
                <small class="text-muted">
                    <span class="text-success">■</span> Bon (>-10%) 
                    <span class="text-warning">■</span> Attention (-10% à -30%)
                    <span class="text-danger">■</span> Critique (<-30%)
                </small>
            </div>
        </div>
    </div>
</div>

<!-- Activité Récente et Actions Rapides -->
<div class="row">
    <div class="col-lg-8">
        <div class="dashboard-card">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5><i class="fas fa-history"></i> Activité Récente</h5>
                <a href="{% url 'admin:accounts_journalaudit_changelist' %}" class="btn btn-sm btn-outline-primary">
                    Voir tout
                </a>
            </div>
            <div id="recent-activity">
                {% for activity in recent_activity %}
                <div class="activity-item">
                    <div class="activity-avatar">
                        {{ activity.utilisateur.nom_complet.0|upper }}
                    </div>
                    <div class="activity-content">
                        <strong>{{ activity.utilisateur.nom_complet }}</strong>
                        <div class="text-muted">{{ activity.action }}</div>
                        <div class="activity-time">
                            <i class="fas fa-clock"></i>
                            {{ activity.timestamp|timesince }} ago
                        </div>
                    </div>
                    <div class="activity-status {% if activity.succes %}success{% else %}error{% endif %}"></div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="dashboard-card">
            <h5><i class="fas fa-tools"></i> Actions Rapides</h5>
            <div class="d-grid gap-2">
                <a href="{% url 'admin:accounts_utilisateursupper_add' %}" class="btn btn-primary">
                    <i class="fas fa-user-plus"></i> Créer Utilisateur
                </a>
                <a href="{% url 'admin:accounts_poste_changelist' %}" class="btn btn-info">
                    <i class="fas fa-map-marker-alt"></i> Gérer Postes
                </a>
                <a href="{% url 'admin:export_audit' %}" class="btn btn-warning">
                    <i class="fas fa-download"></i> Export Journal
                </a>
                <button class="btn btn-secondary" onclick="showSystemHealth()">
                    <i class="fas fa-heartbeat"></i> Santé Système
                </button>
            </div>
        </div>
        
        <div class="dashboard-card mt-3">
            <h5><i class="fas fa-cog"></i> Configuration Rapide</h5>
            <form method="post" action="{% url 'admin:open_day' %}">
                {% csrf_token %}
                <div class="d-grid gap-2">
                    <button type="submit" class="btn btn-success btn-sm">
                        <i class="fas fa-calendar-check"></i> Ouvrir Jour Actuel
                    </button>
                </div>
            </form>
            
            <hr>
            
            <form method="post" action="{% url 'admin:mark_impertinent' %}">
                {% csrf_token %}
                <div class="mb-2">
                    <label for="impertinent-date" class="form-label">Marquer jour impertinent:</label>
                    <input type="date" class="form-control form-control-sm" id="impertinent-date" name="date" required>
                </div>
                <button type="submit" class="btn btn-warning btn-sm w-100" onclick="return confirm('Confirmer?')">
                    <i class="fas fa-exclamation-triangle"></i> Marquer Impertinent
                </button>
            </form>
        </div>
    </div>
</div>

<!-- Scripts -->
<script>
// Variables globales
let activityChart = null;
let deperditionChart = null;
let refreshInterval = null;

// Initialisation au chargement de la page
document.addEventListener('DOMContentLoaded', function() {
    initCharts();
    startAutoRefresh();
    loadActivity('24h');
    loadDeperdition();
});

// Initialisation des graphiques
function initCharts() {
    // Graphique d'activité
    const activityCtx = document.getElementById('activityChart').getContext('2d');
    activityChart = new Chart(activityCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Actions',
                data: [],
                borderColor: '#007cba',
                backgroundColor: 'rgba(0, 124, 186, 0.1)',
                tension: 0.4,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        precision: 0
                    }
                }
            }
        }
    });

    // Graphique de déperdition
    const deperditionCtx = document.getElementById('deperditionChart').getContext('2d');
    deperditionChart = new Chart(deperditionCtx, {
        type: 'bar',
        data: {
            labels: [],
            datasets: [{
                label: 'Taux (%)',
                data: [],
                backgroundColor: []
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: false,
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            }
        }
    });
}

// Charger l'activité
function loadActivity(period) {
    fetch(`{% url 'admin:api_activity' %}?period=${period}`, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            console.error('Erreur API:', data.error);
            return;
        }
        
        activityChart.data.labels = data.labels;
        activityChart.data.datasets[0].data = data.data;
        activityChart.update();
        
        // Mettre à jour le titre si disponible
        if (data.title) {
            const chartTitle = document.querySelector('#activityChart').closest('.dashboard-card').querySelector('h5');
            chartTitle.innerHTML = '<i class="fas fa-chart-line"></i> ' + data.title;
        }
    })
    .catch(error => {
        console.error('Erreur lors du chargement de l\'activité:', error);
    });
}

// Charger les taux de déperdition
function loadDeperdition() {
    fetch(`{% url 'admin:api_deperdition' %}`, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        deperditionChart.data.labels = data.labels;
        deperditionChart.data.datasets[0].data = data.data;
        deperditionChart.data.datasets[0].backgroundColor = data.colors;
        deperditionChart.update();
    })
    .catch(error => {
        console.error('Erreur lors du chargement de la déperdition:', error);
    });
}

// Actualiser les statistiques
function refreshStats() {
    fetch(`{% url 'admin:api_stats' %}`, {
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        // Mettre à jour les cartes de stats
        document.getElementById('total-users').textContent = data.total_users;
        document.getElementById('total-postes').textContent = data.total_postes;
        document.getElementById('inventaires-today').textContent = data.inventaires_today;
        document.getElementById('recettes-today').textContent = data.recettes_today;
        document.getElementById('inventaires-week').textContent = data.inventaires_week;
        document.getElementById('users-online').textContent = data.users_online;
        
        // Animation des changements
        animateStatCards();
    })
    .catch(error => {
        console.error('Erreur lors de l\'actualisation des stats:', error);
    });
}

// Animation des cartes de statistiques
function animateStatCards() {
    document.querySelectorAll('.stat-card').forEach(card => {
        card.style.transform = 'scale(1.05)';
        setTimeout(() => {
            card.style.transform = 'scale(1)';
        }, 200);
    });
}

// Actualisation complète du dashboard
function refreshDashboard() {
    const btn = event.target.closest('button');
    const originalHtml = btn.innerHTML;
    
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Actualisation...';
    btn.disabled = true;
    
    Promise.all([
        refreshStats(),
        loadActivity('24h'),
        loadDeperdition()
    ]).finally(() => {
        btn.innerHTML = originalHtml;
        btn.disabled = false;
        
        // Notification de succès
        showToast('Dashboard actualisé avec succès', 'success');
    });
}

// Démarrer l'actualisation automatique
function startAutoRefresh() {
    refreshInterval = setInterval(() => {
        refreshStats();
    }, 5 * 60 * 1000); // 5 minutes
}

// Afficher la santé du système
function showSystemHealth() {
    alert('Fonctionnalité de santé système à développer');
}

// Notification toast
function showToast(message, type = 'info') {
    // Implémentation simple - peut être améliorée avec une librairie
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.innerHTML = message;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 3000);
}

// Fonction utilitaire pour récupérer le cookie CSRF
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Nettoyage à la fermeture de la page
window.addEventListener('beforeunload', function() {
    if (refreshInterval) {
        clearInterval(refreshInterval);
    }
});
</script>
{% endblock %}