{% extends "admin/base_site.html" %}
{% load static i18n inventaire_extras %}

{% block title %}{{ title }} - SUPPER{% endblock %}

{% block extrastyle %}
<style>
    body { margin: 0 !important; padding: 0 !important; }
    #content.main-content { background: transparent !important; padding: 0 !important; min-height: auto !important; }
    .content-wrapper { padding: 0 !important; max-width: none !important; }
</style>
{% endblock %}

{% block content %}
<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: calc(100vh - 80px); padding: 2rem; margin: 0; width: 100%;">
    <div style="max-width: 1400px; margin: 0 auto;">
        
        <!-- EN-TÊTE -->
        <div style="background: rgba(255, 255, 255, 0.98); backdrop-filter: blur(10px); border-radius: 20px; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.15); border-top: 5px solid #8B5CF6;">
            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                <div>
                    <h1 style="margin: 0; font-size: 2rem; font-weight: 800; color: #0F172A; display: flex; align-items: center; gap: 0.75rem;">
                        <i class="fas fa-chart-bar" style="color: #8B5CF6;"></i>
                        {% trans "Statistiques Pesage" %}
                    </h1>
                    <p style="margin: 0.5rem 0 0 0; color: #64748B;">
                        {% if station %}
                            Station: <strong style="color: #7C3AED;">{{ station.nom }}</strong>
                        {% else %}
                            <strong style="color: #7C3AED;">Toutes les stations</strong>
                        {% endif %}
                        &nbsp;•&nbsp; Période: {{ date_debut|date:"d/m/Y" }} - {{ date_fin|date:"d/m/Y" }}
                    </p>
                </div>
                <a href="{% url 'inventaire:liste_amendes' %}" 
                   style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1.5rem; background: white; color: #7C3AED; border: 2px solid #7C3AED; border-radius: 10px; text-decoration: none; font-weight: 600; transition: all 0.3s;">
                    <i class="fas fa-arrow-left"></i> {% trans "Retour" %}
                </a>
            </div>
        </div>
        
        <!-- FILTRES -->
        <div style="background: white; border-radius: 16px; padding: 1.5rem; margin-bottom: 2rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
            <form method="get" style="display: flex; flex-wrap: wrap; gap: 1rem; align-items: flex-end;">
                
                <!-- Filtre Période -->
                <div style="flex: 1; min-width: 200px;">
                    <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.5rem; font-size: 0.875rem;">
                        <i class="fas fa-calendar-alt me-1"></i>{% trans "Période" %}
                    </label>
                    <select name="periode" class="form-select" style="width: 100%; padding: 0.625rem; border: 2px solid #E5E7EB; border-radius: 8px; font-size: 0.95rem;">
                        <option value="jour" {% if periode == 'jour' %}selected{% endif %}>{% trans "Aujourd'hui" %}</option>
                        <option value="semaine" {% if periode == 'semaine' %}selected{% endif %}>{% trans "Cette semaine" %}</option>
                        <option value="mois" {% if periode == 'mois' %}selected{% endif %}>{% trans "Ce mois" %}</option>
                        <option value="trimestre" {% if periode == 'trimestre' %}selected{% endif %}>{% trans "Ce trimestre" %}</option>
                        <option value="annee" {% if periode == 'annee' %}selected{% endif %}>{% trans "Cette année" %}</option>
                        <option value="tout" {% if periode == 'tout' %}selected{% endif %}>{% trans "Tout" %}</option>
                    </select>
                </div>
                
                <!-- Filtre Station (admin uniquement) -->
                {% if is_admin and stations_accessibles.count > 1 %}
                <div style="flex: 1; min-width: 250px;">
                    <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 0.5rem; font-size: 0.875rem;">
                        <i class="fas fa-map-marker-alt me-1"></i>{% trans "Station" %}
                    </label>
                    <select name="station" class="form-select" style="width: 100%; padding: 0.625rem; border: 2px solid #E5E7EB; border-radius: 8px; font-size: 0.95rem;">
                        <option value="">{% trans "Toutes les stations" %}</option>
                        {% for s in stations_accessibles %}
                        <option value="{{ s.id }}" {% if station and s.id == station.id %}selected{% endif %}>{{ s.nom }}</option>
                        {% endfor %}
                    </select>
                </div>
                {% endif %}
                
                <!-- Bouton Filtrer -->
                <div>
                    <button type="submit" style="padding: 0.625rem 1.5rem; background: linear-gradient(135deg, #8B5CF6, #7C3AED); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; transition: all 0.3s;">
                        <i class="fas fa-filter"></i> {% trans "Filtrer" %}
                    </button>
                </div>
            </form>
        </div>
        
        <!-- CARTES STATISTIQUES PRINCIPALES -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
            
            <!-- Émissions -->
            <div style="background: white; border-radius: 16px; padding: 1.75rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border-top: 4px solid #F59E0B;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                    <div style="color: #64748B; font-size: 0.875rem; font-weight: 600; text-transform: uppercase;">
                        {% trans "Émissions" %}
                    </div>
                    <div style="width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; color: white; background: linear-gradient(135deg, #F59E0B, #FCD34D);">
                        <i class="fas fa-file-invoice"></i>
                    </div>
                </div>
                <div style="font-size: 2.5rem; font-weight: 700; color: #0F172A;">
                    {{ stats.emissions|intcomma }}
                </div>
                <div style="color: #64748B; font-size: 0.875rem; margin-top: 0.5rem;">
                    {% trans "dont" %} <strong style="color: #F59E0B;">{{ stats.hors_gabarit }}</strong> {% trans "hors gabarit" %}
                </div>
            </div>
            
            <!-- Montant Émis -->
            <div style="background: white; border-radius: 16px; padding: 1.75rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border-top: 4px solid #3B82F6;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                    <div style="color: #64748B; font-size: 0.875rem; font-weight: 600; text-transform: uppercase;">
                        {% trans "Montant Émis" %}
                    </div>
                    <div style="width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; color: white; background: linear-gradient(135deg, #3B82F6, #60A5FA);">
                        <i class="fas fa-coins"></i>
                    </div>
                </div>
                <div style="font-size: 2rem; font-weight: 700; color: #0F172A;">
                    {{ stats.montant_emis|floatformat:0|intcomma }}
                </div>
                <div style="color: #64748B; font-size: 0.875rem; margin-top: 0.5rem;">
                    FCFA
                </div>
            </div>
            
            <!-- Montant Recouvré -->
            <div style="background: white; border-radius: 16px; padding: 1.75rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border-top: 4px solid #10B981;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                    <div style="color: #64748B; font-size: 0.875rem; font-weight: 600; text-transform: uppercase;">
                        {% trans "Montant Recouvré" %}
                    </div>
                    <div style="width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; color: white; background: linear-gradient(135deg, #10B981, #6EE7B7);">
                        <i class="fas fa-hand-holding-usd"></i>
                    </div>
                </div>
                <div style="font-size: 2rem; font-weight: 700; color: #10B981;">
                    {{ stats.montant_recouvre|floatformat:0|intcomma }}
                </div>
                <div style="color: #64748B; font-size: 0.875rem; margin-top: 0.5rem;">
                    FCFA
                </div>
            </div>
            
            <!-- Reste à Recouvrer -->
            <div style="background: white; border-radius: 16px; padding: 1.75rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border-top: 4px solid #EF4444;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                    <div style="color: #64748B; font-size: 0.875rem; font-weight: 600; text-transform: uppercase;">
                        {% trans "Reste à Recouvrer" %}
                    </div>
                    <div style="width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; color: white; background: linear-gradient(135deg, #EF4444, #FCA5A5);">
                        <i class="fas fa-clock"></i>
                    </div>
                </div>
                <div style="font-size: 2rem; font-weight: 700; color: #EF4444;">
                    {{ stats.reste_a_recouvrer|floatformat:0|intcomma }}
                </div>
                <div style="color: #64748B; font-size: 0.875rem; margin-top: 0.5rem;">
                    FCFA
                </div>
            </div>
            
            <!-- Taux de Recouvrement -->
            <div style="background: white; border-radius: 16px; padding: 1.75rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border-top: 4px solid {% if stats.taux_recouvrement >= 80 %}#10B981{% elif stats.taux_recouvrement >= 50 %}#F59E0B{% else %}#EF4444{% endif %};">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                    <div style="color: #64748B; font-size: 0.875rem; font-weight: 600; text-transform: uppercase;">
                        {% trans "Taux Recouvrement" %}
                    </div>
                    <div style="width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; color: white; background: linear-gradient(135deg, {% if stats.taux_recouvrement >= 80 %}#10B981, #6EE7B7{% elif stats.taux_recouvrement >= 50 %}#F59E0B, #FCD34D{% else %}#EF4444, #FCA5A5{% endif %});">
                        <i class="fas fa-percentage"></i>
                    </div>
                </div>
                <div style="font-size: 2.5rem; font-weight: 700; color: {% if stats.taux_recouvrement >= 80 %}#10B981{% elif stats.taux_recouvrement >= 50 %}#F59E0B{% else %}#EF4444{% endif %};">
                    {{ stats.taux_recouvrement }}%
                </div>
                <div style="color: #64748B; font-size: 0.875rem; margin-top: 0.5rem;">
                    {% if stats.taux_recouvrement >= 80 %}
                        <i class="fas fa-check-circle text-success me-1"></i>{% trans "Excellent" %}
                    {% elif stats.taux_recouvrement >= 50 %}
                        <i class="fas fa-exclamation-circle text-warning me-1"></i>{% trans "À améliorer" %}
                    {% else %}
                        <i class="fas fa-times-circle text-danger me-1"></i>{% trans "Critique" %}
                    {% endif %}
                </div>
            </div>
            
            <!-- Nombre de Pesées -->
            <div style="background: white; border-radius: 16px; padding: 1.75rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border-top: 4px solid #8B5CF6;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                    <div style="color: #64748B; font-size: 0.875rem; font-weight: 600; text-transform: uppercase;">
                        {% trans "Pesées Effectuées" %}
                    </div>
                    <div style="width: 48px; height: 48px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; color: white; background: linear-gradient(135deg, #8B5CF6, #A78BFA);">
                        <i class="fas fa-balance-scale"></i>
                    </div>
                </div>
                <div style="font-size: 2.5rem; font-weight: 700; color: #0F172A;">
                    {{ stats.nombre_pesees|intcomma }}
                </div>
                <div style="color: #64748B; font-size: 0.875rem; margin-top: 0.5rem;">
                    {% trans "véhicules pesés" %}
                </div>
            </div>
        </div>
        
        <!-- BARRE DE PROGRESSION RECOUVREMENT -->
        <div style="background: white; border-radius: 16px; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
            <h3 style="margin: 0 0 1.5rem 0; font-size: 1.125rem; font-weight: 700; color: #0F172A; display: flex; align-items: center; gap: 0.5rem;">
                <i class="fas fa-chart-pie" style="color: #8B5CF6;"></i>
                {% trans "Progression du Recouvrement" %}
            </h3>
            
            <div style="position: relative; height: 40px; background: #F1F5F9; border-radius: 20px; overflow: hidden; margin-bottom: 1rem;">
                <div style="position: absolute; top: 0; left: 0; height: 100%; width: {{ stats.taux_recouvrement }}%; background: linear-gradient(90deg, {% if stats.taux_recouvrement >= 80 %}#10B981, #6EE7B7{% elif stats.taux_recouvrement >= 50 %}#F59E0B, #FCD34D{% else %}#EF4444, #FCA5A5{% endif %}); border-radius: 20px; transition: width 1s ease-in-out;"></div>
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-weight: 700; font-size: 1rem; color: {% if stats.taux_recouvrement > 50 %}white{% else %}#0F172A{% endif %}; text-shadow: {% if stats.taux_recouvrement > 50 %}0 1px 2px rgba(0,0,0,0.3){% else %}none{% endif %};">
                    {{ stats.taux_recouvrement }}% {% trans "recouvré" %}
                </div>
            </div>
            
            <div style="display: flex; justify-content: space-between; font-size: 0.875rem; color: #64748B;">
                <span>
                    <i class="fas fa-check-circle text-success me-1"></i>
                    {% trans "Recouvré:" %} <strong>{{ stats.montant_recouvre|floatformat:0|intcomma }} FCFA</strong>
                </span>
                <span>
                    <i class="fas fa-clock text-danger me-1"></i>
                    {% trans "Reste:" %} <strong>{{ stats.reste_a_recouvrer|floatformat:0|intcomma }} FCFA</strong>
                </span>
            </div>
        </div>
        
        <!-- INDICATEURS SUPPLÉMENTAIRES -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
            
            <!-- Répartition Gabarit/Hors Gabarit -->
            <div style="background: white; border-radius: 16px; padding: 2rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
                <h3 style="margin: 0 0 1.5rem 0; font-size: 1.125rem; font-weight: 700; color: #0F172A; display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-truck" style="color: #F59E0B;"></i>
                    {% trans "Répartition des Infractions" %}
                </h3>
                
                {% if stats.emissions > 0 %}
                    {% with gabarit_count=stats.emissions|add:"-"|add:stats.hors_gabarit|slice:"1:" %}
                    <div style="display: flex; gap: 1.5rem; align-items: center;">
                        <div style="flex: 1;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                <span style="color: #64748B; font-size: 0.875rem;">{% trans "Gabarit" %}</span>
                                <span style="font-weight: 600;">{{ stats.emissions|add:stats.hors_gabarit|default:0 }}</span>
                            </div>
                            <div style="height: 8px; background: #E2E8F0; border-radius: 4px; overflow: hidden;">
                                {% widthratio stats.emissions|add:"-"|add:stats.hors_gabarit stats.emissions 100 as gabarit_pct %}
                                <div style="height: 100%; width: {% widthratio stats.emissions|add:stats.hors_gabarit|mul:-1|add:stats.emissions stats.emissions 100 %}%; background: #3B82F6; border-radius: 4px;"></div>
                            </div>
                        </div>
                    </div>
                    {% endwith %}
                    
                    <div style="margin-top: 1rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                            <span style="color: #64748B; font-size: 0.875rem;">{% trans "Hors Gabarit" %}</span>
                            <span style="font-weight: 600; color: #F59E0B;">{{ stats.hors_gabarit }}</span>
                        </div>
                        <div style="height: 8px; background: #E2E8F0; border-radius: 4px; overflow: hidden;">
                            <div style="height: 100%; width: {% widthratio stats.hors_gabarit stats.emissions 100 %}%; background: #F59E0B; border-radius: 4px;"></div>
                        </div>
                    </div>
                {% else %}
                    <div style="text-align: center; padding: 2rem; color: #64748B;">
                        <i class="fas fa-inbox fa-3x mb-3" style="opacity: 0.3;"></i>
                        <p>{% trans "Aucune émission pour cette période" %}</p>
                    </div>
                {% endif %}
            </div>
            
            <!-- Moyennes -->
            <div style="background: white; border-radius: 16px; padding: 2rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
                <h3 style="margin: 0 0 1.5rem 0; font-size: 1.125rem; font-weight: 700; color: #0F172A; display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-calculator" style="color: #8B5CF6;"></i>
                    {% trans "Moyennes" %}
                </h3>
                
                <div style="display: grid; gap: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: #F8FAFC; border-radius: 8px;">
                        <span style="color: #64748B;">{% trans "Amende moyenne" %}</span>
                        <span style="font-weight: 700; color: #0F172A;">
                            {% if stats.emissions > 0 %}
                                {% widthratio stats.montant_emis 1 stats.emissions as avg_amende %}
                                {{ avg_amende|floatformat:0|intcomma }} FCFA
                            {% else %}
                                0 FCFA
                            {% endif %}
                        </span>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: #F8FAFC; border-radius: 8px;">
                        <span style="color: #64748B;">{% trans "Pesées par jour (moy.)" %}</span>
                        <span style="font-weight: 700; color: #0F172A;">
                            {% if date_fin != date_debut %}
                                ~{{ stats.nombre_pesees|divisibleby:7|default:"N/A" }}
                            {% else %}
                                {{ stats.nombre_pesees }}
                            {% endif %}
                        </span>
                    </div>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; background: #F8FAFC; border-radius: 8px;">
                        <span style="color: #64748B;">{% trans "Taux infraction HG" %}</span>
                        <span style="font-weight: 700; color: #F59E0B;">
                            {% if stats.emissions > 0 %}
                                {% widthratio stats.hors_gabarit stats.emissions 100 %}%
                            {% else %}
                                0%
                            {% endif %}
                        </span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ACTIONS -->
        <div style="background: white; border-radius: 16px; padding: 1.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);">
            <h3 style="margin: 0 0 1rem 0; font-size: 1rem; font-weight: 600; color: #64748B;">
                {% trans "Actions rapides" %}
            </h3>
            <div style="display: flex; flex-wrap: wrap; gap: 0.75rem;">
                <a href="{% url 'inventaire:liste_amendes' %}" 
                   style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1.25rem; background: linear-gradient(135deg, #3B82F6, #60A5FA); color: white; border-radius: 8px; text-decoration: none; font-weight: 500;">
                    <i class="fas fa-list"></i> {% trans "Voir les Amendes" %}
                </a>
                
                <a href="{% url 'inventaire:recettes_pesage' %}" 
                   style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1.25rem; background: linear-gradient(135deg, #10B981, #6EE7B7); color: white; border-radius: 8px; text-decoration: none; font-weight: 500;">
                    <i class="fas fa-coins"></i> {% trans "Recettes Pesage" %}
                </a>
                
                <a href="{% url 'inventaire:recherche_historique_vehicule' %}" 
                   style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1.25rem; background: linear-gradient(135deg, #8B5CF6, #A78BFA); color: white; border-radius: 8px; text-decoration: none; font-weight: 500;">
                    <i class="fas fa-search"></i> {% trans "Historique Véhicule" %}
                </a>
                
                {% if is_admin %}
                <a href="{% url 'inventaire:classement_stations_pesage_rendement' %}" 
                   style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1.25rem; background: linear-gradient(135deg, #F59E0B, #FCD34D); color: white; border-radius: 8px; text-decoration: none; font-weight: 500;">
                    <i class="fas fa-trophy"></i> {% trans "Classement Stations" %}
                </a>
                {% endif %}
                
                <a href="{% url 'common:dashboard' %}" 
                   style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.75rem 1.25rem; background: white; color: #64748B; border: 2px solid #E5E7EB; border-radius: 8px; text-decoration: none; font-weight: 500;">
                    <i class="fas fa-home"></i> {% trans "Dashboard" %}
                </a>
            </div>
        </div>
        
    </div>
</div>
{% endblock %}